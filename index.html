<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  
  <meta name="description" content="momoda">
  

  
  <meta name="keywords" content="momoda">
  
  
  
  
  
  
  
  
  
  <title>Just another blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="momoda">
<meta name="keywords" content="momoda">
<meta property="og:type" content="website">
<meta property="og:title" content="Just another blog">
<meta property="og:url" content="https://wnhby.github.io/index.html">
<meta property="og:site_name" content="Just another blog">
<meta property="og:description" content="momoda">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Just another blog">
<meta name="twitter:description" content="momoda">
  
    <link rel="alternative" href="/atom.xml" title="Just another blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/css/images/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  

  
  <!-- baidu webmaster push -->
  <script src="//push.zhanzhang.baidu.com/push.js"></script>
</head></html>
<body class="home blog custom-background custom-font-enabled single-author">
  <div id="page" class="hfeed site">
      <header id="masthead" class="site-header" role="banner">
    <hgroup>
      <h1 class="site-title">
        <a href="/" title="Just another blog" rel="home">Just another blog</a>
      </h1>
      
        <h2 class="site-description">
          <a href="/" id="subtitle">momoda blog</a>
        </h2>
      
    </hgroup>

    <nav id="site-navigation" class="main-navigation" role="navigation">
            <button class="menu-toggle">菜单</button>
            <a class="assistive-text" href="/#content" title="跳至内容">跳至内容</a><!--TODO-->
            <div class="menu-main-container">
                <ul id="menu-main" class="nav-menu">
                
                    <li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/">Home</a></li>
                
                    <li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/atom.xml">RSS</a></li>
                
                    <li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/sitemap.xml">Site map</a></li>
                
                    <li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/more/share.html">Share</a></li>
                
                </ul>
            </div>
    </nav>
</header>

      <div id="main" class="wrapper">
        <div id="primary" class="site-content"><div id="content" role="main">
  
    <article id="post-系统剩余空间查看" class="post-系统剩余空间查看 post type-post status-publish format-standard hentry">
    <!---->

      <header class="entry-header">
        
        
  
    <h1 class="entry-title">
      <a class="article-title" href="/系统剩余空间查看/">系统剩余空间查看</a>
    </h1>
  

        
        <div class="comments-link">
            
            <a href="javascript:void(0);" data-url="https://wnhby.github.io/系统剩余空间查看/" data-id="cjsbez049000kczs6fmzvghwg" class="leave-reply bdsharebuttonbox" data-cmd="more">分享</a>
        </div><!-- .comments-link -->
      </header><!-- .entry-header -->

    <div class="entry-content">
      
        <h2 id="code"><a href="#code" class="headerlink" title="code"></a>code</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"><span class="meta">#</span> 系统剩余磁盘空间查看等报告</span><br><span class="line">echo report date = `date`</span><br><span class="line">echo -e "\n"</span><br><span class="line"></span><br><span class="line">echo "MEM INFO:"</span><br><span class="line">echo mem total = `free -g |grep 'Mem' |awk '&#123;print $2&#125;'`G</span><br><span class="line">echo mem used = `free -g |grep 'Mem' |awk '&#123;print $3&#125;'`G</span><br><span class="line">echo -e "\n" </span><br><span class="line"></span><br><span class="line">echo "PROCESS INFO:"</span><br><span class="line">echo process num = `ps -elf |wc -l`</span><br><span class="line">echo zombie process num =`ps -elf |awk '&#123;print $2&#125;'|grep 'Z' |wc -l`</span><br><span class="line">echo -e "\n"</span><br><span class="line"></span><br><span class="line">echo "DISK SPACE INFO:"</span><br><span class="line">echo root_space_total = `df -h |grep '/dev/sda' |awk '&#123;print $2&#125;'`</span><br><span class="line">echo root_space_used = `df -h |grep '/dev/sda' |awk '&#123;print $3&#125;'`</span><br><span class="line">echo root_space_avliable = `df -h |grep '/dev/sda' |awk '&#123;print $4&#125;'`</span><br><span class="line">echo root_space_used_percent =  `df -h |grep '/dev/sda' |awk '&#123;print $5&#125;'`</span><br></pre></td></tr></table></figure>
<h2 id="result"><a href="#result" class="headerlink" title="result"></a>result</h2><div align="center"> <img src="/系统剩余空间查看/2019-01-10 17-45-58屏幕截图.png" width="400px"><br>图1. 系统剩余空间查看示例</div><br><br><br>—<br><br><em> <a href="/more/donate/index.html"><strong><em><font color="red">我觉得帮助到我了, 支持你一下.</font></em></strong></a><br>   

</em> <a href="https://www.paypal.me/momodainfo" target="_blank" rel="noopener"><strong><em><font color="red">If you think the article is helpful to you, you can reward me through paypal.</font></em></strong></a><br><br><br>### Ads<br><br><em>这是小广告! 如果有需要, 不妨支持一下吧~</em><br><br>&gt;  <a target="_blank" href="https://amazon.cn/gp/search?ie=UTF8&tag=momoda-23&linkCode=ur2&linkId=4a0e4fbec0cfa8dfe540ca999d0bf999&camp=536&creative=3200&index=books&keywords=编程">这些好书您看了吗?</a><img src="//ir-cn.amazon-adsystem.com/e/ir?t=momoda-23&l=ur2&o=28" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"><br><br>&gt; 体育&amp;户外用品推荐<br><div align="center"> <a href="https://www.amazon.cn/B07HWB88Z5/dp/B07HWB88Z5/ref=as_sl_pc_tf_til?tag=momoda-23&linkCode=w00&linkId=14df5124f2165d9eb3d65252e60ed2cf&creativeASIN=B07HWB88Z5" target="_blank" rel="noopener"><img src="/系统剩余空间查看/../more/ads/amazon.gif" width="100%"></a> </div>

      
    </div><!-- .entry-content -->

    <footer class="entry-meta">
    <a href="/系统剩余空间查看/">
    <time datetime="2019-01-10T08:11:51.000Z" class="entry-date">
        1月 10 2019
    </time>
</a>
    
  <span class="article-delim">&#8226;</span>
  <div class="article-category">
  <a class="article-category-link" href="/categories/Linux/">Linux</a>, <a class="article-category-link" href="/categories/Linux/Shell/">Shell</a>
  </div>

    
  <span class="article-delim">&#8226;</span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Shell/">Shell</a></li></ul>

    </footer>
</article>






  
    <article id="post-数据库分类" class="post-数据库分类 post type-post status-publish format-standard hentry">
    <!---->

      <header class="entry-header">
        
        
  
    <h1 class="entry-title">
      <a class="article-title" href="/数据库分类/">数据库分类</a>
    </h1>
  

        
        <div class="comments-link">
            
            <a href="javascript:void(0);" data-url="https://wnhby.github.io/数据库分类/" data-id="cjsbez040000eczs6sswwgyu7" class="leave-reply bdsharebuttonbox" data-cmd="more">分享</a>
        </div><!-- .comments-link -->
      </header><!-- .entry-header -->

    <div class="entry-content">
      
        <h2 id="数据库分类"><a href="#数据库分类" class="headerlink" title="数据库分类"></a>数据库分类</h2><div align="center"> <img src="/数据库分类/pics/database.png" width="100%"> </div>

<hr>
<ul>
<li><p><a href="/more/donate/index.html"><strong><em><font color="red">我觉得帮助到我了, 支持你一下.</font></em></strong></a><br>   </p>
</li>
<li><p><a href="https://www.paypal.me/momodainfo" target="_blank" rel="noopener"><strong><em><font color="red">If you think the article is helpful to you, you can reward me through paypal.</font></em></strong></a></p>
</li>
</ul>
<h3 id="Ads"><a href="#Ads" class="headerlink" title="Ads"></a>Ads</h3><p><em>这是小广告! 如果有需要, 不妨支持一下吧~</em></p>
<blockquote>
<p> <a target="_blank" href="https://amazon.cn/gp/search?ie=UTF8&tag=momoda-23&linkCode=ur2&linkId=4a0e4fbec0cfa8dfe540ca999d0bf999&camp=536&creative=3200&index=books&keywords=编程">这些好书您看了吗?</a><img src="//ir-cn.amazon-adsystem.com/e/ir?t=momoda-23&l=ur2&o=28" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p>
</blockquote>
<blockquote>
<p>体育&amp;户外用品推荐</p>
</blockquote>
<div align="center"> <a href="https://www.amazon.cn/B07HWB88Z5/dp/B07HWB88Z5/ref=as_sl_pc_tf_til?tag=momoda-23&linkCode=w00&linkId=14df5124f2165d9eb3d65252e60ed2cf&creativeASIN=B07HWB88Z5" target="_blank" rel="noopener"><img src="/数据库分类/../more/ads/amazon.gif" width="100%"></a> </div>

      
    </div><!-- .entry-content -->

    <footer class="entry-meta">
    <a href="/数据库分类/">
    <time datetime="2019-01-07T13:46:03.000Z" class="entry-date">
        1月 7 2019
    </time>
</a>
    
  <span class="article-delim">&#8226;</span>
  <div class="article-category">
  <a class="article-category-link" href="/categories/数据库/">数据库</a>
  </div>

    
  <span class="article-delim">&#8226;</span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/database/">database</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/数据库/">数据库</a></li></ul>

    </footer>
</article>






  
    <article id="post-se-notes/Java基础/集合框架" class="post-se-notes/Java基础/集合框架 post type-post status-publish format-standard hentry">
    <!---->

      <header class="entry-header">
        
        
  
    <h1 class="entry-title">
      <a class="article-title" href="/se-notes/Java基础/集合框架/">集合框架</a>
    </h1>
  

        
        <div class="comments-link">
            
            <a href="javascript:void(0);" data-url="https://wnhby.github.io/se-notes/Java基础/集合框架/" data-id="cjsbez0a7003uczs6a6ca0576" class="leave-reply bdsharebuttonbox" data-cmd="more">分享</a>
        </div><!-- .comments-link -->
      </header><!-- .entry-header -->

    <div class="entry-content">
      
        <!-- TOC -->
<ul>
<li><a href="#java集合框架">Java集合框架</a><ul>
<li><a href="#collection-接口">Collection 接口</a></li>
<li><a href="#规则集">规则集</a></li>
<li><a href="#比较器接口-comparator">比较器接口 Comparator</a></li>
<li><a href="#线性表">线性表</a></li>
<li><a href="#线性表与集合的静态方法">线性表与集合的静态方法</a></li>
<li><a href="#队列与优先队列">队列与优先队列</a></li>
<li><a href="#图">图</a></li>
<li><a href="#备注">备注</a><ul>
<li><a href="#ads">Ads</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h1 id="Java集合框架"><a href="#Java集合框架" class="headerlink" title="Java集合框架"></a>Java集合框架</h1><p>Java 集合框架是 Java 提供的几个能有效组织和操作数据的数据结构，支持两种类型的容器：<strong>集合</strong>与<strong>图</strong>。</p>
<p>Java 集合框架支持三种主要类型的集合：规则集(Set)、线性表(List)和队列(Queue)。Set 的实例用于存储一组不重复的元素，List 的实例用于存储一个由元素构成的有序集合，Queue 的实例用于存储先进先出方式处理的对象。</p>
<h2 id="Collection-接口"><a href="#Collection-接口" class="headerlink" title="Collection 接口"></a>Collection 接口</h2><p>Collection 接口是处理对象集合的根接口，提供了在集合中添加、删除元素与查询的基本操作。</p>
<p><img src="https://cloud.githubusercontent.com/assets/22606175/23050156/8bd84046-f4fb-11e6-87d2-19eec8ebe1a9.jpg" alt="1487298378 1"></p>
<p>AbstractCollection 类是提供 Collection 接口的部分实现的便利类。</p>
<h2 id="规则集"><a href="#规则集" class="headerlink" title="规则集"></a>规则集</h2><p>Set 接口扩展了 Collection 接口，并未引入新的方法或常量，只是规定 Set 的实例不包含重复的元素。以下介绍 Set 接口的三个具体类。</p>
<ul>
<li>散列集 HashSet：以一个不可预知的顺序存储元素。</li>
<li>链式散列集 LinkedHashSet：以元素被插入的顺序存储元素。</li>
<li>树形集 TreeSet：存储已按照元素之间的比较原则排好序的元素；可使用元素的 Comparable 接口或者指定一个比较器。</li>
</ul>
<p><img src="https://cloud.githubusercontent.com/assets/22606175/23050187/b0f06ca0-f4fb-11e6-9bbc-d7a555ad2247.jpg" alt="1487298438 1"></p>
<h2 id="比较器接口-Comparator"><a href="#比较器接口-Comparator" class="headerlink" title="比较器接口 Comparator"></a>比较器接口 Comparator</h2><p>有时希望将元素插入到一个树集合中，而这些元素可能不是 java.lang.Comparable 的实例，此时可定义一个比较器来比较这些元素。若如此做，则需创建一个实现 java.util.Comparator 接口的比较器类。Comparator 接口有两个方法：compare 与 equals 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Comparator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserComparator</span> <span class="keyword">implements</span> <span class="title">Comparator</span>&lt;<span class="title">User</span>&gt;,<span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(User u1, User u2)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(u1.age &gt; u2.age)</span><br><span class="line">	        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(u1.age == u2.age)</span><br><span class="line">	        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">	        <span class="keyword">return</span> -<span class="number">1</span>; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要想使用比较器，必须使用构造方法 TreeSet(Comparator comparator) 来创建一个有序集，它可使用比较器中的 compare 方法进行排序。</p>
<h2 id="线性表"><a href="#线性表" class="headerlink" title="线性表"></a>线性表</h2><p>线性表不仅可以存储重复的元素，而且允许用户指定它们存储的位置。</p>
<p><img src="https://cloud.githubusercontent.com/assets/22606175/23050131/60c443e6-f4fb-11e6-8ab7-b38b88be88f9.jpg" alt="1487298308 1"></p>
<ul>
<li>数组线性表类 ArrayList ：实现 List 接口的可变大小的数组。</li>
</ul>
<p><img src="https://cloud.githubusercontent.com/assets/22606175/23050472/760d6ef6-f4fd-11e6-850d-85b0b45f86aa.png" alt="image"></p>
<ul>
<li>链表类 LinkedList ：实现了 List 接口的一个链表。此外还额外提供了从线性表两端操作元素的方法。</li>
</ul>
<p><img src="https://cloud.githubusercontent.com/assets/22606175/23050484/8eb08772-f4fd-11e6-810a-a35985919977.jpg" alt="1487299246 1"></p>
<h2 id="线性表与集合的静态方法"><a href="#线性表与集合的静态方法" class="headerlink" title="线性表与集合的静态方法"></a>线性表与集合的静态方法</h2><p>由于线性表不支持有序存储，因此 Collections 类提供了对线性表排序以及其他操作的静态方法。</p>
<p><img src="https://cloud.githubusercontent.com/assets/22606175/23050534/e8646324-f4fd-11e6-8b83-8709dda04058.jpg" alt="1487299387 1"></p>
<h2 id="队列与优先队列"><a href="#队列与优先队列" class="headerlink" title="队列与优先队列"></a>队列与优先队列</h2><p>队列是一种先进先出的数据结构，元素被追加到队尾，然后从队列头删除。而在优先队列中，元素被赋予优先级，当访问元素时，拥有最高优先级的元素首先被删除。</p>
<p>java.util.Queue 接口用附加的插入、提取和检验操作来扩展 java.util.Collection 接口。由于 LinkedList 类实现了 Deque 接口，Deque 又扩展了 Queue 接口，因此可用 LinkedList 来创建一个队列。</p>
<p><img src="https://cloud.githubusercontent.com/assets/22606175/23050593/48d031ac-f4fe-11e6-83af-27cdc80d83ea.jpg" alt="1487299554 1"></p>
<p>java.util.PriorityQueue 类实现一个优先队列，默认情况下按照 Comparable 以元素的自然顺序来排序，也可以通过构造方法使用 Comparator 指定一个顺序。</p>
<p><img src="https://cloud.githubusercontent.com/assets/22606175/23050629/88dee25c-f4fe-11e6-8a3a-345d144b0fd6.jpg" alt="1487299667 1"></p>
<h2 id="图"><a href="#图" class="headerlink" title="图"></a>图</h2><p>图是一种按照键值存储元素的容器。图中不能有重复的键值，每个键值对应一个值。一个键值与它的对应值构成一个条目。</p>
<p>java.util.Map 接口提供了查询、更新和获取集合的值或键值的方法。</p>
<p><img src="https://cloud.githubusercontent.com/assets/22606175/23051214/39d9cd8a-f502-11e6-9adf-5bec2a1185d6.jpg" alt="1487301232 1"></p>
<ul>
<li>散列图 HashMap ：条目没有顺序。</li>
<li>链式散裂图 LinkedHashMap：条目可按照某种顺序来获取，既可以是插入顺序也可以是最后一次访问的顺序。</li>
<li>树形图 TreeMap ：条目按照 Comparable 或者指定比较器的顺序进行排序。</li>
</ul>
<p><img src="https://cloud.githubusercontent.com/assets/22606175/23051461/1f328c9a-f504-11e6-90fb-b1599f8fef12.jpg" alt="1487302061 1"></p>
<h2 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h2><ul>
<li>Java 集合框架中的所有实例类都实现了 Cloneable 和 Serializable 接口，因此它们的实例都是可复制和可序列化的。</li>
</ul>
<hr>
<ul>
<li><p><a href="/more/donate/index.html"><strong><em><font color="red">我觉得帮助到我了, 支持你一下.</font></em></strong></a><br>   </p>
</li>
<li><p><a href="https://www.paypal.me/momodainfo" target="_blank" rel="noopener"><strong><em><font color="red">If you think the article is helpful to you, you can reward me through paypal.</font></em></strong></a></p>
</li>
</ul>
<h3 id="Ads"><a href="#Ads" class="headerlink" title="Ads"></a>Ads</h3><p><em>这是小广告! 如果有需要, 不妨支持一下吧~</em></p>
<blockquote>
<p> <a target="_blank" href="https://amazon.cn/gp/search?ie=UTF8&tag=momoda-23&linkCode=ur2&linkId=4a0e4fbec0cfa8dfe540ca999d0bf999&camp=536&creative=3200&index=books&keywords=编程">这些好书您看了吗?</a><img src="//ir-cn.amazon-adsystem.com/e/ir?t=momoda-23&l=ur2&o=28" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p>
</blockquote>
<blockquote>
<p>体育&amp;户外用品推荐</p>
</blockquote>
<div align="center"> <a href="https://www.amazon.cn/B07HWB88Z5/dp/B07HWB88Z5/ref=as_sl_pc_tf_til?tag=momoda-23&linkCode=w00&linkId=14df5124f2165d9eb3d65252e60ed2cf&creativeASIN=B07HWB88Z5" target="_blank" rel="noopener"><img src="/se-notes/Java基础/集合框架/../../../more/ads/amazon.gif" width="100%"></a> </div>
      
    </div><!-- .entry-content -->

    <footer class="entry-meta">
    <a href="/se-notes/Java基础/集合框架/">
    <time datetime="2019-01-03T13:49:30.000Z" class="entry-date">
        1月 3 2019
    </time>
</a>
    
  <span class="article-delim">&#8226;</span>
  <div class="article-category">
  <a class="article-category-link" href="/categories/编程语言/">编程语言</a>, <a class="article-category-link" href="/categories/编程语言/java/">java</a>
  </div>

    
  <span class="article-delim">&#8226;</span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java基础/">java基础</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java语法/">java语法</a></li></ul>

    </footer>
</article>






  
    <article id="post-se-notes/云计算实践/集群高可用方案/Heartbeat双机热备方案" class="post-se-notes/云计算实践/集群高可用方案/Heartbeat双机热备方案 post type-post status-publish format-standard hentry">
    <!---->

      <header class="entry-header">
        
        
  
    <h1 class="entry-title">
      <a class="article-title" href="/se-notes/云计算实践/集群高可用方案/Heartbeat双机热备方案/">Heartbeat双机热备方案</a>
    </h1>
  

        
        <div class="comments-link">
            
            <a href="javascript:void(0);" data-url="https://wnhby.github.io/se-notes/云计算实践/集群高可用方案/Heartbeat双机热备方案/" data-id="cjsbez0fs00dnczs6qa2z160p" class="leave-reply bdsharebuttonbox" data-cmd="more">分享</a>
        </div><!-- .comments-link -->
      </header><!-- .entry-header -->

    <div class="entry-content">
      
        <!-- TOC -->
<ul>
<li><a href="#heartbeat-%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88centos">Heartbeat 部署方案（CentOS）</a><ul>
<li><a href="#%E5%AE%89%E8%A3%85">安装</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE">配置</a><ul>
<li><a href="#%E8%AE%A4%E8%AF%81%E6%96%87%E4%BB%B6etchadauthkeys">认证文件（/etc/ha.d/authkeys）</a></li>
<li><a href="#%E4%B8%BB%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6etchadhacf">主配置文件（/etc/ha.d/ha.cf）</a></li>
<li><a href="#%E8%B5%84%E6%BA%90%E6%96%87%E4%BB%B6etchadharesources">资源文件（/etc/ha.d/haresources）</a></li>
<li><a href="#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3">参考文档</a></li>
<li><a href="#ads">Ads</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h1 id="Heartbeat-部署方案（CentOS）"><a href="#Heartbeat-部署方案（CentOS）" class="headerlink" title="Heartbeat 部署方案（CentOS）"></a>Heartbeat 部署方案（CentOS）</h1><blockquote>
<p>注意：Heartbeat 方案本人还未有实践过</p>
</blockquote>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>两种安装方式：</p>
<ul>
<li>主从节点都使用<code>yum install heartbeat*</code>命令安装 Heartbeat（须确保已安装 epel 扩展软件包源）。</li>
<li>在 Linux-HA 官网下载 <a href="http://www.linux-ha.org/wiki/Downloads" target="_blank" rel="noopener">Heartbeat</a>。</li>
</ul>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>Heartbeat 主要的配置文件有 3 个，分别是 <strong>authkeys</strong>，<strong>ha.cf</strong> 和 <strong>haresources</strong>。其中 ha.cf 是主配置文件，haresource 用来配置要让 Heartbeat 托管的服务，authkey 是用来指定 Heartbeat 的认证方式。</p>
<blockquote>
<p>在 Heartbeat 安装后，默认并没有这三个文件，可以直接从解压的源码目录中找到。</p>
</blockquote>
<p>这里以 master/slave 两节点为例，示例的配置文件为 master 节点的。</p>
<h3 id="认证文件（-etc-ha-d-authkeys）"><a href="#认证文件（-etc-ha-d-authkeys）" class="headerlink" title="认证文件（/etc/ha.d/authkeys）"></a>认证文件（/etc/ha.d/authkeys）</h3><p>该文件为 Heartbeat 的认证文件，该文件主要是用于集群中两个节点的认证，采用的算法和密钥（如果有的话）在集群中节点上必须相同。目前提供了 3 种算法：crc/md5/sha1。其中 crc 不能够提供认证，它只能够用于校验数据包是否损坏，而 sha1/md5 需要一个密钥来进行认证。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">auth 2</span><br><span class="line">#1 crc</span><br><span class="line">2 sha1 somewords</span><br><span class="line">#3 md5 somewords</span><br></pre></td></tr></table></figure>
<p>以上示例中使用的是 sha1 算法，如果要换用其他算法只需要修改 auth 指令后面的数字，然后取消相应行的注释即可。</p>
<blockquote>
<p>注意：该文件的属性必须为600，否则 Heartbeat 启动将失败。且两个节点的 authkeys 文件内容及权限相同。</p>
</blockquote>
<h3 id="主配置文件（-etc-ha-d-ha-cf）"><a href="#主配置文件（-etc-ha-d-ha-cf）" class="headerlink" title="主配置文件（/etc/ha.d/ha.cf）"></a>主配置文件（/etc/ha.d/ha.cf）</h3><p>该文件是 Heartbeat 的主配置文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">keepalive 2</span><br><span class="line">warntime 5</span><br><span class="line">deadtime 30</span><br><span class="line">initdead 120</span><br><span class="line">udpport 6942</span><br><span class="line">bcast eth0</span><br><span class="line"># mcast eth0 225.0.0.1 694 1 0</span><br><span class="line">ucast eth1 &#123;&#123; slave的IP地址 &#125;&#125;</span><br><span class="line">auto_failback off</span><br><span class="line">watchdog /dev/watchdog</span><br><span class="line">node host41 host42</span><br><span class="line"># ping 172.16.12.1 ping_group group1 172.16.12.1</span><br><span class="line">respawn hacluster /usr/lib64/heartbeat/ipfail</span><br><span class="line">respawn hacluster /usr/lib64/heartbeat/dopd</span><br><span class="line">apiauth dopd gid=haclient uid=hacluster</span><br><span class="line">use_logd yes</span><br></pre></td></tr></table></figure>
<ul>
<li>keepalive：发送心跳报文的间隔。默认单位为秒，也可以使用 500ms 来指代 500 毫秒，等同于 0.5。</li>
<li>warntime：认为对方可能宕掉的间隔时间。</li>
<li>deadtime：认为对方宕掉的间隔时间，超过这个时间，则认为对方已经宕掉。</li>
<li>initdead：等待对方启动的最大时间。</li>
<li>udpport：heartbeat 广播/单播通讯使用的 udp 端口。</li>
<li>bcast：心跳所使用的网络接口。</li>
<li>ucast：单播通讯，对方网络接口及IP地址。</li>
<li>mcast：组播通讯，参数如右：通讯所用的接口 绑定的组播IP（224.0.0.0-239.255.255.255）通讯端口 ttl 是否允许环回。</li>
<li>auto_failback：表示当主节点（即提供资源/服务的节点）正常之后是否将资源/服务切换回来。</li>
<li>watchdog：看门狗定时器，如果节点一分钟内没有心跳，则重启节点。</li>
<li>node：heartbeat 集群中的节点信息（节点的主机名: uname -n）。</li>
<li>ping/ping_group：用于建立伪集群成员，作用是监测物理链路，如果该节点与伪集群成员不相通，那么该节点无权接管资源/服务。</li>
</ul>
<p>另一从节点（slave）需要将 ha.cf 文件中 ucast 的 IP 地址改为主节点（master）的 IP 地址。</p>
<h3 id="资源文件（-etc-ha-d-haresources）"><a href="#资源文件（-etc-ha-d-haresources）" class="headerlink" title="资源文件（/etc/ha.d/haresources）"></a>资源文件（/etc/ha.d/haresources）</h3><p>haresources 文件用于指定双机系统的主节点、集群IP、子网掩码、广播地址以及启动的服务等集群资源。文件每一行可以包含一个或多个资源脚本名，资源之间使用空格隔开，参数之间使用两个冒号隔开。在两个节点上该文件必须完全一致，此文件的一般格式为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node-name network &lt;resource-group&gt;</span><br></pre></td></tr></table></figure></p>
<p>node-name 表示主节点的主机名，必须和 ha.cf 文件中指定的节点名一致；network 用于设定集群的 IP 地址、子网掩码、网络设备标识等（这里指定的IP地址就是集群对外服务的IP地址），resource-group 用来指定需要 Heartbeat 托管的服务，也就是这些服务可以由 Heartbeat 来启动和关闭，如果要托管这些服务，必须将服务写成可以通过 start/stop 来启动和关闭的脚本，然后放到 /etc/init.d/ 或者 /etc/ha.d/resource.d/ 目录下，heartbeat 会根据脚本的名称自动去 /etc/init.d 或者 /etc/ha.d/resource.d/ 目录下找到相应脚本进行启动或关闭操作。</p>
<p>以下是一个具体实例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node1 IPaddr::192.168.60.200/24/eth0/  Filesystem::/dev/sdb5::/webdata::ext3  httpd tomcat</span><br></pre></td></tr></table></figure></p>
<p>其中，node1 是 HA 集群的主节点，IPaddr 为 HeartbeatH自带的一个执行脚本，Heartbeat 首先将执行<code>/etc/ha.d/resource.d/IPaddr 192.168.60.200/24 start</code>的操作，也就是虚拟出一个子网掩码为 255.255.255.0，IP为 192.168.60.200 的地址，此IP为 Heartbeat 对外提供服务的网络地址，同时指定此 IP 使用的网络接口为 eth0，接着，Heartbeat 将执行共享磁盘分区的挂载操作，<code>Filesystem::/dev/sdb5::/webdata::ext3</code>相当于在命令行下执行 mount 操作，即“mount –t ext3 /dev/sdb5 /webdata”，最后依次启动 httpd 和 tomcat 服务。</p>
<blockquote>
<p>注意：主节点和从节点中资源文件 haresources 一般要完全一致。</p>
</blockquote>
<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><p><a href="http://ixdba.blog.51cto.com/2895551/548625" target="_blank" rel="noopener">Linux-HA开源软件Heartbeat（配置篇）</a><br><a href="https://github.com/chenzhiwei/linux/tree/master/heartbeat" target="_blank" rel="noopener">heartbeat配置相关</a></p>
<hr>
<ul>
<li><p><a href="/more/donate/index.html"><strong><em><font color="red">我觉得帮助到我了, 支持你一下.</font></em></strong></a><br>   </p>
</li>
<li><p><a href="https://www.paypal.me/momodainfo" target="_blank" rel="noopener"><strong><em><font color="red">If you think the article is helpful to you, you can reward me through paypal.</font></em></strong></a></p>
</li>
</ul>
<h3 id="Ads"><a href="#Ads" class="headerlink" title="Ads"></a>Ads</h3><p><em>这是小广告! 如果有需要, 不妨支持一下吧~</em></p>
<blockquote>
<p> <a target="_blank" href="https://amazon.cn/gp/search?ie=UTF8&tag=momoda-23&linkCode=ur2&linkId=4a0e4fbec0cfa8dfe540ca999d0bf999&camp=536&creative=3200&index=books&keywords=编程">这些好书您看了吗?</a><img src="//ir-cn.amazon-adsystem.com/e/ir?t=momoda-23&l=ur2&o=28" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p>
</blockquote>
<blockquote>
<p>体育&amp;户外用品推荐</p>
</blockquote>
<div align="center"> <a href="https://www.amazon.cn/B07HWB88Z5/dp/B07HWB88Z5/ref=as_sl_pc_tf_til?tag=momoda-23&linkCode=w00&linkId=14df5124f2165d9eb3d65252e60ed2cf&creativeASIN=B07HWB88Z5" target="_blank" rel="noopener"><img src="/se-notes/云计算实践/集群高可用方案/Heartbeat双机热备方案/../../../../more/ads/amazon.gif" width="100%"></a> </div>
      
    </div><!-- .entry-content -->

    <footer class="entry-meta">
    <a href="/se-notes/云计算实践/集群高可用方案/Heartbeat双机热备方案/">
    <time datetime="2019-01-03T13:49:30.000Z" class="entry-date">
        1月 3 2019
    </time>
</a>
    
  <span class="article-delim">&#8226;</span>
  <div class="article-category">
  <a class="article-category-link" href="/categories/通用技术/">通用技术</a>, <a class="article-category-link" href="/categories/通用技术/云计算实践/">云计算实践</a>, <a class="article-category-link" href="/categories/通用技术/云计算实践/集群高可用方案/">集群高可用方案</a>
  </div>

    
  <span class="article-delim">&#8226;</span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/云计算/">云计算</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/集群/">集群</a></li></ul>

    </footer>
</article>






  
    <article id="post-se-notes/云计算实践/集群高可用方案/HAProxy+Keepalived高可用方案" class="post-se-notes/云计算实践/集群高可用方案/HAProxy+Keepalived高可用方案 post type-post status-publish format-standard hentry">
    <!---->

      <header class="entry-header">
        
        
  
    <h1 class="entry-title">
      <a class="article-title" href="/se-notes/云计算实践/集群高可用方案/HAProxy+Keepalived高可用方案/">HAProxy+Keepalived高可用方案</a>
    </h1>
  

        
        <div class="comments-link">
            
            <a href="javascript:void(0);" data-url="https://wnhby.github.io/se-notes/云计算实践/集群高可用方案/HAProxy+Keepalived高可用方案/" data-id="cjsbez0fp00djczs63mrbi5a1" class="leave-reply bdsharebuttonbox" data-cmd="more">分享</a>
        </div><!-- .comments-link -->
      </header><!-- .entry-header -->

    <div class="entry-content">
      
        <!-- TOC -->
<ul>
<li><a href="#%E6%8A%80%E6%9C%AF%E7%AE%80%E4%BB%8B">技术简介</a><ul>
<li><a href="#haproxy">HAProxy</a></li>
<li><a href="#keepalived">Keepalived</a></li>
</ul>
</li>
<li><a href="#haproxy--keepalived-%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88">HAProxy + Keepalived 部署方案</a><ul>
<li><a href="#%E5%89%8D%E7%AB%AF%E9%85%8D%E7%BD%AE">前端配置</a><ul>
<li><a href="#%E5%89%8D%E7%AB%AF%E9%85%8D%E7%BD%AE-keepalived">前端配置 keepalived</a></li>
<li><a href="#%E5%89%8D%E7%AB%AF%E9%85%8D%E7%BD%AE-haproxy">前端配置 HAProxy</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3">参考文档</a><ul>
<li><a href="#ads">Ads</a></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h1 id="技术简介"><a href="#技术简介" class="headerlink" title="技术简介"></a>技术简介</h1><h3 id="HAProxy"><a href="#HAProxy" class="headerlink" title="HAProxy"></a>HAProxy</h3><p>HAProxy（High Available Proxy）是一款提供高可用性、负载均衡以及基于 TCP（第四层）和 HTTP（第七层）应用的代理软件。 HAProxy 配置简单、支持多达上万并发连接。其运行模型可使得它非常容易和无风险地集成到现有的架构中，并且同时可以保护 web 服务器不被暴露到网络上。</p>
<h3 id="Keepalived"><a href="#Keepalived" class="headerlink" title="Keepalived"></a>Keepalived</h3><p>Keepalived 是一款高可用软件，它的功能是基于 VRRP 协议，通过 IP 漂移实现服务的高可用：服务器集群共享一个虚拟 IP，同一时间只有一个服务器占有虚拟 IP 并对外提供服务。若该服务器不可用，则虚拟 IP 漂移至另一台服务器并对外提供服务。</p>
<p>Keepalived 可以单独使用，即通过 IP 漂移实现服务的高可用，也可以结合 LVS 使用（即一方面通过 IP 漂移实现 LVS 负载均衡层的高可用，另一方面实现 LVS 应用服务层的状态监控）。</p>
<h1 id="HAProxy-Keepalived-部署方案"><a href="#HAProxy-Keepalived-部署方案" class="headerlink" title="HAProxy + Keepalived 部署方案"></a>HAProxy + Keepalived 部署方案</h1><p>准备四台虚机，分别记作 HA-master、HA-slave、web-node1、web-node2。前两者作为 HA 负载均衡调度器（即前端），后两者是提供应用服务的 web 服务器（即后端）。</p>
<h2 id="前端配置"><a href="#前端配置" class="headerlink" title="前端配置"></a>前端配置</h2><h3 id="前端配置-keepalived"><a href="#前端配置-keepalived" class="headerlink" title="前端配置 keepalived"></a>前端配置 keepalived</h3><p>HA-master 与 HA-slave 都需安装 keepalived 服务：<code>yum -y install keepalived</code>，keepalived 的配置文件路径为<code>/etc/keepalived/keepalived.conf</code>。</p>
<p>配置 HA-master 的 keepalived：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">   router_id HA_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;        #主从实例1</span><br><span class="line">    state MASTER            #HA-master（172.18.216.115）为主，</span><br><span class="line">                            #HA-slave（172.18.216.79）为备</span><br><span class="line">                            #在HA-slave上，该处设置为BACKUP</span><br><span class="line">    interface ens192        #与实际网卡的名称必须保持一致</span><br><span class="line">    virtual_router_id 88    #实例1的VRID为88</span><br><span class="line">    garp_master_delay 1     #在切换到master状态后，延迟进行gratuitous ARP请求</span><br><span class="line">    priority 100            #HA-master的优先级为100，HA-slave的优先级为99</span><br><span class="line">                            #在HA-slave上，该选项设置为99</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.18.216.194       #实例1的虚拟IP</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来再配置 HA-slave 的 keepalived 配置文件。HA-slave 与 HA-master 的配置文件除了<code>state</code>项与<code>priority</code>项不同以外，其他项完全相同。</p>
<p>配置完成后，在两台虚机上都用<code>service keepalived start</code>命令启动 keepalive 服务。之后在 HA-master 上使用<code>ip addr show</code>命令可以看到当前节点已经绑定了虚拟 IP。且可以通过关闭 HA-master 上的 keepalive 服务来查看虚拟 IP 是否浮动到了 HA-slave。</p>
<blockquote>
<p>但目前 haproxy 服务停止时，keepalived 服务并不会停止，所以还需要写一个脚本，使得当 haproxy 服务停止时，keepalived 服务也会停止</p>
</blockquote>
<h3 id="前端配置-HAProxy"><a href="#前端配置-HAProxy" class="headerlink" title="前端配置 HAProxy"></a>前端配置 HAProxy</h3><p>在 HA-master 与 HA-slave 上安装 HAProxy：<code>yum install haproxy</code>，然后配置 HAProxy（路径<code>/etc/haproxy/haproxy.cfg</code>）。</p>
<p>HAProxy 的配置文件分为五个部分：</p>
<ul>
<li>global：全局配置的进程级参数，用来控制 Haproxy 启动前的一些进程及系统设置</li>
<li>defaults：配置默认参数，可以被 frontend，backend，listen 段继承使用</li>
<li>frontend：定义接收请求的前端虚拟节点，可根据用户所请求的不同域名、URL 等做不同的请求处理</li>
<li>backend：定义处理业务的后端服务器集群，以及设置后端的权重、队列、连接数等选项</li>
<li>listen：frontend 和 backend 的组合体</li>
</ul>
<blockquote>
<p>对配置参数的更详细说明请查阅文末的参考文档。</p>
</blockquote>
<p>以下是 HA-master 与 HA-slave 上的配置示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">    log         127.0.0.1 local2      # 定义日志输出设置</span><br><span class="line">    chroot      /var/lib/haproxy      # chroot运行路径</span><br><span class="line">    pidfile     /var/run/haproxy.pid  # haproxy进程PID文件</span><br><span class="line">    maxconn     20000                  # 默认最大连接数</span><br><span class="line">    daemon                            # 以后台形式运行harpoxy</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># common defaults that all the &apos;listen&apos; and &apos;backend&apos; sections will</span><br><span class="line"># use if not designated in their block</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line">defaults</span><br><span class="line">    mode                    http         # 所处理的类别(7层代理http，4层代理tcp)</span><br><span class="line">    log                     global       # 引入global定义的日志格式</span><br><span class="line">    option                  httplog      # 日志类别为http日志格式</span><br><span class="line">    option                  dontlognull  </span><br><span class="line">    option http-server-close    # 当客户端超时时，允许服务器关闭连接</span><br><span class="line">    option forwardfor       except 127.0.0.0/8    # 在响应头部加入forwardfor</span><br><span class="line">    option                  redispatch    # 在使用了基于cookie的会话保持的时候，通常需要</span><br><span class="line">                                          # 加这么一项，一旦后端某一server宕机时，能够将</span><br><span class="line">                                          # 其会话重新派发到其它的servers</span><br><span class="line">    retries                 3             # 3次连接失败就认为服务器不可用</span><br><span class="line">    timeout http-request    10s           </span><br><span class="line">    timeout queue           1m            </span><br><span class="line">    timeout connect         10s           </span><br><span class="line">    timeout client          1m            </span><br><span class="line">    timeout server          1m</span><br><span class="line">    timeout http-keep-alive 10s           # 默认持久连接超时时间</span><br><span class="line">    timeout check           10s           # 心跳检查超时时间</span><br><span class="line">    maxconn                 5000          # 最大并发连接数</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># main frontend which proxys to the backends</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line">frontend  proxy *:80    #前端代理</span><br><span class="line">    default_backend             dynamic</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># round robin balancing between the various backends</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line">backend dynamic    #后端动态服务器</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    cookie      SESSION_ID insert indirect nocache    #设置cookie保持</span><br><span class="line">    server      web1  172.18.218.149:80 inter 3000 rise 2 fall 3 check maxconn 5000 cookie A</span><br><span class="line">    server      web2  172.18.216.107:80 inter 3000 rise 2 fall 3 check maxconn 5000 cookie B</span><br><span class="line">listen statistics  #设置HAProxy 的自带管理系统</span><br><span class="line">        mode http</span><br><span class="line">        bind *:8080    #把stats页面绑定到8080端口</span><br><span class="line">        stats enable   #开启stats功能</span><br><span class="line">        stats auth admin:admin    #认证的用户名和密码</span><br><span class="line">        stats uri /admin?stats    #指定uri访问路径</span><br><span class="line">        stats hide-version        #为了安全（版本bug），隐藏版本信息</span><br><span class="line">        stats refresh 5s          #页面5秒刷新一次</span><br></pre></td></tr></table></figure></p>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a href="http://nmshuishui.blog.51cto.com/1850554/1405486" target="_blank" rel="noopener">keepalived+haproxy双主高可用负载均衡</a><br><a href="http://www.ttlsa.com/linux/haproxy-study-tutorial/" target="_blank" rel="noopener">HAProxy用法详解 全网最详细中文文档</a><br><a href="http://leejia.blog.51cto.com/4356849/1421882" target="_blank" rel="noopener">haproxy配置详解</a><br><a href="http://blief.blog.51cto.com/6170059/1750952" target="_blank" rel="noopener">HAproxy指南之haproxy配置详解</a></p>
<hr>
<ul>
<li><p><a href="/more/donate/index.html"><strong><em><font color="red">我觉得帮助到我了, 支持你一下.</font></em></strong></a><br>   </p>
</li>
<li><p><a href="https://www.paypal.me/momodainfo" target="_blank" rel="noopener"><strong><em><font color="red">If you think the article is helpful to you, you can reward me through paypal.</font></em></strong></a></p>
</li>
</ul>
<h3 id="Ads"><a href="#Ads" class="headerlink" title="Ads"></a>Ads</h3><p><em>这是小广告! 如果有需要, 不妨支持一下吧~</em></p>
<blockquote>
<p> <a target="_blank" href="https://amazon.cn/gp/search?ie=UTF8&tag=momoda-23&linkCode=ur2&linkId=4a0e4fbec0cfa8dfe540ca999d0bf999&camp=536&creative=3200&index=books&keywords=编程">这些好书您看了吗?</a><img src="//ir-cn.amazon-adsystem.com/e/ir?t=momoda-23&l=ur2&o=28" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p>
</blockquote>
<blockquote>
<p>体育&amp;户外用品推荐</p>
</blockquote>
<div align="center"> <a href="https://www.amazon.cn/B07HWB88Z5/dp/B07HWB88Z5/ref=as_sl_pc_tf_til?tag=momoda-23&linkCode=w00&linkId=14df5124f2165d9eb3d65252e60ed2cf&creativeASIN=B07HWB88Z5" target="_blank" rel="noopener"><img src="/se-notes/云计算实践/集群高可用方案/HAProxy+Keepalived高可用方案/../../../../more/ads/amazon.gif" width="100%"></a> </div>
      
    </div><!-- .entry-content -->

    <footer class="entry-meta">
    <a href="/se-notes/云计算实践/集群高可用方案/HAProxy+Keepalived高可用方案/">
    <time datetime="2019-01-03T13:49:30.000Z" class="entry-date">
        1月 3 2019
    </time>
</a>
    
  <span class="article-delim">&#8226;</span>
  <div class="article-category">
  <a class="article-category-link" href="/categories/通用技术/">通用技术</a>, <a class="article-category-link" href="/categories/通用技术/云计算实践/">云计算实践</a>, <a class="article-category-link" href="/categories/通用技术/云计算实践/集群高可用方案/">集群高可用方案</a>
  </div>

    
  <span class="article-delim">&#8226;</span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/云计算/">云计算</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/集群/">集群</a></li></ul>

    </footer>
</article>






  
    <article id="post-se-notes/云计算实践/区块链相关/区块链简介" class="post-se-notes/云计算实践/区块链相关/区块链简介 post type-post status-publish format-standard hentry">
    <!---->

      <header class="entry-header">
        
        
  
    <h1 class="entry-title">
      <a class="article-title" href="/se-notes/云计算实践/区块链相关/区块链简介/">区块链简介</a>
    </h1>
  

        
        <div class="comments-link">
            
            <a href="javascript:void(0);" data-url="https://wnhby.github.io/se-notes/云计算实践/区块链相关/区块链简介/" data-id="cjsbez0fm00dhczs6mlqodk61" class="leave-reply bdsharebuttonbox" data-cmd="more">分享</a>
        </div><!-- .comments-link -->
      </header><!-- .entry-header -->

    <div class="entry-content">
      
        <!-- TOC -->
<ul>
<li><a href="#区块链简介">区块链简介</a></li>
<li><a href="#应用领域">应用领域</a><ul>
<li><a href="#基于区块链的征信系统与数据中心比较">基于区块链的征信系统（与数据中心比较）</a><ul>
<li><a href="#ads">Ads</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h1 id="区块链简介"><a href="#区块链简介" class="headerlink" title="区块链简介"></a>区块链简介</h1><p>区块链技术是金融科技（FinTech）领域的一项重要技术创新。作为去中心化记账（Decentralized Ledger Technology，DLT）平台的核心技术，区块链被认为在金融、征信、物联网、经济贸易结算、资产管理等众多领域都拥有广泛的应用前景。</p>
<p>把区块链想象成一个公共账本，这个账本：</p>
<ol>
<li>存放在区块链系统的各个节点上，每个节点都有一份完整的备份。</li>
<li>每个节点的账本都记录着自区块链系统建立以来的所有交易。</li>
<li>账本被分为若干个区块进行存储，每个区块包含一部分交易记录。每一个区块都会记录着前一区块的 id，形成一个链状结构，因而称为区块链。</li>
<li>当发起一笔交易时，只需把交易信息广播到系统的 p2p 网络中，其他节点把该笔交易信息记录成一个新的区块连到区块链上，交易即可完成。</li>
</ol>
<p>区块链的重要特性（DACT）：</p>
<ul>
<li>Distributed（分布式的）：区块链系统中有多个独立节点，所有节点都共享同一份数据。</li>
<li>Autonomous（自治的）：所有操作都由系统自动完成而不需要一个中心机构进行管理。</li>
<li>Contractual（按照合约执行的）：数据是公开的不代表所有人可以随意访问区块链系统上的数据，系统有着最严格的权限设置。在系统约定一个共同合约后，只有确定权限的用户才可以访问加密的数据。</li>
<li>Trackable（可追溯的）：区块链系统中所有交易都是可追溯的，添加交易信息需要得到系统的共识，因而数据不可篡改。</li>
</ul>
<blockquote>
<p>区块链的意义在于：构建了更加可靠、值得信任的互联网，从根本上解决了价值转移和交换过程中出现的存在的欺诈与寻租现象。</p>
</blockquote>
<h1 id="应用领域"><a href="#应用领域" class="headerlink" title="应用领域"></a>应用领域</h1><h2 id="基于区块链的征信系统（与数据中心比较）"><a href="#基于区块链的征信系统（与数据中心比较）" class="headerlink" title="基于区块链的征信系统（与数据中心比较）"></a>基于区块链的征信系统（与数据中心比较）</h2><p>征信：为防止在非即付经济交往中的交易双方收到损失而进行的一种信用评估。征信所提供的服务，就是向交易双方提供对方的背景和信用信息，解决交易信任的问题。</p>
<p>在一个征信体系中，对金融机构有价值的客户可划分为优质客户（白名单）、中间客户、风险客户（黑名单）。白名单是主要服务对象，因为其意味着收益；而对黑名单则需要进行风险控制。但目前传统意义上的金融征信系统普遍存在局限性：</p>
<ul>
<li>目前大部分信用数据是一个个独立的信息孤岛（比如央行征信系统的数据），彼此并不联通。而完全开放征信系统数据又可能会造成虚假数据上传、金融机构核心业务信息被泄露等问题。</li>
<li>即使是对于传统意义上的征信共享，多个机构共享的结果是把每个机构的数据汇总到一个庞大的数据中心系统，参与机构都在该系统上查询。但也会有问题：<ul>
<li>系统是中心化的，一旦中心遭到攻击、篡改、上传虚假数据就会影响到所有数据的可靠性；同时也会出现人工误操作的情况。</li>
<li>数据汇总与更新速度不可控，难以及时进行征信数据同步</li>
<li>数据访问权限以及数据交换、共享问题：难以实现权限控制以及两个机构之间的私密数据有偿交换</li>
<li>由于数据中心共享的透明性，有些机构会故意保留己方的核心业务数据以防泄露</li>
<li>若要保证查询速度，则需要构建复杂的冗余系统；否则的话只有一个中心处理所有的请求，则系统速度可能会慢到不可用的程度</li>
</ul>
</li>
</ul>
<p>而区块链技术是最适合用于解决征信问题的解决方案：</p>
<ul>
<li>把中心化的存储转化为去中心化的分布式存储，变统一中心节点查询为 p2p 查询，提高安全性与性能</li>
<li>每个节点的数据完全同步</li>
<li>数据无法被篡改，即使有虚假数据也可以迅速追溯到源头</li>
<li>利用智能合约设置数据汇总与更新规则</li>
<li>通过智能合约进行权限控制，拥有对应的访问权限才可访问对应的数据</li>
</ul>
<hr>
<ul>
<li><p><a href="/more/donate/index.html"><strong><em><font color="red">我觉得帮助到我了, 支持你一下.</font></em></strong></a><br>   </p>
</li>
<li><p><a href="https://www.paypal.me/momodainfo" target="_blank" rel="noopener"><strong><em><font color="red">If you think the article is helpful to you, you can reward me through paypal.</font></em></strong></a></p>
</li>
</ul>
<h3 id="Ads"><a href="#Ads" class="headerlink" title="Ads"></a>Ads</h3><p><em>这是小广告! 如果有需要, 不妨支持一下吧~</em></p>
<blockquote>
<p> <a target="_blank" href="https://amazon.cn/gp/search?ie=UTF8&tag=momoda-23&linkCode=ur2&linkId=4a0e4fbec0cfa8dfe540ca999d0bf999&camp=536&creative=3200&index=books&keywords=编程">这些好书您看了吗?</a><img src="//ir-cn.amazon-adsystem.com/e/ir?t=momoda-23&l=ur2&o=28" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p>
</blockquote>
<blockquote>
<p>体育&amp;户外用品推荐</p>
</blockquote>
<div align="center"> <a href="https://www.amazon.cn/B07HWB88Z5/dp/B07HWB88Z5/ref=as_sl_pc_tf_til?tag=momoda-23&linkCode=w00&linkId=14df5124f2165d9eb3d65252e60ed2cf&creativeASIN=B07HWB88Z5" target="_blank" rel="noopener"><img src="/se-notes/云计算实践/区块链相关/区块链简介/../../../../more/ads/amazon.gif" width="100%"></a> </div>
      
    </div><!-- .entry-content -->

    <footer class="entry-meta">
    <a href="/se-notes/云计算实践/区块链相关/区块链简介/">
    <time datetime="2019-01-03T13:49:30.000Z" class="entry-date">
        1月 3 2019
    </time>
</a>
    
  <span class="article-delim">&#8226;</span>
  <div class="article-category">
  <a class="article-category-link" href="/categories/通用技术/">通用技术</a>, <a class="article-category-link" href="/categories/通用技术/云计算实践/">云计算实践</a>, <a class="article-category-link" href="/categories/通用技术/云计算实践/区块链/">区块链</a>
  </div>

    
  <span class="article-delim">&#8226;</span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/云计算/">云计算</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/区块链/">区块链</a></li></ul>

    </footer>
</article>






  
    <article id="post-se-notes/云计算实践/Kubernetes部署/kubeadm部署多节点集群" class="post-se-notes/云计算实践/Kubernetes部署/kubeadm部署多节点集群 post type-post status-publish format-standard hentry">
    <!---->

      <header class="entry-header">
        
        
  
    <h1 class="entry-title">
      <a class="article-title" href="/se-notes/云计算实践/Kubernetes部署/kubeadm部署多节点集群/">kubeadm部署多节点集群</a>
    </h1>
  

        
        <div class="comments-link">
            
            <a href="javascript:void(0);" data-url="https://wnhby.github.io/se-notes/云计算实践/Kubernetes部署/kubeadm部署多节点集群/" data-id="cjsbez0fj00ddczs6a2nf0hds" class="leave-reply bdsharebuttonbox" data-cmd="more">分享</a>
        </div><!-- .comments-link -->
      </header><!-- .entry-header -->

    <div class="entry-content">
      
        <!-- TOC -->
<ul>
<li><a href="#kubeadm-%E9%83%A8%E7%BD%B2%E5%A4%9A%E8%8A%82%E7%82%B9-k8s-%E9%9B%86%E7%BE%A4%E6%95%99%E7%A8%8B191">kubeadm 部署多节点 k8s 集群教程（1.9.1）</a><ul>
<li><a href="#%E4%B8%80-%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6">一. 前提条件</a></li>
<li><a href="#%E4%BA%8C-%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96%E7%8E%AF%E5%A2%83">二. 安装依赖环境</a><ul>
<li><a href="#%E5%AE%89%E8%A3%85-docker">安装 Docker</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#k8sconf%E6%98%AFk8s%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">k8s.conf是k8s的配置文件</a></li>
<li><a href="#dashboard-service">——————- Dashboard Service ——————-</a><ul>
<li><a href="#kubectl-delete--f-kubernetes-dashboardyaml">$ kubectl delete -f kubernetes-dashboard.yaml</a></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h1 id="kubeadm-部署多节点-k8s-集群教程（1-9-1）"><a href="#kubeadm-部署多节点-k8s-集群教程（1-9-1）" class="headerlink" title="kubeadm 部署多节点 k8s 集群教程（1.9.1）"></a>kubeadm 部署多节点 k8s 集群教程（1.9.1）</h1><p>kubeadm 是一个用于快速创建与扩展 k8s 集群的工具包。本教程主要讲述如何使用 kubeadm 构建一个双节点的 k8s 集群（版本为 1.9.1），构建集群中的 pod 通信网络，最后安装可视化的管理控制台。</p>
<p>本教程的集群节点均是由同一台 PC 所虚拟出来的两台虚机。</p>
<h2 id="一-前提条件"><a href="#一-前提条件" class="headerlink" title="一. 前提条件"></a>一. 前提条件</h2><p>配置要求如下：</p>
<ul>
<li>两台安装有 CentOS 7 操作系统的机器（命名为 kube-1 与 kube-2）</li>
<li>每台机器拥有 2G 以上内存以及 2核 以上处理器</li>
<li>每台机器关闭防火墙与 SELinux</li>
<li>每台机器彼此之间都可以通过网络联通</li>
<li>拥有一个可以“科学上网”的 ShadowSocksS 服务器</li>
</ul>
<p>禁用 swap，以保证 kubelet 正确运行：每台机器执行<code>swapoff -a</code>。（注意：机器重启后可能需要再次禁用 swap）</p>
<p>确认每台机器的 MAC 地址与 product_uuid 都是独有的。查询 MAC 地址：<code>ifconfig -a</code>，查询 product_uuid：<code>cat /sys/class/dmi/id/product_uuid</code>。</p>
<p>拥有一个可以科学上网的 VPS 服务器：<a href="https://github.com/Zouzhp3/Learn/blob/master/kubernetes/%E9%85%8D%E7%BD%AE%20VPS%20%E8%BF%9B%E8%A1%8C%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91.md" target="_blank" rel="noopener">VPS 配置 Shadowsocks 教程</a>。</p>
<p>每台机器都可以科学上网：<a href="https://github.com/Zouzhp3/Learn/blob/master/kubernetes/%28%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91%29Linux%20%E9%85%8D%E7%BD%AE%20Shadowsocks%20%E5%AE%A2%E6%88%B7%E7%AB%AF.md" target="_blank" rel="noopener">Linux 配置 Shadowsocks 客户端</a>，以及 <a href="https://github.com/Zouzhp3/Learn/blob/master/kubernetes/%E4%B8%BA%20Docker%20%E9%85%8D%E7%BD%AE%E7%BD%91%E7%BB%9C%E4%BB%A3%E7%90%86.md" target="_blank" rel="noopener">为 Docker 配置网络代理</a>。如果不能科学上网的话，就会导致很多镜像无法正常下载。</p>
<h2 id="二-安装依赖环境"><a href="#二-安装依赖环境" class="headerlink" title="二. 安装依赖环境"></a>二. 安装依赖环境</h2><h3 id="安装-Docker"><a href="#安装-Docker" class="headerlink" title="安装 Docker"></a>安装 Docker</h3><p>为所有节点（逻辑上的机器）安装 Docker，官方推荐安装 v1.12 版本（过高版本将不兼容 k8s）。可参考 <a href="https://github.com/Zouzhp3/Learn/blob/master/kubernetes/Docker%20CE%20%E5%AE%89%E8%A3%85.md" target="_blank" rel="noopener">Docker CE 安装</a>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://mirrors.ustc.edu.cn/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">$ yum makecache fast</span><br><span class="line">$ yum install -y docker-ce</span><br><span class="line">$ systemctl enable docker &amp;&amp; systemctl start docker</span><br><span class="line">``` ocker stmeablekertesocker</span><br></pre></td></tr></table></figure></p>
<p> ucgr    r<br>    /tc/docker/eoso<br>  ec atuiersystemdocker  et r ocker<code></code></p>
<h3 id="安装-kubeadm-kubelet-与-kubectl"><a href="#安装-kubeadm-kubelet-与-kubectl" class="headerlink" title="安装 kubeadm, kubelet 与 kubectl"></a>安装 kubeadm, kubelet 与 kubectl</h3><p>需要在所有节点上安装：</p>
<ul>
<li>kubeadm：引导集群的命令工具</li>
<li>kubelet：运行在集群中所有节点上的组件，负责处理 Pods 与容器。</li>
<li>kubectl：与集群交互的命令工具</li>
</ul>
<p>若可以“科学上网”（否则需要手动下载 rpm 包），则安装命令如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ yum install -y kubelet-1.9.1 kubeadm-1.9.1 kubectl-1.9.1</span><br><span class="line">$ systemctl enable kubelet &amp;&amp; systemctl start kubelet</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>选择 1.9.1 版本进行下载，但请注意必须确保 kubeadm， kubelet 的版本都一致，且与 kubectl 不低于 kubeadm 的版本。</p>
</blockquote>
<p>为防止“科学上网”，则可直接进行下一步。否则就需要手动 kubeadm 初始化 k8s 时 RHEL/CentOS 7 的用户可能会报错配置失败：<code>You should ensure net.bridge.bridge-nf-call-iptables is set to 1 in your sysctl config</code>。需要执行如下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># k8s.conf是k8s的配置文件</span><br><span class="line">$ cat &lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line">$ sysctl --system</span><br></pre></td></tr></table></figure></p>
<p>若 Docker 也配置了代理“科学上网”，则可直接进行下一步，否则就需要手动下载如下镜像到本地：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY                                               TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">gcr.io/google_containers/kube-apiserver-amd64            v1.9.1              e313a3e9d78d        7 weeks ago         210.4 MB</span><br><span class="line">gcr.io/google_containers/kube-scheduler-amd64            v1.9.1              677911f7ae8f        7 weeks ago         62.7 MB</span><br><span class="line">gcr.io/google_containers/kube-proxy-amd64                v1.9.1              e470f20528f9        7 weeks ago         109.1 MB</span><br><span class="line">gcr.io/google_containers/kube-controller-manager-amd64   v1.9.1              4978f9a64966        7 weeks ago         137.8 MB</span><br><span class="line">quay.io/coreos/flannel                                   v0.9.1-amd64        2b736d06ca4c        3 months ago        51.31 MB</span><br><span class="line">gcr.io/google_containers/k8s-dns-sidecar-amd64           1.14.7              db76ee297b85        4 months ago        42.03 MB</span><br><span class="line">gcr.io/google_containers/k8s-dns-kube-dns-amd64          1.14.7              5d049a8c4eec        4 months ago        50.27 MB</span><br><span class="line">gcr.io/google_containers/k8s-dns-dnsmasq-nanny-amd64     1.14.7              5feec37454f4        4 months ago        40.95 MB</span><br><span class="line">gcr.io/google_containers/etcd-amd64                      3.1.10              1406502a6459        5 months ago        192.7 MB</span><br><span class="line">gcr.io/google_containers/pause-amd64                     3.0                 99e59f495ffa        22 months ago       746.9 kB</span><br></pre></td></tr></table></figure></p>
<p>可通过 <a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/" target="_blank" rel="noopener">官网</a> 来查看所需手动下载的依赖镜像的版本。</p>
<h2 id="三-使用-kubeadm-初始化集群"><a href="#三-使用-kubeadm-初始化集群" class="headerlink" title="三. 使用 kubeadm 初始化集群"></a>三. 使用 kubeadm 初始化集群</h2><p>在一个节点（该节点将会成为集群的 master ）上使用<code>kubeadm init --kubernetes-version 1.9.1 --pod-network-cidr=10.244.0.0/16</code>来初始化一个集群（<code>--pod-network-cidr</code> 在下一节介绍）。</p>
<blockquote>
<p>注意：若主机开启了“科学上网”的网络访问代理的话，需要先关掉主机的代理，否则初始化集群时访问内部 IP 也会经过代理，从而导致报错。</p>
</blockquote>
<p>若运行成功，则输出将如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[kubeadm] WARNING: kubeadm is in beta, please do not use it for production clusters.</span><br><span class="line">[init] Using Kubernetes version: v1.8.0</span><br><span class="line">[init] Using Authorization modes: [Node RBAC]</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">[kubeadm] WARNING: starting in 1.8, tokens expire after 24 hours by default (if you require a non-expiring token use --token-ttl 0)</span><br><span class="line">[certificates] Generated ca certificate and key.</span><br><span class="line">[certificates] Generated apiserver certificate and key.</span><br><span class="line">[certificates] apiserver serving cert is signed for DNS names [kubeadm-master kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 10.138.0.4]</span><br><span class="line">[certificates] Generated apiserver-kubelet-client certificate and key.</span><br><span class="line">[certificates] Generated sa key and public key.</span><br><span class="line">[certificates] Generated front-proxy-ca certificate and key.</span><br><span class="line">[certificates] Generated front-proxy-client certificate and key.</span><br><span class="line">[certificates] Valid certificates and keys now exist in &quot;/etc/kubernetes/pki&quot;</span><br><span class="line">[kubeconfig] Wrote KubeConfig file to disk: &quot;admin.conf&quot;</span><br><span class="line">[kubeconfig] Wrote KubeConfig file to disk: &quot;kubelet.conf&quot;</span><br><span class="line">[kubeconfig] Wrote KubeConfig file to disk: &quot;controller-manager.conf&quot;</span><br><span class="line">[kubeconfig] Wrote KubeConfig file to disk: &quot;scheduler.conf&quot;</span><br><span class="line">[controlplane] Wrote Static Pod manifest for component kube-apiserver to &quot;/etc/kubernetes/manifests/kube-apiserver.yaml&quot;</span><br><span class="line">[controlplane] Wrote Static Pod manifest for component kube-controller-manager to &quot;/etc/kubernetes/manifests/kube-controller-manager.yaml&quot;</span><br><span class="line">[controlplane] Wrote Static Pod manifest for component kube-scheduler to &quot;/etc/kubernetes/manifests/kube-scheduler.yaml&quot;</span><br><span class="line">[etcd] Wrote Static Pod manifest for a local etcd instance to &quot;/etc/kubernetes/manifests/etcd.yaml&quot;</span><br><span class="line">[init] Waiting for the kubelet to boot up the control plane as Static Pods from directory &quot;/etc/kubernetes/manifests&quot;</span><br><span class="line">[init] This often takes around a minute; or longer if the control plane images have to be pulled.</span><br><span class="line">[apiclient] All control plane components are healthy after 39.511972 seconds</span><br><span class="line">[uploadconfig] Storing the configuration used in ConfigMap &quot;kubeadm-config&quot; in the &quot;kube-system&quot; Namespace</span><br><span class="line">[markmaster] Will mark node master as master by adding a label and a taint</span><br><span class="line">[markmaster] Master master tainted and labelled with key/value: node-role.kubernetes.io/master=&quot;&quot;</span><br><span class="line">[bootstraptoken] Using token: &lt;token&gt;</span><br><span class="line">[bootstraptoken] Configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials</span><br><span class="line">[bootstraptoken] Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span><br><span class="line">[bootstraptoken] Creating the &quot;cluster-info&quot; ConfigMap in the &quot;kube-public&quot; namespace</span><br><span class="line">[addons] Applied essential addon: kube-dns</span><br><span class="line">[addons] Applied essential addon: kube-proxy</span><br><span class="line"></span><br><span class="line">Your Kubernetes master has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run (as a regular user):</span><br><span class="line"></span><br><span class="line">  mkdir -p $HOME/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span><br><span class="line">  http://kubernetes.io/docs/admin/addons/</span><br><span class="line"></span><br><span class="line">You can now join any number of machines by running the following on each node</span><br><span class="line">as root:</span><br><span class="line"></span><br><span class="line">  kubeadm join --token &lt;token&gt; &lt;master-ip&gt;:&lt;master-port&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt;</span><br></pre></td></tr></table></figure></p>
<p>初始化完毕后，运行以下命令给予用户权限来使用集群：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p $HOME/.kube</span><br><span class="line">$ sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">$ sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure></p>
<p>执行 <code>kubectl get nodes</code>，发现得到了一个状态为<code>NotReady</code>的 Node。</p>
<p>查看一下集群状态<code>kubectl get cs</code>，确认各个组件都处于 healthy 状态。：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<p>查看集群组件 pod 运行情况：<code>kubectl get pods --all-namespaces</code>，正常情况下的输出如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NAMESPACE     NAME                             READY     STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   etcd-kube-1                      1/1       Running   0          1h</span><br><span class="line">kube-system   kube-apiserver-kube-1            1/1       Running   0          1h</span><br><span class="line">kube-system   kube-controller-manager-kube-1   1/1       Running   0          1h</span><br><span class="line">kube-system   kube-dns-6f4fd4bdf-jthnq         0/3       Pending   0          1h</span><br><span class="line">kube-system   kube-proxy-2r2m4                 1/1       Running   0          1h</span><br><span class="line">kube-system   kube-scheduler-kube-1            1/1       Running   0          1h</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>上面输出的 kube-dns 的状态是正常的，因为集群还没有配置网络。</p>
</blockquote>
<p>此外，集群初始化如果遇到问题，可以使用下面的命令进行清理：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm reset</span><br><span class="line">$ ifconfig cni0 down</span><br><span class="line">$ ip link delete cni0</span><br><span class="line">$ ifconfig flannel.1 down</span><br><span class="line">$ ip link delete flannel.1</span><br><span class="line">$ rm -rf /var/lib/cni/</span><br></pre></td></tr></table></figure></p>
<h2 id="四-配置集群网络（Flannel）"><a href="#四-配置集群网络（Flannel）" class="headerlink" title="四. 配置集群网络（Flannel）"></a>四. 配置集群网络（Flannel）</h2><p>集群必须安装一个 pod 网络插件以便于 pods 能够互相通信，本教程中使用 Flannel 作为集群配置网络。</p>
<blockquote>
<p>为使 flannel 运行成功，<code>kubeadm init</code> 运行时必须加上参数<code>--pod-network-cidr=10.244.0.0/16</code>。</p>
</blockquote>
<p>运行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/v0.9.1/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure></p>
<p>正常输出如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">clusterrole &quot;flannel&quot; created</span><br><span class="line">clusterrolebinding &quot;flannel&quot; created</span><br><span class="line">serviceaccount &quot;flannel&quot; created</span><br><span class="line">configmap &quot;kube-flannel-cfg&quot; created</span><br><span class="line">daemonset &quot;kube-flannel-ds&quot; created</span><br></pre></td></tr></table></figure></p>
<p>等待一段时间后，查看组件 pod 的运行情况：<code>kubectl get pods --all-namespaces</code>，若所有pods 都处于运行成功的状态，则说明网络部署成功。然后执行 <code>kubectl get nodes</code> 也可以发现 Node 已经处于 Ready 状态了。</p>
<blockquote>
<p>注意：若主机有多个网卡，则可能会遭遇错误如右：<a href="https://github.com/kubernetes/kubernetes/issues/39701" target="_blank" rel="noopener">flannel issues 3970</a>。<br>解决该问题（尚未测试）：目前需要在 kube-flannel.yml 中使用<code>--iface</code>参数指定集群主机内网网卡的名称，否则可能会导致 dns 无法解析。因此需要将 kube-flannel.yml 下载到本地，flanneld 启动参数加上 <code>--iface=&lt;iface-name&gt;</code>。</p>
</blockquote>
<h3 id="配置-master-节点是否调度-pod（可选）"><a href="#配置-master-节点是否调度-pod（可选）" class="headerlink" title="配置 master 节点是否调度 pod（可选）"></a>配置 master 节点是否调度 pod（可选）</h3><p>出于安全性考虑，在默认情况下 pod 不会被调度到 master 节点上，也就是说它不参与工作负载。但如果需要 master 也能调度 pod，以便于构造一个单节点集群用于开发用，则可以执行以下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl taint nodes --all node-role.kubernetes.io/master-</span><br></pre></td></tr></table></figure></p>
<p>输出如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">node &quot;test-01&quot; untainted</span><br><span class="line">taint key=&quot;dedicated&quot; and effect=&quot;&quot; not found.</span><br><span class="line">taint key=&quot;dedicated&quot; and effect=&quot;&quot; not found.</span><br></pre></td></tr></table></figure></p>
<h2 id="五-向集群中添加节点"><a href="#五-向集群中添加节点" class="headerlink" title="五. 向集群中添加节点"></a>五. 向集群中添加节点</h2><p>Node 是集群中负责运行容器与 Pod 的节点，当需要添加一个主机到集群中成为一个新 Node 时，ssh 连接到该主机，切换到 root 用户权限，运行 master 节点 <code>kubeadm init</code> 时的输出中的参考命令，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm join --token &lt;token&gt; &lt;master-ip&gt;:&lt;master-port&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt;</span><br></pre></td></tr></table></figure></p>
<p>若运行成功则输出如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[preflight] Running pre-flight checks.</span><br><span class="line">	[WARNING FileExisting-crictl]: crictl not found in system path</span><br><span class="line">[discovery] Trying to connect to API Server &quot;192.168.80.128:6443&quot;</span><br><span class="line">[discovery] Created cluster-info discovery client, requesting info from &quot;https://192.168.80.128:6443&quot;</span><br><span class="line">[discovery] Requesting info from &quot;https://192.168.80.128:6443&quot; again to validate TLS against the pinned public key</span><br><span class="line">[discovery] Cluster info signature and contents are valid and TLS certificate validates against pinned roots, will use API Server &quot;192.168.80.128:6443&quot;</span><br><span class="line">[discovery] Successfully established connection with API Server &quot;192.168.80.128:6443&quot;</span><br><span class="line"></span><br><span class="line">This node has joined the cluster:</span><br><span class="line">* Certificate signing request was sent to master and a response</span><br><span class="line">  was received.</span><br><span class="line">* The Kubelet was informed of the new secure connection details.</span><br><span class="line"></span><br><span class="line">Run &apos;kubectl get nodes&apos; on the master to see this node join the cluster.</span><br></pre></td></tr></table></figure></p>
<p>过一段时间后查询 <code>kubectl get nodes</code> 即可得到处于 Ready 状态的新 Node。</p>
<h3 id="尝试运行一个应用（可选-amp-重要）"><a href="#尝试运行一个应用（可选-amp-重要）" class="headerlink" title="尝试运行一个应用（可选&amp;重要）"></a>尝试运行一个应用（可选&amp;重要）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run curl --image=radial/busyboxplus:curl -i --tty</span><br><span class="line">If you don&apos;t see a command prompt, try pressing enter.</span><br><span class="line">[ root@curl-2716574283-xr8zd:/ ]$</span><br></pre></td></tr></table></figure>
<p>进入后执行 <code>nslookup kubernetes.default</code> 确认是否解析正常:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ nslookup kubernetes.default</span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kubernetes.default</span><br><span class="line">Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local</span><br></pre></td></tr></table></figure></p>
<h3 id="从-master-以外的节点来控制集群（可选-amp-重要）"><a href="#从-master-以外的节点来控制集群（可选-amp-重要）" class="headerlink" title="从 master 以外的节点来控制集群（可选&amp;重要）"></a>从 master 以外的节点来控制集群（可选&amp;重要）</h3><p>为了让其他节点（或者集群外部的节点）上的 kubectl 可以与集群通信，你需要从 master 节点复制管理员集群配置文件 <code>admin.conf</code> 到目标节点，命令如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ scp root@&lt;master ip&gt;:/etc/kubernetes/admin.conf .</span><br><span class="line">$ kubectl --kubeconfig ./admin.conf get nodes</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><code>admin.conf</code> 给予用户控制集群的超级权限，必须谨慎使用。<br>对于普通用户而言，建议生成一个独一凭证，使得放置该用户于白名单中：<code>$ kubeadm alpha phase kubeconfig user --client-name &lt;CN&gt;</code>，该命令将会输出一个 KubeConfig 文件，你可以保存该文件并发给该普通用户。然后使用<code>$ kubectl create (cluster)rolebinding</code> 启动白名单。</p>
</blockquote>
<h3 id="配置-API-Server-的代理到本地-localhost（可选-amp-重要）"><a href="#配置-API-Server-的代理到本地-localhost（可选-amp-重要）" class="headerlink" title="配置 API Server 的代理到本地 localhost（可选&amp;重要）"></a>配置 API Server 的代理到本地 localhost（可选&amp;重要）</h3><p>若需要从<strong>集群外部</strong>连接到集群的 API Server，则可以使用<code>kubectl proxy</code>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ scp root@&lt;master ip&gt;:/etc/kubernetes/admin.conf .</span><br><span class="line">$ kubectl --kubeconfig ./admin.conf proxy</span><br></pre></td></tr></table></figure></p>
<p>这样就可以在本地通过 <code>http://localhost:8001/api/v1</code> 来访问集群的 API Server 了。</p>
<h2 id="六-从集群中删除节点"><a href="#六-从集群中删除节点" class="headerlink" title="六. 从集群中删除节点"></a>六. 从集群中删除节点</h2><p>当需要从一个集群中删除节点时，首先需要停止该节点以确保该节点在关闭前是空的。</p>
<p>在 master 上运行以下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl drain &lt;node name&gt; --delete-local-data --force --ignore-daemonsets</span><br><span class="line">$ kubectl delete node &lt;node name&gt;</span><br></pre></td></tr></table></figure></p>
<p>然后在被删除的节点上重置 kubeadm 的状态即可：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm reset</span><br></pre></td></tr></table></figure></p>
<h2 id="七-安装-Dashboard"><a href="#七-安装-Dashboard" class="headerlink" title="七. 安装 Dashboard"></a>七. 安装 Dashboard</h2><p><a href="https://github.com/kubernetes/dashboard" target="_blank" rel="noopener">Kubernetes Dashboard</a> 是一个基于 web 的 k8s 集群控制台，它允许用户管理和调试已经运行在集群上的应用，甚至可以管理集群本身。</p>
<p>下载 Dashboard 的 yaml 配置文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure></p>
<p>由于Dashboard 的 service 配置模式是 ClusterIP 而不能被集群外访问，因此我们需要配置成 NodePort 模式。编辑 <code>kubernetes-dashboard.yaml</code> 文件，在 <code>Dashboard Service</code> 中添加<code>type: NodePort</code>，暴露 Dashboard 服务：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># ------------------- Dashboard Service ------------------- #</span><br><span class="line"></span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">    - port: 443</span><br><span class="line">      targetPort: 8443</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br></pre></td></tr></table></figure></p>
<p>根据配置文件安装 Dashboard（若不能“科学上网”则可能下载镜像失败）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure></p>
<p>执行 <code>kubectl proxy</code> 启动代理后，可以在<strong>代理机本地</strong>通过以下 URL 访问 Dashboard 网站：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/</span><br></pre></td></tr></table></figure></p>
<p>也可以在外部通过<code>https://[NodeIP]:[NodePort]</code>来访问。</p>
<p>查看网站页面的登录 token：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl -n kube-system get secret | grep kubernetes-dashboard</span><br><span class="line">kubernetes-dashboard-token-jxq7l kubernetes.io/service-account-token 3  22h</span><br><span class="line">$ kubectl describe -n kube-system secret/kubernetes-dashboard-token-jxq7l</span><br></pre></td></tr></table></figure></p>
<p>当需要卸载 Dashboard ：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete -f kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure></p>
<h3 id="如何使用管理员权限？"><a href="#如何使用管理员权限？" class="headerlink" title="如何使用管理员权限？"></a>如何使用管理员权限？</h3><p>如果我们直接使用上面获取的 token 登录 Dashboard 的网站后，发现几乎大部分的权限都不可以使用。 这是因为默认的 <code>kubernetes-dashboard.yaml</code> 文件中的 ServiceAccount <code>kubernetes-dashboard</code> 只有相对较小的权限。</p>
<p>因此我们需要创建一个 <code>kubernetes-dashboard-admin</code> 的 ServiceAccount 并授予其集群 admin 的权限。创建 <code>kubernetes-dashboard-admin.rbac.yaml</code>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  </span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure></p>
<p>执行该文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f kubernetes-dashboard-admin.rbac.yaml</span><br></pre></td></tr></table></figure></p>
<p>再按照同样的方法查询到 <code>kubernetes-dashboard-admin</code> 的 token ，登录 Dashborad 网站后便可以使用所有功能了。</p>
<h2 id="八-Heapster-插件部署"><a href="#八-Heapster-插件部署" class="headerlink" title="八. Heapster 插件部署"></a>八. Heapster 插件部署</h2><p>安装 <a href="https://github.com/kubernetes/heapster/" target="_blank" rel="noopener">Heapster</a> 可以为集群添加使用统计和监控功能，为 Dashboard 添加仪表盘。使用 InfluxDB 做为 Heapster 的后端存储，开始部署：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~/k8s/heapster</span><br><span class="line">cd ~/k8s/heapster</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/heapster/master/deploy/kube-config/influxdb/grafana.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/heapster/master/deploy/kube-config/rbac/heapster-rbac.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/heapster/master/deploy/kube-config/influxdb/heapster.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/heapster/master/deploy/kube-config/influxdb/influxdb.yaml</span><br><span class="line"></span><br><span class="line">kubectl create -f ./</span><br></pre></td></tr></table></figure>
<p>最后确认所有的 pod 都处于 running 状态，打开 Dashboard，集群的使用统计会以仪表盘的形式显示出来。</p>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><h3 id="1-为何配置了科学上网也无法-pull-gcr-io-的镜像？"><a href="#1-为何配置了科学上网也无法-pull-gcr-io-的镜像？" class="headerlink" title="1. 为何配置了科学上网也无法 pull gcr.io 的镜像？"></a>1. 为何配置了科学上网也无法 pull gcr.io 的镜像？</h3><p>主机网络代理与 docker 的网络代理设置是不同的，你还需要设置 docker 的网络代理：<a href="https://github.com/Zouzhp3/Learn/blob/master/kubernetes/%E4%B8%BA%20Docker%20%E9%85%8D%E7%BD%AE%E7%BD%91%E7%BB%9C%E4%BB%A3%E7%90%86.md" target="_blank" rel="noopener">为 Docker 配置网络代理</a></p>
<h3 id="2-kubelet-服务不正常运行"><a href="#2-kubelet-服务不正常运行" class="headerlink" title="2. kubelet 服务不正常运行"></a>2. kubelet 服务不正常运行</h3><p>启动启动报错 </p>
<p>单独使用 <code>kubelet</code> 服务后命令时 ，发现没有正常运行，日志报错如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">error: failed to run Kubelet: failed to create kubelet: misconfiguration: kubelet cgroup driver: &quot;cgroupfs&quot; is different from docker cgroup driver: &quot;systemd&quot;</span><br><span class="line">``` </span><br><span class="line">kubelet 的配置文件是`/etc/systemd/system/kubelet.service.d/10-kubeadm.conf`，请确保里面`KUBELET_CGROUP_ARGS=--cgroup-driver=systemd`的 `--cgroup-driver`驱动与 `docker info` 里的 `--cgroup-driver` 驱动相同。但即使确保了相同，独自执行`kubelet`命令时也会继续报同样的错。</span><br><span class="line"></span><br><span class="line">后来发现，该配置文件是在集群初始化时才会成功读取，而单独执行`kubelet`时不会读取配置文件。</span><br><span class="line"></span><br><span class="line">因此无视此问题即可，不影响集群初始化。在集群初始化成功后，可以发现`kubelet`服务是正常运行的。后来发现不影响集群初始化，且成功初始化</span><br><span class="line"></span><br><span class="line">可参考：[1.6.0 kubelet fails with error &quot;misconfiguration: kubelet cgroup driver: &quot;cgroupfs&quot; is different from docker cgroup driver: &quot;systemd&quot;](https://github.com/kubernetes/kubernetes/issues/43805)</span><br><span class="line"></span><br><span class="line">### 3. 运行 kubeadm init 时弹出警告</span><br><span class="line"></span><br><span class="line">警告如下：</span><br></pre></td></tr></table></figure></p>
<p>[preflight] Running pre-flight checks.<br>    [WARNING FileExisting-crictl]: crictl not found in system path<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">经过 github 上的开发者确认，这个 warning 可以无视。</span><br><span class="line"></span><br><span class="line">### 4. 运行 kubeadm init 时报错</span><br><span class="line"></span><br><span class="line">报错如下所示：</span><br></pre></td></tr></table></figure></p>
<p>[kubelet-check] It seems like the kubelet isn’t running or healthy.<br>[kubelet-check] The HTTP call equal to ‘curl -sSL <a href="http://localhost:10255/healthz" target="_blank" rel="noopener">http://localhost:10255/healthz</a>‘ failed with error: Get <a href="http://localhost:10255/healthz" target="_blank" rel="noopener">http://localhost:10255/healthz</a>: dial tcp [::1]:10255: getsockopt: connection refused.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">经查资料发现是因为没有禁用 swap（每次机器重启会重置 swap），但是经过重置虚拟机网络以及恢复快照后得到的系统仍然会出现此错误。后来经过重新安装 kubeadm 与 kubelet 成功解决。</span><br><span class="line"></span><br><span class="line">### 5. 忘记了集群初始化成功时输出的参考命令</span><br><span class="line"></span><br><span class="line">如果不小心忘记了集群初始化成功时输出的参考命令，可使用以下命令来查询。</span><br><span class="line"></span><br><span class="line">查看 master 的 token：</span><br></pre></td></tr></table></figure></p>
<p>$ kubeadm token list | grep authentication,signing | awk ‘{print $1}’<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">查看 master 的 discovery-token-ca-cert-hash：</span><br></pre></td></tr></table></figure></p>
<p>$ openssl x509 -pubkey -in  /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null  | openssl dgst -sha256 -hex | sed ‘s/^.* //‘<br><code>`</code></p>
<h3 id="6-为何设置了-NodePort-模式也无法从外部访问-Dashboard-网站？"><a href="#6-为何设置了-NodePort-模式也无法从外部访问-Dashboard-网站？" class="headerlink" title="6. 为何设置了 NodePort 模式也无法从外部访问 Dashboard 网站？"></a>6. 为何设置了 NodePort 模式也无法从外部访问 Dashboard 网站？</h3><p>这是因为 Dashboard 配置文件默认采取了 HTTPS 协议，因此需要以 <code>https://[NodeIP]:[NodePort]</code> 的方式来访问。同时又因为 Chrome 浏览器不能支持访问未认证的 https 网站，所以建议使用其他浏览器（如 Firefox）。</p>
<h2 id="部署总结"><a href="#部署总结" class="headerlink" title="部署总结"></a>部署总结</h2><p>从零开始学习使用 kubeadm 部署一个 k8s 集群总计花了我五天多时间，一开始大部分时间花在了如何下载合适版本的 kubeadm 和 kubelet，以及通过各种手段下载国内获取不到的镜像，但效果仍然不好。之后通过搭建 ShadowSocks 客户端使得可以成功下载合适版本的 kubeadm 和 kubelet，但发现还是 pull 不了镜像，最后发现是因为 Docker 的代理配置与主机的代理配置是不共用的。配置了 Docker 代理后便可以在初始化集群的过程中自动 pull 需要的镜像。通过使用翻墙代理，确实可以少花很多不必要的时间。</p>
<p>部署期间也遇到一些问题，有的是因为过于钻牛角尖，陷入到单独启动 <code>kubelet</code> 失败的问题中了，误以为该问题必须在集群初始化之前解决；有的是因为理论知识不扎实，对 Docker 的不了解；还有的是就是虚拟机网络配置突然变化导致的玄学和 Chrome 不支持不安全证书的 HTTPS 网站而导致的误判。</p>
<p>总而言之，以官方文档作为主线，配以他人博客上的成功部署经验，再加上使用翻墙代理，才能够又快又好地部署成功。此外，学会使用虚拟机的快照功能也是很重要的，方便进行重要操作前的备份。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://kubernetes.io/docs/setup/independent/install-kubeadm/" target="_blank" rel="noopener">Installing kubeadm</a> （官网）</p>
<p><a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/" target="_blank" rel="noopener">Using kubeadm to Create a Cluster</a>（官网）</p>
<p><a href="https://github.com/kubernetes/dashboard/wiki/Creating-sample-user" target="_blank" rel="noopener">Dashboard: Creating sample user</a> （Dashboard 的 github）</p>
<p><a href="http://blog.csdn.net/zhuchuangang/article/details/76572157#2-%E9%85%8D%E7%BD%AEkubelet" target="_blank" rel="noopener">使用kubeadm安装kubernetes1.7/1.8/1.9</a></p>
<p><a href="https://blog.frognew.com/2017/12/kubeadm-install-kubernetes-1.9.html#1%E5%87%86%E5%A4%87" target="_blank" rel="noopener">使用kubeadm安装Kubernetes 1.9</a>（Dashboard）</p>
<p><a href="https://www.kubernetes.org.cn/2906.html" target="_blank" rel="noopener">使用kubeadm安装Kubernetes 1.8版本</a></p>
<p><a href="https://www.kubernetes.org.cn/3357.html" target="_blank" rel="noopener">使用 kubeadm 创建 kubernetes 1.9 集群</a></p>
<p><a href="https://www.zybuluo.com/ncepuwanghui/note/953929" target="_blank" rel="noopener">使用kubeadm在CentOS 7上安装Kubernetes 1.8</a>（Dashboard） 参考资料</p>
<p><a href="https://kubernetes.io/docs/setup/independent/install-kubeadm/" target="_blank" rel="noopener">Installing kubeadm</a> （来自官网）</p>
<p><a href="http://blog.csdn.net/zhuchuangang/article/details/76572157#2-%E9%85%8D%E7%BD%AEkubelet" target="_blank" rel="noopener">使用kubeadm安装kubernetes1.7/1.8/1.9</a></p>
<!--stackedit_data:
eyJoaXN0b3J5IjpbNDk4MTAzMDE2LDc3Nzg2ODE4OF19
-->
<hr>
<ul>
<li><p><a href="/more/donate/index.html"><strong><em><font color="red">我觉得帮助到我了, 支持你一下.</font></em></strong></a><br>   </p>
</li>
<li><p><a href="https://www.paypal.me/momodainfo" target="_blank" rel="noopener"><strong><em><font color="red">If you think the article is helpful to you, you can reward me through paypal.</font></em></strong></a></p>
</li>
</ul>
<h3 id="Ads"><a href="#Ads" class="headerlink" title="Ads"></a>Ads</h3><p><em>这是小广告! 如果有需要, 不妨支持一下吧~</em></p>
<blockquote>
<p> <a target="_blank" href="https://amazon.cn/gp/search?ie=UTF8&tag=momoda-23&linkCode=ur2&linkId=4a0e4fbec0cfa8dfe540ca999d0bf999&camp=536&creative=3200&index=books&keywords=编程">这些好书您看了吗?</a><img src="//ir-cn.amazon-adsystem.com/e/ir?t=momoda-23&l=ur2&o=28" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p>
</blockquote>
<blockquote>
<p>体育&amp;户外用品推荐</p>
</blockquote>
<div align="center"> <a href="https://www.amazon.cn/B07HWB88Z5/dp/B07HWB88Z5/ref=as_sl_pc_tf_til?tag=momoda-23&linkCode=w00&linkId=14df5124f2165d9eb3d65252e60ed2cf&creativeASIN=B07HWB88Z5" target="_blank" rel="noopener"><img src="/se-notes/云计算实践/Kubernetes部署/kubeadm部署多节点集群/../../../../more/ads/amazon.gif" width="100%"></a> </div>
      
    </div><!-- .entry-content -->

    <footer class="entry-meta">
    <a href="/se-notes/云计算实践/Kubernetes部署/kubeadm部署多节点集群/">
    <time datetime="2019-01-03T13:49:30.000Z" class="entry-date">
        1月 3 2019
    </time>
</a>
    
  <span class="article-delim">&#8226;</span>
  <div class="article-category">
  <a class="article-category-link" href="/categories/通用技术/">通用技术</a>, <a class="article-category-link" href="/categories/通用技术/云计算实践/">云计算实践</a>, <a class="article-category-link" href="/categories/通用技术/云计算实践/kubernetes部署/">kubernetes部署</a>
  </div>

    
  <span class="article-delim">&#8226;</span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/云计算/">云计算</a></li></ul>

    </footer>
</article>






  
    <article id="post-Docker-Notes-by-CS-Notes" class="post-Docker-Notes-by-CS-Notes post type-post status-publish format-standard hentry">
    <!---->

      <header class="entry-header">
        
        
  
    <h1 class="entry-title">
      <a class="article-title" href="/Docker-Notes-by-CS-Notes/">Docker-Notesby-CS-Notes.md</a>
    </h1>
  

        
        <div class="comments-link">
            
            <a href="javascript:void(0);" data-url="https://wnhby.github.io/Docker-Notes-by-CS-Notes/" data-id="cjsbez0320000czs66qlcwonu" class="leave-reply bdsharebuttonbox" data-cmd="more">分享</a>
        </div><!-- .comments-link -->
      </header><!-- .entry-header -->

    <div class="entry-content">
      
        <!-- GFM-TOC -->
<ul>
<li><a href="#一解决的问题">一、解决的问题</a></li>
<li><a href="#二与虚拟机的比较">二、与虚拟机的比较</a></li>
<li><a href="#三优势">三、优势</a></li>
<li><a href="#四使用场景">四、使用场景</a></li>
<li><a href="#五镜像与容器">五、镜像与容器</a></li>
<li><a href="#参考资料">参考资料</a><!-- GFM-TOC -->
</li>
</ul>
<h1 id="一、解决的问题"><a href="#一、解决的问题" class="headerlink" title="一、解决的问题"></a>一、解决的问题</h1><p>由于不同的机器有不同的操作系统，以及不同的库和组件，在将一个应用部署到多台机器上需要进行大量的环境配置操作。</p>
<p>Docker 主要解决环境配置问题，它是一种虚拟化技术，对进程进行隔离，被隔离的进程独立于宿主操作系统和其它隔离的进程。使用 Docker 可以不修改应用程序代码，不需要开发人员学习特定环境下的技术，就能够将现有的应用程序部署在其他机器中。</p>
<div align="center"> <img src="/Docker-Notes-by-CS-Notes/pics/011f3ef6-d824-4d43-8b2c-36dab8eaaa72-1.png" width="400px"> </div><br><br><br># 二、与虚拟机的比较<br><br>虚拟机也是一种虚拟化技术，它与 Docker 最大的区别在于它是通过模拟硬件，并在硬件上安装操作系统来实现。<br><br><div align="center"> <img src="/Docker-Notes-by-CS-Notes/pics/71f61bc3-582d-4c27-8bdd-dc7fb135bf8f.png" width="250px"> </div><br><br><br><div align="center"> <img src="/Docker-Notes-by-CS-Notes/pics/7e873b60-44dc-4911-b080-defd5b8f0b49.png" width="250"> </div><br><br><br>## 启动速度<br><br>启动虚拟机需要启动虚拟机的操作系统，再启动应用，这个过程非常慢；<br><br>而启动 Docker 相当于启动宿主操作系统上的一个进程。<br><br>## 占用资源<br><br>虚拟机是一个完整的操作系统，需要占用大量的磁盘、内存和 CPU，一台机器只能开启几十个的虚拟机。<br><br>而 Docker 只是一个进程，只需要将应用以及相关的组件打包，在运行时占用很少的资源，一台机器可以开启成千上万个 Docker。<br><br># 三、优势<br><br>除了启动速度快以及占用资源少之外，Docker 具有以下优势：<br><br>## 更容易迁移<br><br>提供一致性的运行环境，可以在不同的机器上进行迁移，而不用担心环境变化导致无法运行。<br><br>## 更容易维护<br><br>使用分层技术和镜像，使得应用可以更容易复用重复部分。复用程度越高，维护工作也越容易。<br><br>## 更容易扩展<br><br>可以使用基础镜像进一步扩展得到新的镜像，并且官方和开源社区提供了大量的镜像，通过扩展这些镜像可以非常容易得到我们想要的镜像。<br><br># 四、使用场景<br><br>## 持续集成<br><br>持续集成指的是频繁地将代码集成到主干上，这样能够更快地发现错误。<br><br>Docker 具有轻量级以及隔离性的特点，在将代码集成到一个 Docker 中不会对其它 Docker 产生影响。<br><br>## 提供可伸缩的云服务<br><br>根据应用的负载情况，可以很容易地增加或者减少 Docker。<br><br>## 搭建微服务架构<br><br>Docker 轻量级的特点使得它很适合用于部署、维护、组合微服务。<br><br># 五、镜像与容器<br><br>镜像是一种静态的结构，可以看成面向对象里面的类，而容器是镜像的一个实例。<br><br>镜像包含着容器运行时所需要的代码以及其它组件，它是一种分层结构，每一层都是只读的（read-only layers）。构建镜像时，会一层一层构建，前一层是后一层的基础。镜像的这种分层存储结构很适合镜像的复用以及定制。<br><br>构建容器时，通过在镜像的基础上添加一个可写层（writable layer），用来保存着容器运行过程中的修改。<br><br><div align="center"> <img src="/Docker-Notes-by-CS-Notes/pics/docker-filesystems-busyboxrw.png"> </div><br><br><br># 参考资料<br><br>- <a href="https://blog.docker.com/2017/08/docker-101-introduction-docker-webinar-recap/" target="_blank" rel="noopener">DOCKER 101: INTRODUCTION TO DOCKER WEBINAR RECAP</a><br>- <a href="http://www.ruanyifeng.com/blog/2018/02/docker-tutorial.html" target="_blank" rel="noopener">Docker 入门教程</a><br>- <a href="http://www.bogotobogo.com/DevOps/Docker/Docker_Container_vs_Virtual_Machine.php" target="_blank" rel="noopener">Docker container vs Virtual machine</a><br>- <a href="https://linoxide.com/linux-how-to/dockerfile-create-docker-container/" target="_blank" rel="noopener">How to Create Docker Container using Dockerfile</a><br>- <a href="http://www.cnblogs.com/sammyliu/p/5877964.html" target="_blank" rel="noopener">理解 Docker（2）：Docker 镜像</a><br>- <a href="https://yeasy.gitbooks.io/docker_practice/introduction/why.html" target="_blank" rel="noopener">为什么要使用 Docker？</a><br>- <a href="https://www.docker.com/what-docker" target="_blank" rel="noopener">What is Docker</a><br>- <a href="http://www.ruanyifeng.com/blog/2015/09/continuous-integration.html" target="_blank" rel="noopener">持续集成是什么？</a><br><br>[转自]: <a href="https://github.com/CyC2018/" target="_blank" rel="noopener">https://github.com/CyC2018/</a><br><br><br>—<br><br><em> <a href="/more/donate/index.html"><strong><em><font color="red">我觉得帮助到我了, 支持你一下.</font></em></strong></a><br>   

</em> <a href="https://www.paypal.me/momodainfo" target="_blank" rel="noopener"><strong><em><font color="red">If you think the article is helpful to you, you can reward me through paypal.</font></em></strong></a><br><br><br>### Ads<br><br><em>这是小广告! 如果有需要, 不妨支持一下吧~</em><br><br>&gt;  <a target="_blank" href="https://amazon.cn/gp/search?ie=UTF8&tag=momoda-23&linkCode=ur2&linkId=4a0e4fbec0cfa8dfe540ca999d0bf999&camp=536&creative=3200&index=books&keywords=编程">这些好书您看了吗?</a><img src="//ir-cn.amazon-adsystem.com/e/ir?t=momoda-23&l=ur2&o=28" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"><br><br>&gt; 体育&amp;户外用品推荐<br><div align="center"> <a href="https://www.amazon.cn/B07HWB88Z5/dp/B07HWB88Z5/ref=as_sl_pc_tf_til?tag=momoda-23&linkCode=w00&linkId=14df5124f2165d9eb3d65252e60ed2cf&creativeASIN=B07HWB88Z5" target="_blank" rel="noopener"><img src="/Docker-Notes-by-CS-Notes/../more/ads/amazon.gif" width="100%"></a> </div>

      
    </div><!-- .entry-content -->

    <footer class="entry-meta">
    <a href="/Docker-Notes-by-CS-Notes/">
    <time datetime="2019-01-03T13:49:30.000Z" class="entry-date">
        1月 3 2019
    </time>
</a>
    
  <span class="article-delim">&#8226;</span>
  <div class="article-category">
  <a class="article-category-link" href="/categories/通用技术/">通用技术</a>, <a class="article-category-link" href="/categories/通用技术/Docker/">Docker</a>
  </div>

    
  <span class="article-delim">&#8226;</span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CS-Notes/">CS-Notes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li></ul>

    </footer>
</article>






  
    <article id="post-se-notes/云计算实践/Kubernetes部署/k8s基础教程" class="post-se-notes/云计算实践/Kubernetes部署/k8s基础教程 post type-post status-publish format-standard hentry">
    <!---->

      <header class="entry-header">
        
        
  
    <h1 class="entry-title">
      <a class="article-title" href="/se-notes/云计算实践/Kubernetes部署/k8s基础教程/">k8s基础教程</a>
    </h1>
  

        
        <div class="comments-link">
            
            <a href="javascript:void(0);" data-url="https://wnhby.github.io/se-notes/云计算实践/Kubernetes部署/k8s基础教程/" data-id="cjsbez0fh00dcczs6iq7s63wt" class="leave-reply bdsharebuttonbox" data-cmd="more">分享</a>
        </div><!-- .comments-link -->
      </header><!-- .entry-header -->

    <div class="entry-content">
      
        <!-- TOC -->
<ul>
<li><a href="#k8s-集群的介绍安装与配置实践版">K8S 集群的介绍、安装与配置（实践版）</a><pre><code>- [术语简介](#术语简介)
</code></pre><ul>
<li><a href="#1--事前准备">1.  事前准备</a></li>
<li><a href="#2-配置-kubectl-与-minikube">2. 配置 kubectl 与 Minikube</a></li>
<li><a href="#3-安装-virtualbox">3. 安装 VirtualBox</a></li>
<li><a href="#4-使用-minikube-运行集群">4. 使用 Minikube 运行集群</a></li>
<li><a href="#5-在集群上部署应用">5. 在集群上部署应用</a></li>
<li><a href="#6-查看-pod-与-node">6. 查看 Pod 与 Node</a></li>
<li><a href="#7-部署-service">7. 部署 Service</a></li>
<li><a href="#8-调整应用规模">8. 调整应用规模</a></li>
<li><a href="#9-执行滚动更新">9. 执行滚动更新</a></li>
<li><a href="#注意事项">注意事项</a></li>
<li><a href="#参考资料">参考资料</a><ul>
<li><a href="#ads">Ads</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h1 id="K8S-集群的介绍、安装与配置（实践版）"><a href="#K8S-集群的介绍、安装与配置（实践版）" class="headerlink" title="K8S 集群的介绍、安装与配置（实践版）"></a>K8S 集群的介绍、安装与配置（实践版）</h1><p>k8s 集群由一个 master 节点与多个 node 节点组成，所有节点均是在逻辑上独立的一个机器 。master 节点是管理整个集群的节点，而 node 节点是具体执行业务的节点，每个 node 都有一个 kubelet 作为其代理用于与 master 通信。</p>
<p><img src="https://d33wubrfki0l68.cloudfront.net/99d9808dcbf2880a996ed50d308a186b5900cec9/40b94/docs/tutorials/kubernetes-basics/public/images/module_01_cluster.svg" alt="enter image description here"></p>
<p>而在本教程中，我们介绍 k8s 集群的基本操作：将会在本地机器上部署一个<strong>单 Node 的 k8s 集群</strong>，并尝试在该集群上<strong>部署一个应用</strong>、<strong>配置暴露应用的服务</strong>、以及<strong>对应用进行规模调整与版本更新</strong>。</p>
<h3 id="术语简介"><a href="#术语简介" class="headerlink" title="术语简介"></a>术语简介</h3><p><a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl/" target="_blank" rel="noopener">kubectl</a> 是 k8s 的命令行管理工具，管理 k8s 集群需要通过该系列命令进行。</p>
<p> <a href="https://kubernetes.io/docs/getting-started-guides/minikube/" target="_blank" rel="noopener">Minikube</a> 是一个用于在本地上运行 kubernates 的工具插件。Minikube 可在本地机器上创建一个虚拟机（需要安装对应的虚拟机驱动，如 VirtualBox、KVM 等），从而运行一个单节点的 k8s 集群。原理图如下：</p>
<p><img src="https://yqfile.alicdn.com/c03a43e0731ca579d1844fb44269fd2fd257bfb3.jpeg" alt="minikube 原理说明图"></p>
<p><a href="https://www.virtualbox.org/" target="_blank" rel="noopener">VirtualBox</a> 是一款支持 x86 和 AMD64/Intel64 的开源虚拟机软件，支持 Window、Linux 等系统。在本教程中，我们把它作为 Minikube 的虚拟机驱动。</p>
<h2 id="1-事前准备"><a href="#1-事前准备" class="headerlink" title="1.  事前准备"></a>1.  事前准备</h2><ul>
<li>准备好一台操作系统为 Linux CentOS 7 系统、内存为 <strong>4G 以上</strong>的虚机（或物理机），完成换源与关闭防火墙和 SELinux</li>
<li>需要在虚机上安装 VirtualBox 或 KVM 作为虚拟化软件（本教程介绍 VirtualBox 的安装）</li>
<li>设置 CPU 支持虚拟化 VT-X（若是物理机则在BIOS上设置，若是虚机则在VMware里设置 ）</li>
</ul>
<h2 id="2-配置-kubectl-与-Minikube"><a href="#2-配置-kubectl-与-Minikube" class="headerlink" title="2. 配置 kubectl 与 Minikube"></a>2. 配置 kubectl 与 Minikube</h2><p>下载 kubectl 并配置到系统路径：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.9.1/bin/linux/amd64/kubectl</span><br><span class="line">$ chmod +x ./kubectl</span><br><span class="line">$ sudo mv ./kubectl /usr/local/bin/</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>注意 kubectl 的版本必须新于 k8s 服务器的版本，否则会出现校验错误。可通过 <code>curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt</code> 命令查询当前的最新稳定版本。</p>
</blockquote>
<p>下载 Minikube 并配置到系统路径：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 </span><br><span class="line">$ chmod +x ./minikube</span><br><span class="line">$ sudo mv ./minikube /usr/local/bin/</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>注意：由于本节所述的下载网址有时会无法通过 curl 命令访问，因此建议直接下载 kubectl 或 minikube 到本地再上传到虚机中。也可以通过其他途径如 <a href="https://github.com/kubernetes/minikube/releases" target="_blank" rel="noopener">minikube 的 github 下载地址</a> 进行下载。</p>
</blockquote>
<h2 id="3-安装-VirtualBox"><a href="#3-安装-VirtualBox" class="headerlink" title="3. 安装 VirtualBox"></a>3. 安装 VirtualBox</h2><p>本教程中 minikube 的虚拟机采用 VirtualBox ，安装步骤如下：</p>
<ol>
<li>在官网下载对应系统的 VirtualBox rpm 包</li>
<li>安装 VirtualBox 的依赖包：<code>yum install qt qt-x11 gcc gcc-c++ kernel-devel perl SDL</code></li>
<li>安装 VirtualBox：<code>rpm -i VirtualBox-5.2-5.2.6_120293_el7-1.x86_64.rpm</code></li>
<li>添加当前用户到 VirtualBox 创建的用户组 “vboxusers”：<code>usermod -a -G vboxusers </code></li>
</ol>
<blockquote>
<p>在 Linux 下，Minikube 也支持 –vm-driver=none 选项来在本机运行 Kubernetes 组件（此种方式尚未实验）。</p>
</blockquote>
<h2 id="4-使用-Minikube-运行集群"><a href="#4-使用-Minikube-运行集群" class="headerlink" title="4. 使用 Minikube 运行集群"></a>4. 使用 Minikube 运行集群</h2><p>执行 <code>minikube start</code> 启动本地 k8s 集群。当正常启动成功时，出现以下输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Starting local Kubernetes v1.8.0 cluster...</span><br><span class="line">Starting VM...</span><br><span class="line">Downloading Minikube ISO</span><br><span class="line"> 140.01 MB / 140.01 MB [============================================] 100.00% 0s</span><br><span class="line">Getting VM IP address...</span><br><span class="line">Moving files into cluster...</span><br><span class="line">Downloading localkube binary</span><br><span class="line"> 148.25 MB / 148.25 MB [============================================] 100.00% 0s</span><br><span class="line">Connecting to cluster...</span><br><span class="line">Setting up kubeconfig...</span><br><span class="line">Starting cluster components...</span><br><span class="line">Kubectl is now configured to use the cluster.</span><br><span class="line">Loading cached images from config file.</span><br></pre></td></tr></table></figure></p>
<p>执行 <code>minikube status</code> 可查看当前集群状态，输出类似如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">minikube: Running</span><br><span class="line">cluster: Running</span><br><span class="line">kubectl: Correctly Configured: pointing to minikube-vm at 192.168.99.100</span><br></pre></td></tr></table></figure></p>
<p>使用 <code>kubectl version</code> 可查看当前的 k8s 集群的客户端与服务端的版本；使用 <code>kubectl cluster-info</code> 可查看集群的详细部署情况；使用 <code>kubectl get nodes</code> 查看集群节点情况。</p>
<h2 id="5-在集群上部署应用"><a href="#5-在集群上部署应用" class="headerlink" title="5. 在集群上部署应用"></a>5. 在集群上部署应用</h2><p>部署文件（Deployment）是用于指导 k8s 集群如何创建与维护应用实例的。</p>
<p><img src="https://d33wubrfki0l68.cloudfront.net/152c845f25df8e69dd24dd7b0836a289747e258a/4a1d2/docs/tutorials/kubernetes-basics/public/images/module_02_first_app.svg" alt="enter image description here"></p>
<p><code>kubectl run</code> 命令用于创建一个新的 Deployment，此命令需要提供 Deployment 的命名以及 app 镜像的地址。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 若需要在特定端口运行app，则用 --port 指明运行端口</span><br><span class="line">$ kubectl run kubernetes-bootcamp --image=docker.io/jocatalin/kubernetes-bootcamp:v1 --port=8080</span><br><span class="line"># 创建完成后可以查询 Deployment</span><br><span class="line">$ kubectl get deployments</span><br></pre></td></tr></table></figure></p>
<p>Pod 是 k8s 集群管理的基本单位。当一个 Deployment 创建后，集群将会创建一个 Pod 来管理应用实例。一个 Pod 是一个 k8s 抽象，代表了一组（一个或多个）应用容器，且这些容器之间共享存储、网络等资源。</p>
<p>默认情况下，集群中的 Pods 对外部网络是不可见的，但 kubectl 可以创建一个能够转发请求到集群端私有网络的代理：<code>kubectl proxy</code>，执行后的输出类似如下（注意当前终端会阻塞）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl proxy</span><br><span class="line">Starting to serve on 127.0.0.1:8001</span><br></pre></td></tr></table></figure></p>
<p>通过使用 <code>kubectl proxy</code> 所展示的地址，我们就可以直接访问 k8s API，例如 <code>curl http://127.0.0.1:8001/version</code> 就可获取当前 API Server 的版本。</p>
<p>API Server 会自动根据 pod 的名字来为每个 pod 创建一个访问点（endpoint），该访问点也可以通过 proxy 来直接访问：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ export POD_NAME=$(kubectl get pods -o go-template --template &apos;&#123;&#123;range .items&#125;&#125;&#123;&#123;.metadata.name&#125;&#125;&#123;&#123;&quot;\n&quot;&#125;&#125;&#123;&#123;end&#125;&#125;&apos;)</span><br><span class="line">$ echo Name of the Pod: $POD_NAME</span><br><span class="line">$ curl http://localhost:8001/api/v1/proxy/namespaces/default/pods/$POD_NAME/</span><br></pre></td></tr></table></figure></p>
<h2 id="6-查看-Pod-与-Node"><a href="#6-查看-Pod-与-Node" class="headerlink" title="6. 查看 Pod 与 Node"></a>6. 查看 Pod 与 Node</h2><p>一个 Pod 运行于一个 Node 上，Node 则是 k8s 集群中的执行业务的逻辑主机（虚拟机或者物理机），由 master 进行管理。一个 Node 可以拥有多个 Pod，且 master 可以在集群中的多个 node 之间自动调度 Pod。示意图如下：</p>
<p><img src="https://d33wubrfki0l68.cloudfront.net/5cb72d407cbe2755e581b6de757e0d81760d5b86/a9df9/docs/tutorials/kubernetes-basics/public/images/module_03_nodes.svg" alt="enter image description here"></p>
<p>常用的查询应用的命令包括：</p>
<ul>
<li><strong>kubectl get</strong> ： 列出资源</li>
<li><strong>kubectl describe</strong> : 展示资源详情</li>
<li><strong>kubectl logs</strong> : 打印某个 Pod 中的一个容器的日志</li>
<li><strong>kubectl exec</strong> : 在一个 Pod 中的一个容器中执行命令</li>
</ul>
<h2 id="7-部署-Service"><a href="#7-部署-Service" class="headerlink" title="7. 部署 Service"></a>7. 部署 Service</h2><p>一个 Service 是集群中的一个抽象，它定义了一组逻辑相关的 Pods 以及如何访问它们的策略。Services 允许独立的 Pods 间的松耦合。</p>
<p><img src="https://d33wubrfki0l68.cloudfront.net/cc38b0f3c0fd94e66495e3a4198f2096cdecd3d5/ace10/docs/tutorials/kubernetes-basics/public/images/module_04_services.svg" alt="enter image description here"></p>
<p>Service 使用标签（Label）和选择器（Selector）来匹配一组 Pods。</p>
<p><img src="https://d33wubrfki0l68.cloudfront.net/b964c59cdc1979dd4e1904c25f43745564ef6bee/f3351/docs/tutorials/kubernetes-basics/public/images/module_04_labels.svg" alt="enter image description here"></p>
<p>尽管每个 Pod 都有自己独立的 IP，但是这些 IP 要是没有 Service 就无法被外部网络访问。Service 有以下配置模式：</p>
<ul>
<li>ClusterIP（默认）： 赋予 Service 一个集群内部 IP 。这种模式使得服务只能在集群内可被访问。</li>
<li>NodePort：通过 NAT 允许 Service 使用集群内一个 Node 的 IP。从而就可以使用 \&lt;NodeIP>:\&lt;NodePort> 的方式让该 Service 可被集群外部访问。</li>
<li>LoadBalancer：创建一个外部负载均衡器，并赋予 Service 一个固定的外部 IP。</li>
<li>ExternalName：不使用代理，赋予 Service 一个任意的名字（由配置文件中的 <code>externalName</code> 参数决定）</li>
</ul>
<p>以下命令可创建一个名为 “kubernetes-bootcamp” 的 NodePort 模式的 Service（其对外部网络可见）。再使用 <code>describe service</code> 命令可查看某个 Service 的详情：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl expose deployment/kubernetes-bootcamp --type=&quot;NodePort&quot; --port 8080</span><br><span class="line">$ kubectl describe services/kubernetes-bootcamp</span><br></pre></td></tr></table></figure></p>
<p>可设置环境变量 NODE_PORT，通过 \&lt;NodeIP>:\&lt;NodePort> 从外网访问该 Service：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ export NODE_PORT=$(kubectl get services/kubernetes-bootcamp -o go-template=&apos;&#123;&#123;(index .spec.ports 0).nodePort&#125;&#125;&apos;)</span><br><span class="line">$ echo NODE_PORT=$NODE_PORT</span><br><span class="line">$ curl host01:$NODE_PORT</span><br></pre></td></tr></table></figure></p>
<p>接下来介绍 Label（标签）的使用。Deployment 会自动为 Pod 创建一个 Label，使用<code>kubectl describe</code>可以查看 Label 名字。使用带参的 <code>kubectl get</code> 命令可以查询特定 Label 的 Pod 或 Service。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -l run=kubernetes-bootcamp</span><br><span class="line">$ kubectl get services -l run=kubernetes-bootcamp</span><br></pre></td></tr></table></figure></p>
<p>使用 <code>kubectl label</code> 命令为 Pod 增加一个新 Label 后，可用<code>kubectl describe</code>查询该 Pod 是否已有新 Label：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ export POD_NAME=$(kubectl get pods -o go-template --template &apos;&#123;&#123;range .items&#125;&#125;&#123;&#123;.metadata.name&#125;&#125;&#123;&#123;&quot;\n&quot;&#125;&#125;&#123;&#123;end&#125;&#125;&apos;)</span><br><span class="line">$ echo Name of the Pod: $POD_NAME</span><br><span class="line">$ kubectl label pod $POD_NAME app=v1</span><br><span class="line">$ kubectl describe pods $POD_NAME</span><br></pre></td></tr></table></figure></p>
<p>删除一个指定标签的 Service，之后便可测试到外部无法再通过 NodeIP 的方式访问到 app 了，但 app 仍在 Pod 中运行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete service -l run=kubernetes-bootcamp</span><br><span class="line">$ curl host01:$NODE_PORT</span><br><span class="line">$ kubectl exec -ti $POD_NAME curl localhost:8080</span><br></pre></td></tr></table></figure></p>
<h2 id="8-调整应用规模"><a href="#8-调整应用规模" class="headerlink" title="8. 调整应用规模"></a>8. 调整应用规模</h2><p>在之前的章节中，Deployment 只创建了一个 Pod 来运行应用，但当通信量增加时，就需要扩展应用数量来满足需求。实现的主要方式则是改变 Deployment 配置中的副本数量。应用规模变化的示意图如下：</p>
<p><img src="https://d33wubrfki0l68.cloudfront.net/043eb67914e9474e30a303553d5a4c6c7301f378/0d8f6/docs/tutorials/kubernetes-basics/public/images/module_05_scaling1.svg" alt="enter image description here"></p>
<p><img src="https://d33wubrfki0l68.cloudfront.net/30f75140a581110443397192d70a4cdb37df7bfc/b5f56/docs/tutorials/kubernetes-basics/public/images/module_05_scaling2.svg" alt="enter image description here"></p>
<p>若当前集群已有一个 Deployment（假设名为”kubernetes-bootcamp”），则可使用<code>kubectl scale</code>命令来扩展副本数量到 4 个，之后便可以检查到 pods 数量发生了变化。同时该变化也被 Deployment 记录到日志，可在详情中查看。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl scale deployments/kubernetes-bootcamp --replicas=4</span><br><span class="line">$ kubectl get deployments</span><br><span class="line">$ kubectl get pods -o wide</span><br><span class="line">$ kubectl describe deployments/kubernetes-bootcamp</span><br></pre></td></tr></table></figure></p>
<h2 id="9-执行滚动更新"><a href="#9-执行滚动更新" class="headerlink" title="9. 执行滚动更新"></a>9. 执行滚动更新</h2><p>通常用户希望应用可一直被访问，而开发者希望应用可短时间内更新多次。而<strong>滚动更新</strong>能满足该要求，允许应用以零停机时间进行部署更新（通过新增的 Pods 来更新 Pods 实例）。默认情况下，更新过程中不可用 Pods 的最大数量与新创建 Pods 的最大数量相等。k8s 集群也可以回滚该更新。</p>
<p><img src="https://d33wubrfki0l68.cloudfront.net/678bcc3281bfcc588e87c73ffdc73c7a8380aca9/703a2/docs/tutorials/kubernetes-basics/public/images/module_06_rollingupdates2.svg" alt="enter image description here"></p>
<p><img src="https://d33wubrfki0l68.cloudfront.net/9b57c000ea41aca21842da9e1d596cf22f1b9561/91786/docs/tutorials/kubernetes-basics/public/images/module_06_rollingupdates3.svg" alt="enter image description here"></p>
<p><img src="https://d33wubrfki0l68.cloudfront.net/6d8bc1ebb4dc67051242bc828d3ae849dbeedb93/fbfa8/docs/tutorials/kubernetes-basics/public/images/module_06_rollingupdates4.svg" alt="enter image description here"></p>
<p>使用<code>set image</code>命令可进行镜像更新，<code>rollout status</code>命令可进行更新确认提交，<code>rollout undo</code>可进行更新回滚。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl set image deployments/kubernetes-bootcamp kubernetes-bootcamp=jocatalin/kubernetes-bootcamp:v2</span><br><span class="line">$ kubectl rollout status deployments/kubernetes-bootcamp</span><br><span class="line">$ kubectl rollout undo deployments/kubernetes-bootcamp</span><br></pre></td></tr></table></figure></p>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ol>
<li>机器的内存必须在4G以上，否则启动 VirtualBox 时会失败</li>
<li>使用 curl 下载时，偶尔会因为网速问题无法下载成功。此时应当通过其他方式下载文件然后手动上传到系统中</li>
<li>启动 minikube 时可能会存在 localkube 找不到对应文件的情况，这是因为 localkube 的镜像下载不成功。</li>
</ol>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://kubernetes.io/docs/getting-started-guides/minikube/#minikube-features" target="_blank" rel="noopener">Running Kubernetes Locally via Minikube</a>（来自官网）</p>
<p><a href="https://linux.cn/article-8847-1.html" target="_blank" rel="noopener">Minikube：使用 Kubernetes 进行本地开发</a><br><!--stackedit_data:
eyJoaXN0b3J5IjpbOTQ2MjI4MjY5XX0=
--></p>
<hr>
<ul>
<li><p><a href="/more/donate/index.html"><strong><em><font color="red">我觉得帮助到我了, 支持你一下.</font></em></strong></a><br>   </p>
</li>
<li><p><a href="https://www.paypal.me/momodainfo" target="_blank" rel="noopener"><strong><em><font color="red">If you think the article is helpful to you, you can reward me through paypal.</font></em></strong></a></p>
</li>
</ul>
<h3 id="Ads"><a href="#Ads" class="headerlink" title="Ads"></a>Ads</h3><p><em>这是小广告! 如果有需要, 不妨支持一下吧~</em></p>
<blockquote>
<p> <a target="_blank" href="https://amazon.cn/gp/search?ie=UTF8&tag=momoda-23&linkCode=ur2&linkId=4a0e4fbec0cfa8dfe540ca999d0bf999&camp=536&creative=3200&index=books&keywords=编程">这些好书您看了吗?</a><img src="//ir-cn.amazon-adsystem.com/e/ir?t=momoda-23&l=ur2&o=28" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p>
</blockquote>
<blockquote>
<p>体育&amp;户外用品推荐</p>
</blockquote>
<div align="center"> <a href="https://www.amazon.cn/B07HWB88Z5/dp/B07HWB88Z5/ref=as_sl_pc_tf_til?tag=momoda-23&linkCode=w00&linkId=14df5124f2165d9eb3d65252e60ed2cf&creativeASIN=B07HWB88Z5" target="_blank" rel="noopener"><img src="/se-notes/云计算实践/Kubernetes部署/k8s基础教程/../../../../more/ads/amazon.gif" width="100%"></a> </div>
      
    </div><!-- .entry-content -->

    <footer class="entry-meta">
    <a href="/se-notes/云计算实践/Kubernetes部署/k8s基础教程/">
    <time datetime="2019-01-03T13:49:30.000Z" class="entry-date">
        1月 3 2019
    </time>
</a>
    
  <span class="article-delim">&#8226;</span>
  <div class="article-category">
  <a class="article-category-link" href="/categories/通用技术/">通用技术</a>, <a class="article-category-link" href="/categories/通用技术/云计算实践/">云计算实践</a>, <a class="article-category-link" href="/categories/通用技术/云计算实践/kubernetes部署/">kubernetes部署</a>
  </div>

    
  <span class="article-delim">&#8226;</span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/云计算/">云计算</a></li></ul>

    </footer>
</article>






  
    <article id="post-se-notes/云计算实践/集群高可用方案/LVS+Keepalived双机热备方案" class="post-se-notes/云计算实践/集群高可用方案/LVS+Keepalived双机热备方案 post type-post status-publish format-standard hentry">
    <!---->

      <header class="entry-header">
        
        
  
    <h1 class="entry-title">
      <a class="article-title" href="/se-notes/云计算实践/集群高可用方案/LVS+Keepalived双机热备方案/">LVS+Keepalived双机热备方案</a>
    </h1>
  

        
        <div class="comments-link">
            
            <a href="javascript:void(0);" data-url="https://wnhby.github.io/se-notes/云计算实践/集群高可用方案/LVS+Keepalived双机热备方案/" data-id="cjsbez0fv00dqczs6hnygalkx" class="leave-reply bdsharebuttonbox" data-cmd="more">分享</a>
        </div><!-- .comments-link -->
      </header><!-- .entry-header -->

    <div class="entry-content">
      
        <!-- TOC -->
<ul>
<li><a href="#lvs--keepalived-%E5%8F%8C%E6%9C%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88centos">LVS + keepalived 双机高可用部署方案（CentOS）</a><ul>
<li><a href="#%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87">前期准备</a></li>
<li><a href="#web-%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE">web 节点配置</a></li>
<li><a href="#lvs-%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE">LVS 节点配置</a></li>
<li><a href="#%E6%B5%8B%E8%AF%95">测试</a></li>
<li><a href="#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3">参考文档</a></li>
<li><a href="#ads">Ads</a></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h1 id="LVS-keepalived-双机高可用部署方案（CentOS）"><a href="#LVS-keepalived-双机高可用部署方案（CentOS）" class="headerlink" title="LVS + keepalived 双机高可用部署方案（CentOS）"></a>LVS + keepalived 双机高可用部署方案（CentOS）</h1><h3 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h3><p>准备四台虚机，分别记作 LVS-master、LVS-slave、web-node1、web-node2。前两者作为 LVS 负载均衡调度器，后两者是提供应用服务的 web 服务器。</p>
<p>安装<code>epel-realease</code>源，关闭所有虚机的防火墙与 SELinux，编辑所有节点的<code>/etc/hosts</code>文件设置主机名互相解析。使用<code>yum install ntpdate</code>安装 ntpdate，并通过<code>ntpdate 202.120.2.101</code>命令进行时间同步。</p>
<blockquote>
<p>202.120.2.101 是上海交通大学网络中心 NTP 服务器的地址</p>
</blockquote>
<h3 id="web-节点配置"><a href="#web-节点配置" class="headerlink" title="web 节点配置"></a>web 节点配置</h3><p>在两台 web 机上开启 httpd 服务，并编辑 Real Server （真实服务器，简称 RS）用于绑定 VIP （虚拟 IP）脚本<code>realserver.sh</code>如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash  </span><br><span class="line">#   </span><br><span class="line"># Script to start LVS DR real server.   </span><br><span class="line"># description: LVS DR real server   </span><br><span class="line">#   </span><br><span class="line">.  /etc/rc.d/init.d/functions</span><br><span class="line">VIP=192.168.18.200   # 在此处设置VIP  </span><br><span class="line">host=`/bin/hostname`</span><br><span class="line">case &quot;$1&quot; in  </span><br><span class="line">start)   </span><br><span class="line">       # Start LVS-DR real server on this machine.   </span><br><span class="line">        /sbin/ifconfig lo down   </span><br><span class="line">        /sbin/ifconfig lo up   </span><br><span class="line">        echo 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore   </span><br><span class="line">        echo 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce   </span><br><span class="line">        echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore   </span><br><span class="line">        echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">        /sbin/ifconfig lo:0 $VIP broadcast $VIP netmask 255.255.255.255 up  </span><br><span class="line">        /sbin/route add -host $VIP dev lo:0</span><br><span class="line">;;  </span><br><span class="line">stop)</span><br><span class="line">        # Stop LVS-DR real server loopback device(s).  </span><br><span class="line">        /sbin/ifconfig lo:0 down   </span><br><span class="line">        echo 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore   </span><br><span class="line">        echo 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce   </span><br><span class="line">        echo 0 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore   </span><br><span class="line">        echo 0 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">;;  </span><br><span class="line">status)</span><br><span class="line">        # Status of LVS-DR real server.  </span><br><span class="line">        islothere=`/sbin/ifconfig lo:0 | grep $VIP`   </span><br><span class="line">        isrothere=`netstat -rn | grep &quot;lo:0&quot; | grep $VIP`   </span><br><span class="line">        if [ ! &quot;$islothere&quot; -o ! &quot;isrothere&quot; ];then   </span><br><span class="line">            # Either the route or the lo:0 device   </span><br><span class="line">            # not found.   </span><br><span class="line">            echo &quot;LVS-DR real server Stopped.&quot;   </span><br><span class="line">        else   </span><br><span class="line">            echo &quot;LVS-DR real server Running.&quot;   </span><br><span class="line">        fi   </span><br><span class="line">;;   </span><br><span class="line">*)   </span><br><span class="line">            # Invalid entry.   </span><br><span class="line">            echo &quot;$0: Usage: $0 &#123;start|status|stop&#125;&quot;   </span><br><span class="line">            exit 1   </span><br><span class="line">;;   </span><br><span class="line">esac</span><br></pre></td></tr></table></figure>
<p>使用 <code>chmod +x realserver.sh</code>命令给脚本文件添加执行权限，并通过<code>/.realserver.sh start</code>命令启动该脚本的服务。该服务的作用是使 RS 的网卡与 VIP 进行绑定，从而可允许 RS 处理来自负载调度器转发的请求（DR 模式）。启动该服务后可用<code>ifconfig</code>命令查看是否已绑定 VIP。</p>
<h3 id="LVS-节点配置"><a href="#LVS-节点配置" class="headerlink" title="LVS 节点配置"></a>LVS 节点配置</h3><p>LVS 节点使用<code>yum install keepalived ipvsadm</code>命令安装 keepalived 服务与 LVS 服务。</p>
<p>配置文件的路径是<code>/etc/keepalived/keepalived.conf</code>。keepalived 配置文件以 block 形式组织，每个块内容都包含在<code>{}</code>中。keepalived 配置分为三类：</p>
<ul>
<li>全局配置：对整个 keepalived 都生效的配置</li>
<li>VRRPD 配置：核心配置，主要实现高可用功能</li>
<li>LVS 配置：LVS 相关功能的配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">######################</span><br><span class="line">#  全局配置（大部分选项为邮件通知服务的参数。可设置为空）</span><br><span class="line">######################</span><br><span class="line">global_defs &#123;                               # global_defs 全局配置标识 </span><br><span class="line">                                            --------------------------------------</span><br><span class="line">   notification_email &#123;                     # notification_email用于设置报警邮件地址</span><br><span class="line">     acassen@firewall.loc                   # 可以设置多个，每行一个</span><br><span class="line">     failover@firewall.loc                  # 设置邮件报警，需开启本机Sendmail 服务</span><br><span class="line">     sysadmin@firewall.loc                  # yum -y install mailx sendmail</span><br><span class="line">   &#125;                                        --------------------------------------</span><br><span class="line">   </span><br><span class="line">   notification_email_from 233@qq.com  # 设置邮件发送地址</span><br><span class="line">   smtp_server 192.168.200.1           # 设置邮件的smtp server地址</span><br><span class="line">   smtp_connect_timeout 30             # 设置连接smtp sever超时时间</span><br><span class="line">   router_id LVS_DEVEL                 # 表示运行keepalived服务器标识</span><br><span class="line">									   # 发邮件时会显示在邮件主题中</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">######################</span><br><span class="line">#  VRRPD配置</span><br><span class="line">######################</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;         # VRRPD 配置标识 VI_1是实例名称</span><br><span class="line"></span><br><span class="line">    state MASTER             # 指定Keepalvied角色。</span><br><span class="line">                             # MASTER表示此主机为主服务器，BACKUP则是表示为备用服务器</span><br><span class="line">    interface eth0           # 指定HA监测网络的接口。检查是否与ifconfig命令查看的网卡名称一致。</span><br><span class="line">    virtual_router_id 51     # 虚拟路由标识，标识为数字，同一个VRRP实例使用唯一的标识</span><br><span class="line">                             # 即可表示在同一个vrrp_instance下 MASTER_ID = BACKUP_ID</span><br><span class="line">    priority 100             # 定义节点优先级，数字越大表示节点的优先级越高</span><br><span class="line">                             # 同一个VRRP_instance下</span><br><span class="line">                             # 必须 MASTE_PRIORITY &gt; BACKUP_PRIORITY </span><br><span class="line">    advert_int 1             # 设定MASTER与BACKUP主机质检同步检查的时间间隔，单位为秒</span><br><span class="line">             </span><br><span class="line">    authentication &#123;         # 设定节点间通信验证类型和密码，验证类型主要有PASS和AH两种</span><br><span class="line">        auth_type PASS       # 同一个vrrp_instance，MASTER验证密码和BACKUP保持一致</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    virtual_ipaddress &#123;      # 设置虚拟IP地址 (VIP)，也可仅设置一个</span><br><span class="line">        192.168.200.16</span><br><span class="line">        192.168.200.17</span><br><span class="line">        192.168.200.18</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">######################</span><br><span class="line"># LVS配置</span><br><span class="line">######################</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.18.200 80 &#123;    # virtual_server LVS配置标识 </span><br><span class="line">                                      # 格式：virtual_server [VIP] [port]</span><br><span class="line">    delay_loop 6     # 设置健康检查时间间隔，单位为秒   </span><br><span class="line">    lb_algo rr       # 设置负载调度算法，可用的调度算法有：rr、wlc、lc、lblc、sh、dh等</span><br><span class="line">    lb_kind DR       # 设置LVS实现负载均衡的机制，有NAT、TUN和DR三种模式可选                   </span><br><span class="line">    nat_mask 255.255.255.0   # NAT子网掩码</span><br><span class="line">    persistence_timeout 50  # 会话保持时间 </span><br><span class="line">    protocol TCP             # 指定转发协议类型</span><br><span class="line">    </span><br><span class="line">#---------------------------------------------------------------------------------</span><br><span class="line"># persistence_timeout 会话保持时间对动态网页非常有用，为集群系统中的seesion共享提供了一个很好的解决方案</span><br><span class="line"># 用户的请求会一直分发到某个服务节点，直至超过这个会话的保持时间（指最大无响应超时时间）</span><br><span class="line"># =[用户操作动态页面如果在50s没有执行任何操作则被分发到另外的节点]</span><br><span class="line">#---------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">    real_server 192.168.18.201 80 &#123; # 设置real server段开始的标识 [IP为真实IP地址]</span><br><span class="line">        weight 1                    # 用于配置real server节点的权值，数字越大，权值越高</span><br><span class="line">                                    # 设置权值大小可以为不同性能的服务器分配不同的负载</span><br><span class="line">        HTTP_GET &#123;   </span><br><span class="line">            url &#123;   </span><br><span class="line">              path /   </span><br><span class="line">          status_code 200   </span><br><span class="line">            &#125;   </span><br><span class="line">            connect_timeout 2   </span><br><span class="line">            nb_get_retry 3   </span><br><span class="line">            delay_before_retry 1   </span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;   </span><br><span class="line">    real_server 192.168.18.202 80 &#123;   </span><br><span class="line">        weight 1   </span><br><span class="line">        HTTP_GET &#123;   </span><br><span class="line">            url &#123;   </span><br><span class="line">              path /   </span><br><span class="line">              status_code 200   </span><br><span class="line">            &#125;   </span><br><span class="line">            connect_timeout 2   </span><br><span class="line">            nb_get_retry 3   </span><br><span class="line">            delay_before_retry 1   </span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>keepalived 的配置文件路径在<code>/etc/keepalived/keepalived.conf</code>。LVS-master 与 LVS-slave 的配置文件除了 VRRPD 配置中的状态与优先级这两个参数不同外，其他参数应当相同。</p>
<p>配置完成后，启动 LVS-master 与 LVS-slave的 keepalived 服务：<code>service keepalived start</code>，并可使用<code>ipvsadm -L -n</code>命令查看 LVS 状态。</p>
<blockquote>
<p>Tips：可使用<code>service keepalived status</code>命令查看 keepalived 服务的 log。</p>
</blockquote>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>通过关闭与开启 LVS-master 的 keepalived 服务，观察 VIP 在 LVS 节点上的浮动情况。通过关闭与开启某一个 web 节点的 web 服务，观察集群的高可用是否生效。</p>
<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><p>实验步骤参考：<a href="http://freeloda.blog.51cto.com/2033581/1280962" target="_blank" rel="noopener">Linux 高可用集群之keepalived详解</a><br>详细配置参数参考：<a href="https://my.oschina.net/luciamoore/blog/607034" target="_blank" rel="noopener">Keepalived 工作原理及简要安装</a></p>
<hr>
<ul>
<li><p><a href="/more/donate/index.html"><strong><em><font color="red">我觉得帮助到我了, 支持你一下.</font></em></strong></a><br>   </p>
</li>
<li><p><a href="https://www.paypal.me/momodainfo" target="_blank" rel="noopener"><strong><em><font color="red">If you think the article is helpful to you, you can reward me through paypal.</font></em></strong></a></p>
</li>
</ul>
<h3 id="Ads"><a href="#Ads" class="headerlink" title="Ads"></a>Ads</h3><p><em>这是小广告! 如果有需要, 不妨支持一下吧~</em></p>
<blockquote>
<p> <a target="_blank" href="https://amazon.cn/gp/search?ie=UTF8&tag=momoda-23&linkCode=ur2&linkId=4a0e4fbec0cfa8dfe540ca999d0bf999&camp=536&creative=3200&index=books&keywords=编程">这些好书您看了吗?</a><img src="//ir-cn.amazon-adsystem.com/e/ir?t=momoda-23&l=ur2&o=28" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p>
</blockquote>
<blockquote>
<p>体育&amp;户外用品推荐</p>
</blockquote>
<div align="center"> <a href="https://www.amazon.cn/B07HWB88Z5/dp/B07HWB88Z5/ref=as_sl_pc_tf_til?tag=momoda-23&linkCode=w00&linkId=14df5124f2165d9eb3d65252e60ed2cf&creativeASIN=B07HWB88Z5" target="_blank" rel="noopener"><img src="/se-notes/云计算实践/集群高可用方案/LVS+Keepalived双机热备方案/../../../../more/ads/amazon.gif" width="100%"></a> </div>
      
    </div><!-- .entry-content -->

    <footer class="entry-meta">
    <a href="/se-notes/云计算实践/集群高可用方案/LVS+Keepalived双机热备方案/">
    <time datetime="2019-01-03T13:49:30.000Z" class="entry-date">
        1月 3 2019
    </time>
</a>
    
  <span class="article-delim">&#8226;</span>
  <div class="article-category">
  <a class="article-category-link" href="/categories/通用技术/">通用技术</a>, <a class="article-category-link" href="/categories/通用技术/云计算实践/">云计算实践</a>, <a class="article-category-link" href="/categories/通用技术/云计算实践/集群高可用方案/">集群高可用方案</a>
  </div>

    
  <span class="article-delim">&#8226;</span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/云计算/">云计算</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/集群/">集群</a></li></ul>

    </footer>
</article>






  
  
    <nav id="pagination">
      <nav id="page-nav">
        <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/">下一页 &raquo;</a>
      </nav>
    </nav>
  

</div></div>
        <div id="secondary" class="widget-area" role="complementary">
  
    <aside id="search" class="widget widget_search"><form role="search" method="get" accept-charset="utf-8" id="searchform" class="searchform" action="//google.com/search">
    <div>
        <input type="text" value="" name="q">
        <input type="submit" id="searchsubmit" value="google搜索">
    </div>
</form></aside>

  
    
  <aside class="widget">
    <h3 class="widget-title">Recents</h3>
    <div class="widget-content">
      <ul>
        
          <li>
            <a href="/系统剩余空间查看/">系统剩余空间查看</a>
          </li>
        
          <li>
            <a href="/数据库分类/">数据库分类</a>
          </li>
        
          <li>
            <a href="/se-notes/Java基础/集合框架/">集合框架</a>
          </li>
        
          <li>
            <a href="/se-notes/云计算实践/集群高可用方案/Heartbeat双机热备方案/">Heartbeat双机热备方案</a>
          </li>
        
          <li>
            <a href="/se-notes/云计算实践/集群高可用方案/HAProxy+Keepalived高可用方案/">HAProxy+Keepalived高可用方案</a>
          </li>
        
      </ul>
    </div>
  </aside>

  
    
  <aside class="widget">
    <h3 class="widget-title">Archives</h3>
    <div class="widget-content">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">56</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">一月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/01/">一月 2014</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </aside>

  
    
  <aside class="widget">
    <h3 class="widget-title">Categories</h3>
    <div class="widget-content">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Graphics/">Graphics</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">7</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/Shell/">Shell</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/linux基础/">linux基础</a><span class="category-list-count">6</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/协议证书/">协议证书</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/协议证书/openssl/">openssl</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/数据库基础/">数据库基础</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/框架/">框架</a><span class="category-list-count">9</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/框架/python-web应用框架/">python-web应用框架</a><span class="category-list-count">9</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/框架/python-web应用框架/flask/">flask</a><span class="category-list-count">9</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/版本控制/">版本控制</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/版本控制/Git/">Git</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程语言/">编程语言</a><span class="category-list-count">13</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/编程语言/java/">java</a><span class="category-list-count">13</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络通讯/">网络通讯</a><span class="category-list-count">11</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/网络通讯/大小端/">大小端</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络通讯/计算机网络基础/">计算机网络基础</a><span class="category-list-count">10</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/路由器/">路由器</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/路由器/openwrt/">openwrt</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/通用技术/">通用技术</a><span class="category-list-count">13</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/通用技术/Docker/">Docker</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/通用技术/云计算实践/">云计算实践</a><span class="category-list-count">11</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/通用技术/云计算实践/kubernetes部署/">kubernetes部署</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/通用技术/云计算实践/区块链/">区块链</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/通用技术/云计算实践/集群高可用方案/">集群高可用方案</a><span class="category-list-count">4</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/默认/">默认</a><span class="category-list-count">1</span></li></ul>
    </div>
  </aside>

  
    
  <aside class="widget">
    <h3 class="widget-title">Tags</h3>
    <div class="widget-content">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CS-Notes/">CS-Notes</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PEM证书/">PEM证书</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/">Shell</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cron/">cron</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/database/">database</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/diagrams/">diagrams</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker-qq/">docker-qq</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flask/">flask</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/graphics/">graphics</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/http/">http</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/informationisbeautiful/">informationisbeautiful</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java基础/">java基础</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java语法/">java语法</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernetes/">kubernetes</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network/">network</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openssl/">openssl</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openwrt/">openwrt</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/p12/">p12</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pfx/">pfx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tcp-ip/">tcp/ip</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web开发/">web开发</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/云计算/">云计算</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/区块链/">区块链</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/大小端/">大小端</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库/">数据库</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/系统管理/">系统管理</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/计算机网络/">计算机网络</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/集群/">集群</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/默认/">默认</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </aside>

  
    
  <aside class="widget">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget-content tagcloud">
      <a href="/tags/CS-Notes/" style="font-size: 10px;">CS-Notes</a> <a href="/tags/PEM证书/" style="font-size: 10px;">PEM证书</a> <a href="/tags/Shell/" style="font-size: 10px;">Shell</a> <a href="/tags/cron/" style="font-size: 10px;">cron</a> <a href="/tags/database/" style="font-size: 10px;">database</a> <a href="/tags/diagrams/" style="font-size: 10px;">diagrams</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-qq/" style="font-size: 10px;">docker-qq</a> <a href="/tags/flask/" style="font-size: 16.25px;">flask</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/graphics/" style="font-size: 10px;">graphics</a> <a href="/tags/http/" style="font-size: 17.5px;">http</a> <a href="/tags/informationisbeautiful/" style="font-size: 10px;">informationisbeautiful</a> <a href="/tags/java基础/" style="font-size: 20px;">java基础</a> <a href="/tags/java语法/" style="font-size: 20px;">java语法</a> <a href="/tags/kubernetes/" style="font-size: 13.75px;">kubernetes</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/mysql/" style="font-size: 11.25px;">mysql</a> <a href="/tags/network/" style="font-size: 17.5px;">network</a> <a href="/tags/openssl/" style="font-size: 10px;">openssl</a> <a href="/tags/openwrt/" style="font-size: 10px;">openwrt</a> <a href="/tags/p12/" style="font-size: 10px;">p12</a> <a href="/tags/pfx/" style="font-size: 10px;">pfx</a> <a href="/tags/tcp-ip/" style="font-size: 17.5px;">tcp/ip</a> <a href="/tags/web开发/" style="font-size: 16.25px;">web开发</a> <a href="/tags/云计算/" style="font-size: 18.75px;">云计算</a> <a href="/tags/区块链/" style="font-size: 10px;">区块链</a> <a href="/tags/大小端/" style="font-size: 10px;">大小端</a> <a href="/tags/数据库/" style="font-size: 12.5px;">数据库</a> <a href="/tags/系统管理/" style="font-size: 15px;">系统管理</a> <a href="/tags/计算机网络/" style="font-size: 17.5px;">计算机网络</a> <a href="/tags/集群/" style="font-size: 13.75px;">集群</a> <a href="/tags/默认/" style="font-size: 10px;">默认</a>
    </div>
  </aside>

  
    <aside class="widget">
    <h3 class="widget-title">Links</h3>
    <div class="widget-content">
		<ul id="link-list">
		<!-- link begin -->

		<li><a href="https://www.google.com/">google</a></li>
		<li><a href="https://www.baidu.com/">baidu</a></li>
		
		<!-- link end -->
		</ul>
    </div>
</aside>

  
    <aside class="widget">
    <h3 class="widget-title">Ads</h3>
    <div class="widget-content">
	 
			* <a target="_blank" href="https://amazon.cn/gp/search?ie=UTF8&tag=momoda-23&linkCode=ur2&linkId=4a0e4fbec0cfa8dfe540ca999d0bf999&camp=536&creative=3200&index=books&keywords=编程">这些好书您看了吗?</a><img src="//ir-cn.amazon-adsystem.com/e/ir?t=momoda-23&l=ur2&o=28" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;">
			<br><br>
			* 体育&户外用品推荐>
			<div align="center"> <a href="https://www.amazon.cn/B07HWB88Z5/dp/B07HWB88Z5/ref=as_sl_pc_tf_til?tag=momoda-23&linkCode=w00&linkId=14df5124f2165d9eb3d65252e60ed2cf&creativeASIN=B07HWB88Z5"><img src="/more/ads/amazon.gif" width="100%"></a> </div>

    </div>
</aside>

  
</div>
      </div>
      <footer id="colophon" role="contentinfo">
    <p>&copy; 2019 momoda
    All rights reserved.</p>
    <p>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></p>
    <a href="javascript:scrollTo(0,0);">返回顶部</a>
</footer>

    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"1","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"16"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>

<script src="/js/jquery-2.0.3.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

<script src="/js/navigation.js"></script>


<script type="text/javascript" src="https://js.users.51.la/19862371.js"></script>
<div id="bg"></div>

  </div>
</body>
</html>