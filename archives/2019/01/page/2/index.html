<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  
  <meta name="description" content="momoda">
  

  
  <meta name="keywords" content="momoda">
  
  
  
  
  
  
  
  
  
  <title>Archives: 2019/1 | Just another blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="momoda">
<meta name="keywords" content="momoda">
<meta property="og:type" content="website">
<meta property="og:title" content="Just another blog">
<meta property="og:url" content="https://wnhby.github.io/archives/2019/01/page/2/index.html">
<meta property="og:site_name" content="Just another blog">
<meta property="og:description" content="momoda">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Just another blog">
<meta name="twitter:description" content="momoda">
  
    <link rel="alternative" href="/atom.xml" title="Just another blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/css/images/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  

  
  <!-- baidu webmaster push -->
  <script src="//push.zhanzhang.baidu.com/push.js"></script>
</head></html>
<body class="home blog custom-background custom-font-enabled single-author">
  <div id="page" class="hfeed site">
      <header id="masthead" class="site-header" role="banner">
    <hgroup>
      <h1 class="site-title">
        <a href="/" title="Just another blog" rel="home">Just another blog</a>
      </h1>
      
        <h2 class="site-description">
          <a href="/" id="subtitle">momoda blog</a>
        </h2>
      
    </hgroup>

    <nav id="site-navigation" class="main-navigation" role="navigation">
            <button class="menu-toggle">菜单</button>
            <a class="assistive-text" href="/#content" title="跳至内容">跳至内容</a><!--TODO-->
            <div class="menu-main-container">
                <ul id="menu-main" class="nav-menu">
                
                    <li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/">Home</a></li>
                
                    <li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/atom.xml">RSS</a></li>
                
                    <li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/sitemap.xml">Site map</a></li>
                
                    <li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/more/share.html">Share</a></li>
                
                </ul>
            </div>
    </nav>
</header>

      <div id="main" class="wrapper">
        <div id="primary" class="site-content"><div id="content" role="main">
  
    <article id="post-se-notes/Flask-Web工程手册/README" class="post-se-notes/Flask-Web工程手册/README post type-post status-publish format-standard hentry">
    <!---->

      <header class="entry-header">
        
        
  
    <h1 class="entry-title">
      <a class="article-title" href="/se-notes/Flask-Web工程手册/README/">Flask-Web工程手册-README</a>
    </h1>
  

        
        <div class="comments-link">
            
            <a href="javascript:void(0);" data-url="https://wnhby.github.io/se-notes/Flask-Web工程手册/README/" data-id="cjsbez08m002aczs671f1tpl7" class="leave-reply bdsharebuttonbox" data-cmd="more">分享</a>
        </div><!-- .comments-link -->
      </header><!-- .entry-header -->

    <div class="entry-content">
      
        <!-- TOC -->
<ul>
<li><a href="#flask-web%E5%B7%A5%E7%A8%8B%E6%89%8B%E5%86%8C-readme">Flask-Web工程手册-README</a><ul>
<li><a href="#ads">Ads</a></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h1 id="Flask-Web工程手册-README"><a href="#Flask-Web工程手册-README" class="headerlink" title="Flask-Web工程手册-README"></a>Flask-Web工程手册-README</h1><ul>
<li>ch1-创建Python虚拟环境</li>
<li>ch2-Flask项目基本部署</li>
<li>ch3-Flask常用扩展插件</li>
<li>ch4-Linux服务器部署</li>
<li>ch5-使用lsyncd进行文件实时备份</li>
<li>ch6-配置集群共享文件NFS服务器</li>
<li>ch7-Nginx安装与重写URL-CentOS7</li>
<li>ch8-高可用与负载均衡集群部署-Ubuntu</li>
<li>…</li>
</ul>
<hr>
<ul>
<li><p><a href="/more/donate/index.html"><strong><em><font color="red">我觉得帮助到我了, 支持你一下.</font></em></strong></a><br>   </p>
</li>
<li><p><a href="https://www.paypal.me/momodainfo" target="_blank" rel="noopener"><strong><em><font color="red">If you think the article is helpful to you, you can reward me through paypal.</font></em></strong></a></p>
</li>
</ul>
<h3 id="Ads"><a href="#Ads" class="headerlink" title="Ads"></a>Ads</h3><p><em>这是小广告! 如果有需要, 不妨支持一下吧~</em></p>
<blockquote>
<p> <a target="_blank" href="https://amazon.cn/gp/search?ie=UTF8&tag=momoda-23&linkCode=ur2&linkId=4a0e4fbec0cfa8dfe540ca999d0bf999&camp=536&creative=3200&index=books&keywords=编程">这些好书您看了吗?</a><img src="//ir-cn.amazon-adsystem.com/e/ir?t=momoda-23&l=ur2&o=28" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p>
</blockquote>
<blockquote>
<p>体育&amp;户外用品推荐</p>
</blockquote>
<div align="center"> <a href="https://www.amazon.cn/B07HWB88Z5/dp/B07HWB88Z5/ref=as_sl_pc_tf_til?tag=momoda-23&linkCode=w00&linkId=14df5124f2165d9eb3d65252e60ed2cf&creativeASIN=B07HWB88Z5" target="_blank" rel="noopener"><img src="/se-notes/Flask-Web工程手册/README/../../../more/ads/amazon.gif" width="100%"></a> </div>
      
    </div><!-- .entry-content -->

    <footer class="entry-meta">
    <a href="/se-notes/Flask-Web工程手册/README/">
    <time datetime="2019-01-03T13:49:30.000Z" class="entry-date">
        1月 3 2019
    </time>
</a>
    
  <span class="article-delim">&#8226;</span>
  <div class="article-category">
  <a class="article-category-link" href="/categories/框架/">框架</a>, <a class="article-category-link" href="/categories/框架/python-web应用框架/">python-web应用框架</a>, <a class="article-category-link" href="/categories/框架/python-web应用框架/flask/">flask</a>
  </div>

    
  <span class="article-delim">&#8226;</span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web开发/">web开发</a></li></ul>

    </footer>
</article>






  
    <article id="post-se-notes/Flask-Web工程手册/ch1-创建Python虚拟环境" class="post-se-notes/Flask-Web工程手册/ch1-创建Python虚拟环境 post type-post status-publish format-standard hentry">
    <!---->

      <header class="entry-header">
        
        
  
    <h1 class="entry-title">
      <a class="article-title" href="/se-notes/Flask-Web工程手册/ch1-创建Python虚拟环境/">ch1-创建Python虚拟环境</a>
    </h1>
  

        
        <div class="comments-link">
            
            <a href="javascript:void(0);" data-url="https://wnhby.github.io/se-notes/Flask-Web工程手册/ch1-创建Python虚拟环境/" data-id="cjsbez08o002bczs6ts43lesc" class="leave-reply bdsharebuttonbox" data-cmd="more">分享</a>
        </div><!-- .comments-link -->
      </header><!-- .entry-header -->

    <div class="entry-content">
      
        <!-- TOC -->
<ul>
<li><a href="#%E4%BD%BF%E7%94%A8-virtualenv-%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83">使用 virtualenv 虚拟环境</a><ul>
<li><a href="#%E9%9C%80%E6%B1%82%E6%96%87%E4%BB%B6%E7%9A%84%E5%88%9B%E5%BB%BA%E5%8F%8A%E4%BD%BF%E7%94%A8">需求文件的创建及使用</a><ul>
<li><a href="#ads">Ads</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h1 id="使用-virtualenv-虚拟环境"><a href="#使用-virtualenv-虚拟环境" class="headerlink" title="使用 virtualenv 虚拟环境"></a>使用 virtualenv 虚拟环境</h1><p>virtualenv 是 Python 的虚拟环境，可以在同一台 PC 上隔离不同的开发环境。主要用于为不同的项目构建独立与隔离的三方库依赖。</p>
<ol>
<li>在系统中安装 virtualenv：<code>pip install virtualenv</code></li>
<li>在项目目录中建立 virtualenv 虚拟环境：<code>virtualenv [环境名]</code> </li>
<li>启动虚拟环境：<ul>
<li><code>env_dir\Scripts\activate</code>(Windows)</li>
<li><code># source env_dir/bin/activate</code>(Linux)</li>
</ul>
</li>
<li>退出虚拟环境： <code>deactivate</code></li>
</ol>
<blockquote>
<p>Note：python3 中有内置的虚拟环境，使用<code>python -m venv [环境名]</code>命令即可创建</p>
</blockquote>
<h2 id="需求文件的创建及使用"><a href="#需求文件的创建及使用" class="headerlink" title="需求文件的创建及使用"></a>需求文件的创建及使用</h2><p>Python项目中往往必须包含一个 requirements.txt 文件，用于记录所有依赖包及其精确的版本号，以便在新环境中部署。</p>
<p>在虚拟环境中使用 pip 生成需求文件：</p>
<blockquote>
<p><code>(venv) $ pip freeze &gt; requirements.txt</code></p>
</blockquote>
<p>安装或升级包后，最好更新该文件。</p>
<p>按照需求文件上的所列项，安装依赖包：</p>
<blockquote>
<p><code>(venv) $ pip install -r requirements.txt</code></p>
</blockquote>
<hr>
<ul>
<li><p><a href="/more/donate/index.html"><strong><em><font color="red">我觉得帮助到我了, 支持你一下.</font></em></strong></a><br>   </p>
</li>
<li><p><a href="https://www.paypal.me/momodainfo" target="_blank" rel="noopener"><strong><em><font color="red">If you think the article is helpful to you, you can reward me through paypal.</font></em></strong></a></p>
</li>
</ul>
<h3 id="Ads"><a href="#Ads" class="headerlink" title="Ads"></a>Ads</h3><p><em>这是小广告! 如果有需要, 不妨支持一下吧~</em></p>
<blockquote>
<p> <a target="_blank" href="https://amazon.cn/gp/search?ie=UTF8&tag=momoda-23&linkCode=ur2&linkId=4a0e4fbec0cfa8dfe540ca999d0bf999&camp=536&creative=3200&index=books&keywords=编程">这些好书您看了吗?</a><img src="//ir-cn.amazon-adsystem.com/e/ir?t=momoda-23&l=ur2&o=28" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p>
</blockquote>
<blockquote>
<p>体育&amp;户外用品推荐</p>
</blockquote>
<div align="center"> <a href="https://www.amazon.cn/B07HWB88Z5/dp/B07HWB88Z5/ref=as_sl_pc_tf_til?tag=momoda-23&linkCode=w00&linkId=14df5124f2165d9eb3d65252e60ed2cf&creativeASIN=B07HWB88Z5" target="_blank" rel="noopener"><img src="/se-notes/Flask-Web工程手册/ch1-创建Python虚拟环境/../../../more/ads/amazon.gif" width="100%"></a> </div>
      
    </div><!-- .entry-content -->

    <footer class="entry-meta">
    <a href="/se-notes/Flask-Web工程手册/ch1-创建Python虚拟环境/">
    <time datetime="2019-01-03T13:49:30.000Z" class="entry-date">
        1月 3 2019
    </time>
</a>
    
  <span class="article-delim">&#8226;</span>
  <div class="article-category">
  <a class="article-category-link" href="/categories/框架/">框架</a>, <a class="article-category-link" href="/categories/框架/python-web应用框架/">python-web应用框架</a>, <a class="article-category-link" href="/categories/框架/python-web应用框架/flask/">flask</a>
  </div>

    
  <span class="article-delim">&#8226;</span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web开发/">web开发</a></li></ul>

    </footer>
</article>






  
    <article id="post-se-notes/Flask-Web工程手册/ch2-Flask项目基本部署" class="post-se-notes/Flask-Web工程手册/ch2-Flask项目基本部署 post type-post status-publish format-standard hentry">
    <!---->

      <header class="entry-header">
        
        
  
    <h1 class="entry-title">
      <a class="article-title" href="/se-notes/Flask-Web工程手册/ch2-Flask项目基本部署/">ch2-Flask项目基本部署</a>
    </h1>
  

        
        <div class="comments-link">
            
            <a href="javascript:void(0);" data-url="https://wnhby.github.io/se-notes/Flask-Web工程手册/ch2-Flask项目基本部署/" data-id="cjsbez08q002dczs60ngha7vk" class="leave-reply bdsharebuttonbox" data-cmd="more">分享</a>
        </div><!-- .comments-link -->
      </header><!-- .entry-header -->

    <div class="entry-content">
      
        <!-- TOC -->
<ul>
<li><a href="#flask-%E9%A1%B9%E7%9B%AE%E5%9F%BA%E6%9C%AC%E9%83%A8%E7%BD%B2">Flask 项目基本部署</a><ul>
<li><a href="#%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85">环境安装</a></li>
<li><a href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84">目录结构</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3">配置文件详解</a><ul>
<li><a href="#configpy">config.py</a></li>
<li><a href="#appinitpy">app/init.py</a></li>
<li><a href="#managepy">manage.py</a></li>
<li><a href="#ads">Ads</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h1 id="Flask-项目基本部署"><a href="#Flask-项目基本部署" class="headerlink" title="Flask 项目基本部署"></a>Flask 项目基本部署</h1><p>Flask 项目没有固定的目录配置，因此在此介绍一个对 Flask 进行基本部署的教程。</p>
<h2 id="环境安装"><a href="#环境安装" class="headerlink" title="环境安装"></a>环境安装</h2><p>首先使用 virtualenv 构建好虚拟的 python 依赖环境，并安装必要的 Flask 依赖包，比如：</p>
<ul>
<li>flask：Flask 框架的基础库</li>
<li>mysql-python：处理与数据库的底层交互</li>
<li>SQLAlchemy：一个 ORM 框架，用于处理数据库与对象之间的映射</li>
<li>Flask-SQLAlchemy：简化在 Flask 中 SQLAlchemy 的 使用</li>
<li>Flask-Script：为 Flask 程序提供了命令行模式</li>
<li>Flask-Migrate：数据库迁移工具</li>
<li>Flask-Login：封装用户会话管理</li>
</ul>
<p>其他功能性的扩展插件可选择安装，比如：</p>
<ul>
<li>flask-mail：用于管理邮件自动发送</li>
<li>Flask-babel：实现语言互相转换的翻译工具</li>
<li>Werkzeug： 计算密码散列值并进行核对</li>
<li>Flask-WTF： Web 表单</li>
</ul>
<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><p>初始目录结构如下图所示：</p>
<p><img src="https://cloud.githubusercontent.com/assets/22606175/23286448/9f0c3b46-fa72-11e6-87d7-b90f25452eec.jpg" alt="初始目录配置图"></p>
<ul>
<li>Flask 程序一般都保存在名为 app 的文件夹中</li>
<li>migrations 文件夹包含数据库迁移脚本</li>
<li>venv 文件夹包含 Python 虚拟环境</li>
<li>requirements.txt 列出了所有依赖包，便于项目迁移时重新生成相同的虚拟环境；</li>
<li>config.py 存储配置参数，如数据库账户密码等</li>
<li>manage.py 用于通过命令行启动程序的脚本</li>
</ul>
<h2 id="配置文件详解"><a href="#配置文件详解" class="headerlink" title="配置文件详解"></a>配置文件详解</h2><h3 id="config-py"><a href="#config-py" class="headerlink" title="config.py"></a>config.py</h3><p>config.py 是初始化 Flask app 的配置文件，主要包括多种模式下的配置类型和全局参数（如密钥、连接数据库的 URL） 等。此外需注意的是，敏感数据不能直接写入，应从操作系统的环境变量中读取。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">basedir = os.path.abspath(os.path.dirname(__file__))</span><br><span class="line"></span><br><span class="line">class Config:</span><br><span class="line">    def __init__(self):</span><br><span class="line">        pass</span><br><span class="line">    @staticmethod</span><br><span class="line">    def init_app(app):</span><br><span class="line">        pass</span><br><span class="line"></span><br><span class="line">class DevelopmentConfig(Config):</span><br><span class="line">    def __init__(self):</span><br><span class="line">        pass</span><br><span class="line">    DEBUG = True</span><br><span class="line">    SQLALCHEMY_DATABASE_URI = (os.environ.get(&apos;DEV_DATABASE_URL&apos;) or</span><br><span class="line">                               &apos;mysql://root:123456@localhost/lancs&apos;)</span><br><span class="line"></span><br><span class="line">class ProductionConfig(Config):</span><br><span class="line">    def __init__(self):</span><br><span class="line">        pass</span><br><span class="line">    SQLALCHEMY_DATABASE_URI = (os.environ.get(&apos;DEV_DATABASE_URL&apos;) or</span><br><span class="line">                               &apos;mysql://root:123456@localhost/lancs&apos;)</span><br><span class="line"></span><br><span class="line">config = &#123;</span><br><span class="line">    &apos;development&apos;: DevelopmentConfig,</span><br><span class="line">    &apos;production&apos;: ProductionConfig,</span><br><span class="line">    &apos;default&apos;: DevelopmentConfig</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="app-init-py"><a href="#app-init-py" class="headerlink" title="app/init.py"></a>app/init.py</h3><p>app/init.py 是程序包的构造文件，主要包括创建 flask app 的工厂函数。配置 Flask 扩展插件时往往在工厂函数中对 app 进行相关的初始化。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">from flask_sqlalchemy import SQLAlchemy</span><br><span class="line">from config import config</span><br><span class="line"></span><br><span class="line">db = SQLAlchemy()</span><br><span class="line"></span><br><span class="line">def create_app(config_name):</span><br><span class="line">    app = Flask(__name__)</span><br><span class="line">    app.config.from_object(config[config_name])</span><br><span class="line">    config[config_name].init_app(app)</span><br><span class="line"></span><br><span class="line">    db.init_app(app)</span><br><span class="line"></span><br><span class="line">    # Register all the filter.</span><br><span class="line">    from .main import main as main_blueprint</span><br><span class="line">    app.register_blueprint(main_blueprint)</span><br><span class="line"></span><br><span class="line">    return app</span><br></pre></td></tr></table></figure></p>
<h3 id="manage-py"><a href="#manage-py" class="headerlink" title="manage.py"></a>manage.py</h3><p>manage.py 是使用命令行启动服务进程、数据库迁移的脚本文件。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">from Lancs import create_app, db</span><br><span class="line">from flask_script import Manager</span><br><span class="line">from flask_migrate import Migrate, MigrateCommand</span><br><span class="line"></span><br><span class="line">app = create_app(os.getenv(&apos;LANCS_CONFIG&apos;) or &apos;default&apos;)</span><br><span class="line">manager = Manager(app)</span><br><span class="line">migrate = Migrate(app, db)</span><br><span class="line"></span><br><span class="line">manager.add_command(&apos;db&apos;, MigrateCommand)</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    manager.run()</span><br></pre></td></tr></table></figure></p>
<hr>
<ul>
<li><p><a href="/more/donate/index.html"><strong><em><font color="red">我觉得帮助到我了, 支持你一下.</font></em></strong></a><br>   </p>
</li>
<li><p><a href="https://www.paypal.me/momodainfo" target="_blank" rel="noopener"><strong><em><font color="red">If you think the article is helpful to you, you can reward me through paypal.</font></em></strong></a></p>
</li>
</ul>
<h3 id="Ads"><a href="#Ads" class="headerlink" title="Ads"></a>Ads</h3><p><em>这是小广告! 如果有需要, 不妨支持一下吧~</em></p>
<blockquote>
<p> <a target="_blank" href="https://amazon.cn/gp/search?ie=UTF8&tag=momoda-23&linkCode=ur2&linkId=4a0e4fbec0cfa8dfe540ca999d0bf999&camp=536&creative=3200&index=books&keywords=编程">这些好书您看了吗?</a><img src="//ir-cn.amazon-adsystem.com/e/ir?t=momoda-23&l=ur2&o=28" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p>
</blockquote>
<blockquote>
<p>体育&amp;户外用品推荐</p>
</blockquote>
<div align="center"> <a href="https://www.amazon.cn/B07HWB88Z5/dp/B07HWB88Z5/ref=as_sl_pc_tf_til?tag=momoda-23&linkCode=w00&linkId=14df5124f2165d9eb3d65252e60ed2cf&creativeASIN=B07HWB88Z5" target="_blank" rel="noopener"><img src="/se-notes/Flask-Web工程手册/ch2-Flask项目基本部署/../../../more/ads/amazon.gif" width="100%"></a> </div>

      
    </div><!-- .entry-content -->

    <footer class="entry-meta">
    <a href="/se-notes/Flask-Web工程手册/ch2-Flask项目基本部署/">
    <time datetime="2019-01-03T13:49:30.000Z" class="entry-date">
        1月 3 2019
    </time>
</a>
    
  <span class="article-delim">&#8226;</span>
  <div class="article-category">
  <a class="article-category-link" href="/categories/框架/">框架</a>, <a class="article-category-link" href="/categories/框架/python-web应用框架/">python-web应用框架</a>, <a class="article-category-link" href="/categories/框架/python-web应用框架/flask/">flask</a>
  </div>

    
  <span class="article-delim">&#8226;</span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web开发/">web开发</a></li></ul>

    </footer>
</article>






  
    <article id="post-se-notes/Flask-Web工程手册/ch3-Flask常用扩展插件" class="post-se-notes/Flask-Web工程手册/ch3-Flask常用扩展插件 post type-post status-publish format-standard hentry">
    <!---->

      <header class="entry-header">
        
        
  
    <h1 class="entry-title">
      <a class="article-title" href="/se-notes/Flask-Web工程手册/ch3-Flask常用扩展插件/">ch3-Flask常用扩展插件</a>
    </h1>
  

        
        <div class="comments-link">
            
            <a href="javascript:void(0);" data-url="https://wnhby.github.io/se-notes/Flask-Web工程手册/ch3-Flask常用扩展插件/" data-id="cjsbez08s002fczs6fx0vuh1l" class="leave-reply bdsharebuttonbox" data-cmd="more">分享</a>
        </div><!-- .comments-link -->
      </header><!-- .entry-header -->

    <div class="entry-content">
      
        <!-- TOC -->
<ul>
<li><a href="#flask-常用扩展插件">Flask 常用扩展插件</a><ul>
<li><a href="#flask-sqlalchemy">Flask-SQLAlchemy</a><ul>
<li><a href="#初始化应用">初始化应用</a></li>
<li><a href="#模型声明">模型声明</a></li>
</ul>
</li>
<li><a href="#flask-script-与-flask-migrate">Flask-Script 与 Flask-Migrate</a></li>
<li><a href="#mysql-python">MySQL-python</a><ul>
<li><a href="#参考文章">参考文章</a></li>
</ul>
</li>
<li><a href="#flask-login">Flask-Login</a><ul>
<li><a href="#初始化应用-1">初始化应用</a></li>
<li><a href="#相关配置">相关配置</a></li>
<li><a href="#使用方法">使用方法</a></li>
</ul>
</li>
<li><a href="#flask_babel">Flask_Babel</a><ul>
<li><a href="#初始化应用-2">初始化应用</a></li>
<li><a href="#配置参数">配置参数</a></li>
<li><a href="#生成翻译模板">生成翻译模板</a></li>
<li><a href="#创建翻译文本">创建翻译文本</a></li>
<li><a href="#编译">编译</a></li>
<li><a href="#修改翻译">修改翻译</a></li>
</ul>
</li>
<li><a href="#flask-mail">Flask-Mail</a><ul>
<li><a href="#初始化应用-3">初始化应用</a></li>
<li><a href="#参数配置">参数配置</a></li>
<li><a href="#发送邮件">发送邮件</a></li>
</ul>
</li>
<li><a href="#自定义模板过滤器">自定义模板过滤器</a></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h1 id="Flask-常用扩展插件"><a href="#Flask-常用扩展插件" class="headerlink" title="Flask 常用扩展插件"></a>Flask 常用扩展插件</h1><p>仅仅靠 Flask 基础库的功能是不够的，Flask 拥有多种扩展插件来实现各种模块化的功能。以下按照常用的配置目录，来介绍 Flask 中较为常见的功能插件。</p>
<h2 id="Flask-SQLAlchemy"><a href="#Flask-SQLAlchemy" class="headerlink" title="Flask-SQLAlchemy"></a>Flask-SQLAlchemy</h2><p>一个从模型到数据库的映射框架，在 Flask 中提供了模型以及数据库操作。</p>
<h3 id="初始化应用"><a href="#初始化应用" class="headerlink" title="初始化应用"></a>初始化应用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># app/init.py</span><br><span class="line">from flask import Flask</span><br><span class="line">from flask_sqlalchemy import SQLAlchemy</span><br><span class="line">from config import config</span><br><span class="line"></span><br><span class="line"># 由于是全局的实例，此后其他模块引入需SQLAlchemy时只需引入db即可</span><br><span class="line">db = SQLAlchemy() </span><br><span class="line"></span><br><span class="line">def create_app(config_name):</span><br><span class="line">    app = Flask(__name__)</span><br><span class="line">    app.config.from_object(config[config_name])</span><br><span class="line">    config[config_name].init_app(app)</span><br><span class="line"></span><br><span class="line">    db.init_app(app)</span><br></pre></td></tr></table></figure>
<h3 id="模型声明"><a href="#模型声明" class="headerlink" title="模型声明"></a>模型声明</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># app/models.py</span><br><span class="line">from . import db</span><br><span class="line"></span><br><span class="line">class User(db.Model):</span><br><span class="line">    __tablename__ = &apos;users&apos;   # 将创建的数据库的实际表名</span><br><span class="line">    id = db.Column(db.Integer, primary_key=True)</span><br><span class="line">    username = db.Column(db.String(80), unique=True)</span><br><span class="line">    email = db.Column(db.String(120), unique=True)</span><br><span class="line"></span><br><span class="line">    def __init__(self, username, email):</span><br><span class="line">        self.username = username</span><br><span class="line">        self.email = email</span><br></pre></td></tr></table></figure>
<p>详细的模型关系说明请看 <a href="https://github.com/xuelangZF/ehpc/wiki/Flask-sqlalchemy-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A3" target="_blank" rel="noopener">Flask sqlalchemy 数据库操作文档</a> 。</p>
<h2 id="Flask-Script-与-Flask-Migrate"><a href="#Flask-Script-与-Flask-Migrate" class="headerlink" title="Flask-Script 与 Flask-Migrate"></a>Flask-Script 与 Flask-Migrate</h2><p>Flask-Script 为 Flask 提供了可通过外部脚本使用命令行运行程序的功能，如启动服务、数据库迁移、在环境上下文中启动 shell 等。而 Flask-Migrate 用于进行数据库迁移。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># manage.py</span><br><span class="line"></span><br><span class="line">import os</span><br><span class="line">from app import app</span><br><span class="line">from flask_script import Manager</span><br><span class="line">from flask_migrate import Migrate, MigrateCommand</span><br><span class="line"></span><br><span class="line">manager = Manager(app)</span><br><span class="line">migrate = Migrate(app, db)</span><br><span class="line"></span><br><span class="line">manager.add_command(&apos;db&apos;, MigrateCommand)</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    manager.run()</span><br></pre></td></tr></table></figure></p>
<p>数据库迁移的命令主要包括：</p>
<ul>
<li>初始化迁移库：<code># python manage.py db init</code></li>
<li>创建迁移脚本：<code># python manage.py db migrate</code></li>
<li>更新数据库：<code># python manage.py db upgrade</code></li>
</ul>
<h2 id="MySQL-python"><a href="#MySQL-python" class="headerlink" title="MySQL-python"></a>MySQL-python</h2><p>MySQL-python 是 python 环境与 mysql 数据库的底层交互接口。作为一个必需库，在安装时经常会遇到安装失败的情况。因此一般是在 windows 开发环境下使用 exe 进行安装后再把库文件复制到已部署项目的虚拟环境中。</p>
<p>在 centos 系统中使用 pip 安装 MySQL-python 时遇到的一些问题的解决方法：</p>
<ol>
<li>执行<code>pip install mysql-python</code>时，报错 <code>EnvironmentError: mysql_config not found</code> ，解决方法为：<code>yum install mysql-devel</code></li>
<li>再次执行<code>pip install mysql-python</code>安装时，仍然报错<code>error: command &#39;gcc&#39; failed with exit status 1</code>， 解决方法：<code>yum install gcc python-devel</code></li>
</ol>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a href="http://www.cnblogs.com/yangxia-test/p/4691947.html" target="_blank" rel="noopener">centos下pip安装mysql_python</a></p>
<h2 id="Flask-Login"><a href="#Flask-Login" class="headerlink" title="Flask-Login"></a>Flask-Login</h2><p>Flask-Login 为 Flask 提供了会话管理。它处理日常的登入、登出并长期保留用户会话。</p>
<h3 id="初始化应用-1"><a href="#初始化应用-1" class="headerlink" title="初始化应用"></a>初始化应用</h3><p>Flask-Login 最重要的部分就是登录管理器类 LoginManager ，实例化后对应用进行初始化。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># app/init.py</span><br><span class="line"></span><br><span class="line">from flask_login import LoginManager</span><br><span class="line"></span><br><span class="line">login_manager = LoginManager()</span><br><span class="line">login_manager.init_app(app)</span><br><span class="line"></span><br><span class="line">#设置会话保护强度：None、&quot;basic&quot; 或 &quot;strong&quot;</span><br><span class="line">login_manager.session_protection = &apos;strong&apos;</span><br><span class="line">#设置登录视图</span><br><span class="line">login_manager.login_view = &apos;user.signin&apos;</span><br></pre></td></tr></table></figure></p>
<h3 id="相关配置"><a href="#相关配置" class="headerlink" title="相关配置"></a>相关配置</h3><p>需要设置一个 user_loader 回调函数，这个函数用于从会话中存储的用户 ID 重新加载用户对象（注意：如果 ID 无效，它应该返回 None，而不是抛出异常），如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@login_manager.user_loader</span><br><span class="line">def load_user(userid):</span><br><span class="line">    return User.get(userid)</span><br></pre></td></tr></table></figure></p>
<h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><p>当用户通过验证后，用 login_user 函数来登入他们：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&quot;/login&quot;, methods=[&quot;GET&quot;, &quot;POST&quot;])</span><br><span class="line">def login():</span><br><span class="line">    form = LoginForm()</span><br><span class="line">    if form.validate_on_submit():</span><br><span class="line">        # login and validate the user...</span><br><span class="line">        login_user(user)</span><br><span class="line">        flash(&quot;Logged in successfully.&quot;)</span><br><span class="line">        return redirect(request.args.get(&quot;next&quot;) or url_for(&quot;index&quot;))</span><br><span class="line">    return render_template(&quot;login.html&quot;, form=form)</span><br></pre></td></tr></table></figure></p>
<p>可以通过 current_user 代理访问当前会话中已登录的用户。但当用户未登录时，current_user 被设置为一个 AnonymousUser 对象，它包含下列属性： </p>
<ul>
<li>is_active 和 is_authenticated 返回 False </li>
<li>is_active 返回 True </li>
<li>get_id 返回 None。</li>
</ul>
<p>需要用户登入的视图可以用 login_required 装饰器来装饰，被 login_required 装饰器拦截的请求会跳转到登录视图。当重定向到登入视图，请求字符串中往往会额外设置一个 next 变量，值为用户之前试图访问的页面。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&quot;/settings&quot;)</span><br><span class="line">@login_required</span><br><span class="line">def settings():</span><br><span class="line">    pass</span><br></pre></td></tr></table></figure></p>
<p>当用户要登出时：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&quot;/logout&quot;)</span><br><span class="line">@login_required</span><br><span class="line">def logout():</span><br><span class="line">    logout_user()</span><br><span class="line">    return redirect(somewhere)</span><br></pre></td></tr></table></figure></p>
<h2 id="Flask-Babel"><a href="#Flask-Babel" class="headerlink" title="Flask_Babel"></a>Flask_Babel</h2><p>Flask_Babel 是 Flask 的翻译扩展工具，可配置指定文字的翻译文本。</p>
<h3 id="初始化应用-2"><a href="#初始化应用-2" class="headerlink" title="初始化应用"></a>初始化应用</h3><p>使用命令<code>$ pip install Flask-Babel</code>进行安装。</p>
<p>在完成 app 的基本配置初始化后，使用 Babel 对 app 进行初始化：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">from config import config</span><br><span class="line">from flask_babel import Babel</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config.from_object(config[config_name])</span><br><span class="line">babel = Babel(app)</span><br></pre></td></tr></table></figure></p>
<h3 id="配置参数"><a href="#配置参数" class="headerlink" title="配置参数"></a>配置参数</h3><p>首先在 app 的 config 中设置 Babel 的配置参数，分别代表翻译文本的默认语言以及其默认时区。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">BABEL_DEFAULT_LOCALE = &apos;zh&apos;</span><br><span class="line">BABEL_DEFAULT_TIMEZONE = &apos;CST&apos;</span><br></pre></td></tr></table></figure></p>
<p>在 app 目录下创建配置文件 babel.cfg，用于设置 babel 要从哪些位置搜索需翻译的字符串：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[python: **.py]</span><br><span class="line">[jinja2: **/templates/**.html]</span><br><span class="line">extensions=jinja2.ext.autoescape,jinja2.ext.with_</span><br></pre></td></tr></table></figure></p>
<h3 id="生成翻译模板"><a href="#生成翻译模板" class="headerlink" title="生成翻译模板"></a>生成翻译模板</h3><p>使用<code># pybabel extract -F babel.cfg -o messages.pot .</code>命令生成翻译模板<code>messages.pot</code>。该模板自动查找 babel.cfg 中所配置的区域中需要翻译的字符串。</p>
<h3 id="创建翻译文本"><a href="#创建翻译文本" class="headerlink" title="创建翻译文本"></a>创建翻译文本</h3><p>使用<code># pybabel init -i messages.pot -d translations -l zh</code>创建中文翻译。这句命令会在 app 主目录中生成一个 translations 目录。要确保 flask 能找到翻译内容，translations 目录要和 templates 目录在同一个目录中。接下来我们就可以进行翻译了，修改 <code>translations/zh_Hans_CN/LC_MESSAGES/messages.po</code>文件添加翻译文本。</p>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><p>翻译完后执行命令<code># pybabel compile -d translations</code>进行编译，编译结果为 message.mo 文件。编译成功后，即可在应用的网页上看到翻译后的文本。</p>
<h3 id="修改翻译"><a href="#修改翻译" class="headerlink" title="修改翻译"></a>修改翻译</h3><p>有时我们需要对程序和模板做修改，翻译也要随之更新。更新后需要用前面的命令重新生成 messages.pot 文件，然后使用命令<code># pybabel update -i messages.pot -d translations</code>将更新的内容 merge 到原来的翻译中，最后再到对应 locale 的文件夹下更新翻译并 compile 即可。</p>
<p>若只是修改翻译文本而未更改程序和模板，则只需修改 messages.po 文件里的文本后重新编译即可。</p>
<h2 id="Flask-Mail"><a href="#Flask-Mail" class="headerlink" title="Flask-Mail"></a>Flask-Mail</h2><p>Flask-Mail 用于自动发送邮件。</p>
<h3 id="初始化应用-3"><a href="#初始化应用-3" class="headerlink" title="初始化应用"></a>初始化应用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># app/init.py</span><br><span class="line">from flask_mail import Mail</span><br><span class="line"></span><br><span class="line">mail = Mail()</span><br><span class="line">mail.init_app(app)</span><br></pre></td></tr></table></figure>
<h3 id="参数配置"><a href="#参数配置" class="headerlink" title="参数配置"></a>参数配置</h3><p>可参考 <a href="http://www.pythondoc.com/flask-mail/index.html" target="_blank" rel="noopener">Flask-Mail 文档</a> 进行如下内置参数配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># config.py</span><br><span class="line"></span><br><span class="line"># If use QQ email, please see http://service.mail.qq.com/cgi-bin/help?id=28 firstly.</span><br><span class="line">MAIL_SERVER = &apos;smtp.sina.com&apos;</span><br><span class="line">MAIL_PORT = 465</span><br><span class="line">MAIL_USE_SSL = True</span><br><span class="line">MAIL_USERNAME = os.environ.get(&apos;MAIL_USERNAME&apos;) or &apos;milanlanlanlan@sina.com&apos;</span><br><span class="line">MAIL_PASSWORD = os.environ.get(&apos;MAIL_PASSWORD&apos;) or &apos;1970025901a&apos;</span><br></pre></td></tr></table></figure></p>
<p>除了设置参数以外，还应当确保邮件服务器可提供服务。</p>
<h3 id="发送邮件"><a href="#发送邮件" class="headerlink" title="发送邮件"></a>发送邮件</h3><p>为了能够发送邮件，首先需要创建一个 Message 实例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from flask_mail import Message</span><br><span class="line">@app.route(&quot;/&quot;)</span><br><span class="line">def index():</span><br><span class="line">    msg = Message(&quot;Hello&quot;,     # 此处构造函数的首个参数的值&quot;Hello&quot;是邮件标题</span><br><span class="line">                  sender=&quot;from@example.com&quot;,</span><br><span class="line">                  recipients=[&quot;to@example.com&quot;])</span><br></pre></td></tr></table></figure>
<p>可设置一个或者多个收件人:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msg.recipients = [&quot;you@example.com&quot;]</span><br><span class="line">msg.add_recipient(&quot;somebodyelse@example.com&quot;)</span><br></pre></td></tr></table></figure></p>
<p>若设置了 MAIL_DEFAULT_SENDER，就不必再次填写发件人，默认情况下将会使用配置项的发件人。</p>
<p>邮件内容可以直接包含 body 或者包含 HTML:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msg.body = &quot;testing&quot;</span><br><span class="line">msg.html = &quot;&lt;b&gt;testing&lt;/b&gt;&quot;</span><br></pre></td></tr></table></figure></p>
<p>最后，发送邮件的时候请使用 Flask 应用设置的 Mail 实例:<code>mail.send(msg)</code></p>
<h2 id="自定义模板过滤器"><a href="#自定义模板过滤器" class="headerlink" title="自定义模板过滤器"></a>自定义模板过滤器</h2><p>为了使视图层和控制层解耦，往往使用自定义的模板过滤器，而不是在控制层中增加逻辑。</p>
<p><code>`</code> </p>
<h1 id="app-util-init-py"><a href="#app-util-init-py" class="headerlink" title="app/util/init.py"></a>app/util/init.py</h1><p>from flask import Blueprint<br>filter_blueprint = Blueprint(‘filters’, <strong>name</strong>)</p>
<h1 id="Register-all-the-filter"><a href="#Register-all-the-filter" class="headerlink" title="Register all the filter."></a>Register all the filter.</h1><h1 id="往往不是把所有过滤器写入同一个文件中，而是分多个文件，然后在本文件中用-import-引用。"><a href="#往往不是把所有过滤器写入同一个文件中，而是分多个文件，然后在本文件中用-import-引用。" class="headerlink" title="往往不是把所有过滤器写入同一个文件中，而是分多个文件，然后在本文件中用 import 引用。"></a>往往不是把所有过滤器写入同一个文件中，而是分多个文件，然后在本文件中用 import 引用。</h1><p>@filter_blueprint.app_template_filter(‘reversel’)<br>def reverse_filter(s):<br>    return s[::-1]</p>
<hr>
<ul>
<li><p><a href="/more/donate/index.html"><strong><em><font color="red">我觉得帮助到我了, 支持你一下.</font></em></strong></a><br>   </p>
</li>
<li><p><a href="https://www.paypal.me/momodainfo" target="_blank" rel="noopener"><strong><em><font color="red">If you think the article is helpful to you, you can reward me through paypal.</font></em></strong></a></p>
</li>
</ul>
<h3 id="Ads"><a href="#Ads" class="headerlink" title="Ads"></a>Ads</h3><p><em>这是小广告! 如果有需要, 不妨支持一下吧~</em></p>
<blockquote>
<p> <a target="_blank" href="https://amazon.cn/gp/search?ie=UTF8&tag=momoda-23&linkCode=ur2&linkId=4a0e4fbec0cfa8dfe540ca999d0bf999&camp=536&creative=3200&index=books&keywords=编程">这些好书您看了吗?</a><img src="//ir-cn.amazon-adsystem.com/e/ir?t=momoda-23&l=ur2&o=28" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p>
</blockquote>
<blockquote>
<p>体育&amp;户外用品推荐</p>
</blockquote>
<div align="center"> <a href="https://www.amazon.cn/B07HWB88Z5/dp/B07HWB88Z5/ref=as_sl_pc_tf_til?tag=momoda-23&linkCode=w00&linkId=14df5124f2165d9eb3d65252e60ed2cf&creativeASIN=B07HWB88Z5" target="_blank" rel="noopener"><img src="/se-notes/Flask-Web工程手册/ch3-Flask常用扩展插件/../../../more/ads/amazon.gif" width="100%"></a> </div>
      
    </div><!-- .entry-content -->

    <footer class="entry-meta">
    <a href="/se-notes/Flask-Web工程手册/ch3-Flask常用扩展插件/">
    <time datetime="2019-01-03T13:49:30.000Z" class="entry-date">
        1月 3 2019
    </time>
</a>
    
  <span class="article-delim">&#8226;</span>
  <div class="article-category">
  <a class="article-category-link" href="/categories/框架/">框架</a>, <a class="article-category-link" href="/categories/框架/python-web应用框架/">python-web应用框架</a>, <a class="article-category-link" href="/categories/框架/python-web应用框架/flask/">flask</a>
  </div>

    
  <span class="article-delim">&#8226;</span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web开发/">web开发</a></li></ul>

    </footer>
</article>






  
    <article id="post-se-notes/Flask-Web工程手册/ch4-Linux服务器部署" class="post-se-notes/Flask-Web工程手册/ch4-Linux服务器部署 post type-post status-publish format-standard hentry">
    <!---->

      <header class="entry-header">
        
        
  
    <h1 class="entry-title">
      <a class="article-title" href="/se-notes/Flask-Web工程手册/ch4-Linux服务器部署/">ch4-Linux服务器部署</a>
    </h1>
  

        
        <div class="comments-link">
            
            <a href="javascript:void(0);" data-url="https://wnhby.github.io/se-notes/Flask-Web工程手册/ch4-Linux服务器部署/" data-id="cjsbez08u002gczs6pbjtckhr" class="leave-reply bdsharebuttonbox" data-cmd="more">分享</a>
        </div><!-- .comments-link -->
      </header><!-- .entry-header -->

    <div class="entry-content">
      
        <!-- TOC -->
<ul>
<li><a href="#linux服务器部署">Linux服务器部署</a><ul>
<li><a href="#初始化服务器">初始化服务器</a></li>
<li><a href="#安装mysql">安装MySQL</a><ul>
<li><a href="#导出数据库sql脚本">导出数据库（sql脚本）</a></li>
<li><a href="#导入数据库sql脚本">导入数据库（sql脚本）</a></li>
<li><a href="#参考文章">参考文章</a></li>
<li><a href="#在-centos-上安装-mysql-python">在 CentOS 上安装 mysql-python</a></li>
</ul>
</li>
<li><a href="#设置远程访问-mysql">设置远程访问 MySQL</a></li>
<li><a href="#安装-virtualenv">安装 virtualenv</a><ul>
<li><a href="#参考文章-1">参考文章</a></li>
</ul>
</li>
<li><a href="#开放端口">开放端口</a></li>
<li><a href="#使用-supervisor-维护服务进程">使用 supervisor 维护服务进程</a></li>
<li><a href="#使用-gunicorn-作为-web-服务器">使用 gunicorn 作为 Web 服务器</a><ul>
<li><a href="#gevent">gevent</a></li>
<li><a href="#ads">Ads</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h1 id="Linux服务器部署"><a href="#Linux服务器部署" class="headerlink" title="Linux服务器部署"></a>Linux服务器部署</h1><h2 id="初始化服务器"><a href="#初始化服务器" class="headerlink" title="初始化服务器"></a>初始化服务器</h2><p>首先需安装 Linux 操作系统并对其进行初始化配置。具体步骤请参见该文章：<a href="https://github.com/Zouzhp3/Learn/blob/master/Cloud/%E9%85%8D%E7%BD%AE%E8%99%9A%E6%8B%9F%E4%BA%91%E4%B8%BB%E6%9C%BA%28CentOS%29.md" target="_blank" rel="noopener">配置虚拟云主机(CentOS 7)</a></p>
<p>此外，最好不要用 root 账户直接进行操作，应当设置一个拥有 sudo 权限的新用户，使用该用户进行服务器的操作。</p>
<p><a href="http://www.cnblogs.com/woshimrf/p/5906084.html" target="_blank" rel="noopener">教程：添加一个新用户并授权</a></p>
<h2 id="安装MySQL"><a href="#安装MySQL" class="headerlink" title="安装MySQL"></a>安装MySQL</h2><p>在 CentOS 7和 CentOS 7.1系统中，默认安装的 mysql 是它的分支 mariadb ，因此需要从 mysql 的官网中下载。</p>
<ol>
<li>下载 Yum Repo：<br>从 <a href="http://dev.mysql.com/downloads/repo/yum/" target="_blank" rel="noopener">mysql官方下载地址</a> 获取 Yum Repo，并使用<code>yum install</code>命令进行安装该 Repo：<code># yum -y install mysql57-community-release-el7-7.noarch.rpm</code>。完成后可以用<code># yum list | grep mysql</code>来查看可安装的 mysql 包。</li>
<li>安装 MySQL 数据库的服务器版本：<br><code># yum install mysql-community-server</code></li>
<li>启动服务：<br><code># service mysqld start</code>，并可用<code># service mysqld status</code>查看服务状态。</li>
<li>获取初始密码：<br>使用YUM安装并启动MySQL服务后，MySQL进程会自动在进程日志中打印 root 用户的初始密码。使用<code>grep &quot;password&quot; /var/log/mysqld.log</code>可查看日志中的MySQL root 密码。</li>
<li>修改root用户密码：<br>使用<code># mysql -uroot -p</code>并输入密码后进入 mysql 终端，再使用<code>mysql&gt; ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;new password&#39;;</code>命令修改 mysql 的密码。</li>
</ol>
<p>注意：如果装的 mysql 版本是5.7，则可能出现修改密码时报错<code>ERROR 1819 (HY000): Your password does not satisfy the current policy requirements</code>，这是因为新密码安全性较低。可使用<code>mysql&gt; set global validate_password_policy=0;</code>降低密码安全等级后解决。</p>
<p>mariadb 是 mysql 的一个分支版本，与 mysql 不能同时安装，但是接口与 mysql 完全兼容。当数据库需要迁移到 mariadb 时，可能会出现<code>ImportError: libmysqlclient.so.18</code>的错误，解决方法为’pip install mysql-client’（这里很奇怪，如果是 mysql 数据库的话不用安装 mysql-client 也可以）。</p>
<h3 id="导出数据库（sql脚本）"><a href="#导出数据库（sql脚本）" class="headerlink" title="导出数据库（sql脚本）"></a>导出数据库（sql脚本）</h3><p><code>mysqldump -u 用户名 -p 数据库名 &gt; 导出的文件名</code></p>
<p>例如：<code>mysqldump -u root -p db_name &gt; test_db.sql</code></p>
<h3 id="导入数据库（sql脚本）"><a href="#导入数据库（sql脚本）" class="headerlink" title="导入数据库（sql脚本）"></a>导入数据库（sql脚本）</h3><p>使用<code>mysql -u root -p</code>命令进入 MySQL 后：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use test;</span><br><span class="line">mysql&gt; source c:/test.sql</span><br></pre></td></tr></table></figure></p>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a href="https://typecodes.com/linux/yuminstallmysql5710.html" target="_blank" rel="noopener">CentOS 7.2使用yum安装MYSQL 5.7.10</a></p>
<p><a href="https://typecodes.com/web/centos7yuminstallmysql5.html" target="_blank" rel="noopener">阿里云CentOS 7.1使用yum安装MySql 5.6.24</a></p>
<p><a href="http://bbs.bestsdk.com/detail/762.html" target="_blank" rel="noopener">修改MySQL 5.7.9版本的root密码方法以及一些新变化整理</a> </p>
<h3 id="在-CentOS-上安装-mysql-python"><a href="#在-CentOS-上安装-mysql-python" class="headerlink" title="在 CentOS 上安装 mysql-python"></a>在 CentOS 上安装 mysql-python</h3><p>在 CentOS 下用<code>pip install mysql-python</code>命令直接安装时会出现找不到<code>mysql_config</code>、<code>gcc</code>等错误，解决方案是安装mysql(或mariadb)的devel包(如mysql-devel或mariadb-devel)，以及安装python的devel包。</p>
<h2 id="设置远程访问-MySQL"><a href="#设置远程访问-MySQL" class="headerlink" title="设置远程访问 MySQL"></a>设置远程访问 MySQL</h2><p>linux 上的 mysql 数据库都是默认仅允许本地访问。设置 mysql 为远程访问，可以供开发者在本地使用数据库可视化工具远程连接而不用通过 ssh。</p>
<p>在shell中，$mysql -r -u root -p 输入密码后进入 mysql 数据库。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;use mysql;</span><br><span class="line">mysql&gt;update user set host = &apos;%&apos; where user = &apos;root&apos;;    //这个命令执行错误时可略过</span><br><span class="line">mysql&gt;flush privileges;</span><br><span class="line">mysql&gt;select host, user from user; //检查‘%’ 是否插入到数据库中</span><br></pre></td></tr></table></figure>
<p>找到文件/etc/mysql/my.cnf 修改 bind-address = 0.0.0.0 之后，重启 mysql 进程：<code>$service mysqld restart</code>。</p>
<h2 id="安装-virtualenv"><a href="#安装-virtualenv" class="headerlink" title="安装 virtualenv"></a>安装 virtualenv</h2><p>首先需安装 python-pip ，若提示没有包可安装，则使用命令<code># yum -y install epel-release</code>安装扩展仓库后再使用 yum 进行安装。使用 pip 安装 virtualenv：<code># pip install virtualenv</code>。</p>
<p>使用virtualenv命令创建python虚拟环境：<code># virtualenv [虚拟环境名称]</code>，之后在本地会生成一个与虚拟环境同名的文件夹。默认情况下虚拟环境不会依赖系统环境的global site-packages，如果想依赖系统环境的第三方软件包，也可以使用参数–system-site-packages。</p>
<p>进入虚拟环境目录，启动虚拟环境，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cd env1/</span><br><span class="line">[root@localhost env1]# source bin/activate</span><br><span class="line">(env1)[root@localhost env1]# python -V</span><br><span class="line">Python 2.7.8</span><br></pre></td></tr></table></figure></p>
<p>部署服务时，可直接把开发者 windows 本地的虚拟环境下的 /Lib/site-packages 复制到 Linux 系统里的虚拟环境中，有些出于 python 版本不同导致的兼容问题可通过重新下载库来解决。</p>
<h3 id="参考文章-1"><a href="#参考文章-1" class="headerlink" title="参考文章"></a>参考文章</h3><p><a href="http://qicheng0211.blog.51cto.com/3958621/1561685" target="_blank" rel="noopener">使用 virtualenv 搭建独立的 Python 环境</a></p>
<h2 id="开放端口"><a href="#开放端口" class="headerlink" title="开放端口"></a>开放端口</h2><p>如果系统的防火墙开启，则需要设置防火墙开放端口。若没有启动防火墙服务，则默认开放所有端口。</p>
<p>当使用脚本启动 flask 服务时可以指定 Host 和 端口：<code># python manage.py runserver -h 0.0.0.0 -p 80</code>（使用80端口时需要 root 权限）</p>
<h2 id="使用-supervisor-维护服务进程"><a href="#使用-supervisor-维护服务进程" class="headerlink" title="使用 supervisor 维护服务进程"></a>使用 supervisor 维护服务进程</h2><p>supervisor 是用 Python 开发的一套通用的 Linux 进程管理程序，能将一个普通的命令行进程变为后台 daemon，并监控进程状态，使其异常退出时能自动重启。</p>
<p>首先使用<code># yum install supervisor</code>命令安装 supervisor 。查看配置文件<code>/etc/supervisord.conf</code>，检查项 [include] 里的应用配置文件应放置在哪个目录，然后在指定目录下新建应用配置文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[program:app]                                         # app 为具体用户名</span><br><span class="line">command=python manage.py runserver -h 0.0.0.0 -p 5000 # 启动命令，与手动启动命令一样</span><br><span class="line">directory=/home/netlab301/lancs                       # 程序的启动目录</span><br><span class="line">user=root                                             # 启动命令所使用的用户身份</span><br></pre></td></tr></table></figure></p>
<p>启动 supervisor 即可：<code>supervisord -c /etc/supervisord.conf</code></p>
<p>常用命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ps -aux | grep python  # 查看进程</span><br><span class="line">ps -aux | grep 5000    # 查看占用某端口的进程</span><br><span class="line"></span><br><span class="line">supervisorctl status         # 监控状态</span><br><span class="line">supervisorctl stop app       # 停止 app</span><br><span class="line">supervisorctl start app      # 启动 app （往往需要先启动 virtualenv 虚拟环境）</span><br><span class="line">supervisorctl restart app    # 重启 app</span><br></pre></td></tr></table></figure></p>
<p>由于 supervisor 往往需要与虚拟环境同时使用，因此 supervisor 脚本中的 python 命令可以用虚拟环境中的 python 命令替代（如：<code>/home/ehpcadmin/venv/bin/python manage.py runserver</code>）</p>
<h2 id="使用-gunicorn-作为-Web-服务器"><a href="#使用-gunicorn-作为-Web-服务器" class="headerlink" title="使用 gunicorn 作为 Web 服务器"></a>使用 gunicorn 作为 Web 服务器</h2><p>由于 Flask 自带的服务器（通过<code>runserver</code>命令启动）性能差且无法支持并发请求，因此需要使用 gunicorn 作为服务器（或其他 web 服务器）来提供更好的性能。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Gunicorn &apos;Green Unicorn&apos; is a Python WSGI HTTP Server for UNIX. It&apos;s a pre-fork worker model. The Gunicorn server is broadly compatible with various web frameworks, simply implemented, light on server resources, and fairly speedy.</span><br></pre></td></tr></table></figure>
<p>安装 gunicorn：<code>pip install gunicorn</code></p>
<p>启动 gunicorn 服务器：<code>gunicron -w4 -b0.0.0.0:8000 myapp:app</code>，其中 -w 表示开启多少个 worker，-b 表示 gunicorn 开放的访问地址。想要结束 gunicorn 只需执行<code>pkill gunicorn</code>。</p>
<p><a href="http://docs.gunicorn.org/en/stable/run.html" target="_blank" rel="noopener">Gunicorn 官方文档</a></p>
<h3 id="gevent"><a href="#gevent" class="headerlink" title="gevent"></a>gevent</h3><p>gevent 是第三方库，可通过 greenlet 实现协程，其基本思想是：当一个 greenlet 遇到 IO 操作时，比如访问网络，就自动切换到其他的 greenlet，等到 IO 操作完成，再在适当的时候切换回来继续执行。由于 IO 操作非常耗时，经常使程序处于等待状态，有了 gevent 为我们自动切换协程，就保证总有 greenlet 在运行，而不是等待 IO。</p>
<p>因此结合 gunicorn 启动服务的命令可设置为：<code>gunicorn manage:app -b 0.0.0.0:8080 -w 4 --worker-class gevent</code>（此命令可写入 supervisor 的应用配置文件中）</p>
<hr>
<ul>
<li><p><a href="/more/donate/index.html"><strong><em><font color="red">我觉得帮助到我了, 支持你一下.</font></em></strong></a><br>   </p>
</li>
<li><p><a href="https://www.paypal.me/momodainfo" target="_blank" rel="noopener"><strong><em><font color="red">If you think the article is helpful to you, you can reward me through paypal.</font></em></strong></a></p>
</li>
</ul>
<h3 id="Ads"><a href="#Ads" class="headerlink" title="Ads"></a>Ads</h3><p><em>这是小广告! 如果有需要, 不妨支持一下吧~</em></p>
<blockquote>
<p> <a target="_blank" href="https://amazon.cn/gp/search?ie=UTF8&tag=momoda-23&linkCode=ur2&linkId=4a0e4fbec0cfa8dfe540ca999d0bf999&camp=536&creative=3200&index=books&keywords=编程">这些好书您看了吗?</a><img src="//ir-cn.amazon-adsystem.com/e/ir?t=momoda-23&l=ur2&o=28" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p>
</blockquote>
<blockquote>
<p>体育&amp;户外用品推荐</p>
</blockquote>
<div align="center"> <a href="https://www.amazon.cn/B07HWB88Z5/dp/B07HWB88Z5/ref=as_sl_pc_tf_til?tag=momoda-23&linkCode=w00&linkId=14df5124f2165d9eb3d65252e60ed2cf&creativeASIN=B07HWB88Z5" target="_blank" rel="noopener"><img src="/se-notes/Flask-Web工程手册/ch4-Linux服务器部署/../../../more/ads/amazon.gif" width="100%"></a> </div>
      
    </div><!-- .entry-content -->

    <footer class="entry-meta">
    <a href="/se-notes/Flask-Web工程手册/ch4-Linux服务器部署/">
    <time datetime="2019-01-03T13:49:30.000Z" class="entry-date">
        1月 3 2019
    </time>
</a>
    
  <span class="article-delim">&#8226;</span>
  <div class="article-category">
  <a class="article-category-link" href="/categories/框架/">框架</a>, <a class="article-category-link" href="/categories/框架/python-web应用框架/">python-web应用框架</a>, <a class="article-category-link" href="/categories/框架/python-web应用框架/flask/">flask</a>
  </div>

    
  <span class="article-delim">&#8226;</span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web开发/">web开发</a></li></ul>

    </footer>
</article>






  
    <article id="post-se-notes/Flask-Web工程手册/ch5-使用lsyncd进行文件实时备份" class="post-se-notes/Flask-Web工程手册/ch5-使用lsyncd进行文件实时备份 post type-post status-publish format-standard hentry">
    <!---->

      <header class="entry-header">
        
        
  
    <h1 class="entry-title">
      <a class="article-title" href="/se-notes/Flask-Web工程手册/ch5-使用lsyncd进行文件实时备份/">ch5-使用lsyncd进行文件实时备份</a>
    </h1>
  

        
        <div class="comments-link">
            
            <a href="javascript:void(0);" data-url="https://wnhby.github.io/se-notes/Flask-Web工程手册/ch5-使用lsyncd进行文件实时备份/" data-id="cjsbez08x002jczs6shckfy5m" class="leave-reply bdsharebuttonbox" data-cmd="more">分享</a>
        </div><!-- .comments-link -->
      </header><!-- .entry-header -->

    <div class="entry-content">
      
        <!-- TOC -->
<ul>
<li><a href="#安装">安装</a><ul>
<li><a href="#ubuntu-环境">Ubuntu 环境</a></li>
<li><a href="#centos-环境">CentOS 环境</a></li>
</ul>
</li>
<li><a href="#配置">配置</a><ul>
<li><a href="#配置选项说明">配置选项说明</a></li>
<li><a href="#启动-lsyncd">启动 lsyncd</a></li>
</ul>
</li>
<li><a href="#ssh-密钥配置">SSH 密钥配置</a><ul>
<li><a href="#备份服务器操作">备份服务器操作</a></li>
<li><a href="#主服务器操作">主服务器操作</a></li>
</ul>
</li>
<li><a href="#配置文件模式示例">配置文件模式示例</a></li>
<li><a href="#参考文档">参考文档</a><ul>
<li><a href="#ads">Ads</a></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<p>Lysncd 实际上是 lua 语言封装了 inotify 和 rsync 工具，采用了 Linux 内核（2.6.13 及以后）里的 inotify 触发机制，然后通过 rsync 去差异同步，达到实时的效果。它完美解决了 inotify + rsync 海量文件同步带来的文件频繁发送文件列表的问题 —— 通过时间延迟或累计触发事件次数实现。</p>
<p>另外，它的配置方式很简单，lua 本身就是一种配置语言，可读性非常强。lsyncd 也有多种工作模式可以选择（本地目录 cp，本地目录 rsync，远程目录 rsyncssh）。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="Ubuntu-环境"><a href="#Ubuntu-环境" class="headerlink" title="Ubuntu 环境"></a>Ubuntu 环境</h3><p>已经收录在 ubuntu 的官方镜像源里，直接通过<code>apt-get install lsyncd</code>命令安装。</p>
<h3 id="CentOS-环境"><a href="#CentOS-环境" class="headerlink" title="CentOS 环境"></a>CentOS 环境</h3><p>安装了 epel-release 扩展源后，通过<code>yum install lsyncd</code>命令安装。</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>lsyncd 安装完后默认并没有提供配置文件，因此需要我们自行创建。配置文件 lsyncd.conf 的一个示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># cd /usr/local/lsyncd-2.1.5</span><br><span class="line"># mkdir etc var</span><br><span class="line"># vi etc/lsyncd.conf</span><br><span class="line"></span><br><span class="line">settings &#123;</span><br><span class="line">    logfile = &quot;/home/ubuntu/Desktop/lsyncd.log&quot;,</span><br><span class="line">    statusFile = &quot;/home/ubuntu/Desktop/lsyncd.status&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sync &#123;</span><br><span class="line">    default.rsyncssh,</span><br><span class="line">    source = &quot;/home/ubuntu/Desktop/src&quot;,</span><br><span class="line">    host = &quot;192.168.10.133&quot;,</span><br><span class="line">    targetdir = &quot;/home/ubuntu/Desktop/dst&quot;,</span><br><span class="line">    delay = 15</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="配置选项说明"><a href="#配置选项说明" class="headerlink" title="配置选项说明"></a>配置选项说明</h3><p><strong>settings</strong>里是全局设置，<code>--</code>开头表示注释，下面是几个常用选项说明：</p>
<ul>
<li><code>logfile</code> ：设置日志文件</li>
<li><code>stausFile</code> ：设置状态文件</li>
<li><code>statusInterval</code> ：将 lsyncd 的状态写入上面的statusFile的间隔，默认10秒</li>
<li><code>inotifyMode</code> ：指定inotify监控的事件，默认是<code>CloseWrite</code>，还可以是<code>Modify</code>或<code>CloseWrite or Modify</code></li>
<li><code>maxProcesses</code> ：同步进程的最大个数。假如同时有20个文件需要同步，而<code>maxProcesses = 8</code>，则最大能看到有8个rysnc进程</li>
<li><code>maxDelays</code> ：累计到多少所监控的事件激活一次同步，即使后面的<code>delay</code>延迟时间还未到</li>
</ul>
<p><strong>sync</strong>里是定义同步参数。</p>
<p>一般第一个参数指定 lsyncd serv以什么模式运行：<strong>rsync</strong>、<strong>rsyncssh</strong>、<strong>direct</strong> 三种模式：</p>
<ul>
<li><code>default.rsync</code> ：<strong>本地目录间同步</strong>。使用 rsync 也可以达到使用 ssh 形式的远程 rsync 效果<br><code>default.direct</code> ：<strong>本地目录间同步</strong>，使用 cp、rm 等命令完成差异文件备份<br><code>default.rsyncssh</code> ：<strong>同步到远程主机目录</strong>，rsync 的 ssh 模式，需要使用 key 来认证</li>
<li><code>source</code> ：同步的源目录，使用绝对路径。</li>
<li><code>target</code> ：同步的目的目录，在不同模式下有不同的写法。</li>
<li><code>init</code> ：当<code>init=false</code>时表示跳过初始同步，启动时即使原目录有差异时也不会同步。默认值为<code>true</code>。</li>
<li><code>delay</code> ：等待同步的延时，默认15s，即每15s同步一次。</li>
<li><code>excludeFrom</code>： 排除选项，后面指定排除的列表文件.</li>
</ul>
<p>更多参数设置可以在参考文档中查看。</p>
<h3 id="启动-lsyncd"><a href="#启动-lsyncd" class="headerlink" title="启动 lsyncd"></a>启动 lsyncd</h3><p>使用命令加载配置文件启动：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsyncd -log Exec [CONFIG-FILE]</span><br></pre></td></tr></table></figure>
<p>[CONFIG-FILE]为配置文件所在路径。</p>
<blockquote>
<p>更加详细的说明可以通过<code>lsyncd -help</code>查看。</p>
</blockquote>
<h2 id="SSH-密钥配置"><a href="#SSH-密钥配置" class="headerlink" title="SSH 密钥配置"></a>SSH 密钥配置</h2><p>为了让<code>lysncd</code>能够以 rsyncssh 模式进行工作，我们还需要对备份服务器进行一些配置。</p>
<blockquote>
<p>主服务器是指需要被备份的服务器，备份服务器是指用来实现主服务器备份的服务器。</p>
</blockquote>
<h3 id="备份服务器操作"><a href="#备份服务器操作" class="headerlink" title="备份服务器操作"></a>备份服务器操作</h3><p>在备份服务器中创建一个密钥对，直接回车即可，然后设置为<code>authorized_keys</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br><span class="line">cd ~/.ssh</span><br><span class="line">cat id_rsa.pub &gt;&gt; authorized_keys</span><br></pre></td></tr></table></figure>
<p>然后检查备份服务器有没有安装<code>openssh-server</code>，没有的话需要安装。</p>
<h3 id="主服务器操作"><a href="#主服务器操作" class="headerlink" title="主服务器操作"></a>主服务器操作</h3><p>将备份服务器中生成的私钥<code>id_rsa</code>拷贝到主服务器的<code>~/.ssh/</code>里面。然后设置好权限，并且测试是否能够正常登陆。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod 600 ~/.ssh/id_rsa</span><br><span class="line">ssh [USER]@[REMOTE_IP]</span><br></pre></td></tr></table></figure>
<p>[USER]和[REMOTE_IP]为登陆的用户和备份服务器的IP。如果能成功登陆的话则表示配置成功。</p>
<blockquote>
<p>也可以在主服务器中生成一对密钥，把公钥拷贝到备份服务器的<code>~/.ssh/authorized_keys</code>中。</p>
</blockquote>
<h2 id="配置文件模式示例"><a href="#配置文件模式示例" class="headerlink" title="配置文件模式示例"></a>配置文件模式示例</h2><p>下面的内容几乎涵盖了所有同步的模式。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">settings &#123;</span><br><span class="line">    logfile =&quot;/usr/local/lsyncd-2.1.5/var/lsyncd.log&quot;,</span><br><span class="line">    statusFile =&quot;/usr/local/lsyncd-2.1.5/var/lsyncd.status&quot;,</span><br><span class="line">    inotifyMode = &quot;CloseWrite&quot;,</span><br><span class="line">    maxProcesses = 8,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- I. 本地目录同步，direct：cp/rm/mv。 适用：500+万文件，变动不大</span><br><span class="line">sync &#123;</span><br><span class="line">    default.direct,</span><br><span class="line">    source    = &quot;/tmp/src&quot;,</span><br><span class="line">    target    = &quot;/tmp/dest&quot;,</span><br><span class="line">    delay = 1</span><br><span class="line">    maxProcesses = 1</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">-- II. 本地目录同步，rsync模式：rsync</span><br><span class="line">sync &#123;</span><br><span class="line">    default.rsync,</span><br><span class="line">    source    = &quot;/tmp/src&quot;,</span><br><span class="line">    target    = &quot;/tmp/dest1&quot;,</span><br><span class="line">    excludeFrom = &quot;/etc/rsyncd.d/rsync_exclude.lst&quot;,</span><br><span class="line">    rsync     = &#123;</span><br><span class="line">        binary = &quot;/usr/bin/rsync&quot;,</span><br><span class="line">        archive = true,</span><br><span class="line">        compress = true,</span><br><span class="line">        bwlimit   = 2000</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">-- III. 远程目录同步，rsync模式 + rsyncd daemon</span><br><span class="line">sync &#123;</span><br><span class="line">    default.rsync,</span><br><span class="line">    source    = &quot;/tmp/src&quot;,</span><br><span class="line">    target    = &quot;syncuser@172.29.88.223::module1&quot;,</span><br><span class="line">    delete=&quot;running&quot;,</span><br><span class="line">    exclude = &#123; &quot;.*&quot;, &quot;.tmp&quot; &#125;,</span><br><span class="line">    delay = 30,</span><br><span class="line">    init = false,</span><br><span class="line">    rsync     = &#123;</span><br><span class="line">        binary = &quot;/usr/bin/rsync&quot;,</span><br><span class="line">        archive = true,</span><br><span class="line">        compress = true,</span><br><span class="line">        verbose   = true,</span><br><span class="line">        password_file = &quot;/etc/rsyncd.d/rsync.pwd&quot;,</span><br><span class="line">        _extra    = &#123;&quot;--bwlimit=200&quot;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">-- IV. 远程目录同步，rsync模式 + ssh shell</span><br><span class="line">sync &#123;</span><br><span class="line">    default.rsync,</span><br><span class="line">    source    = &quot;/tmp/src&quot;,</span><br><span class="line">    target    = &quot;172.29.88.223:/tmp/dest&quot;,</span><br><span class="line">    -- target    = &quot;root@172.29.88.223:/remote/dest&quot;,</span><br><span class="line">    -- 上面target，注意如果是普通用户，必须拥有写权限</span><br><span class="line">    maxDelays = 5,</span><br><span class="line">    delay = 30,</span><br><span class="line">    -- init = true,</span><br><span class="line">    rsync     = &#123;</span><br><span class="line">        binary = &quot;/usr/bin/rsync&quot;,</span><br><span class="line">        archive = true,</span><br><span class="line">        compress = true,</span><br><span class="line">        bwlimit   = 2000</span><br><span class="line">        -- rsh = &quot;/usr/bin/ssh -p 22 -o StrictHostKeyChecking=no&quot;</span><br><span class="line">        -- 如果要指定其它端口，请用上面的rsh</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">-- V. 远程目录同步，rsync模式 + rsyncssh，效果与上面相同</span><br><span class="line">sync &#123;</span><br><span class="line">    default.rsyncssh,</span><br><span class="line">    source    = &quot;/tmp/src2&quot;,</span><br><span class="line">    host      = &quot;172.29.88.223&quot;,</span><br><span class="line">    targetdir = &quot;/remote/dir&quot;,</span><br><span class="line">    excludeFrom = &quot;/etc/rsyncd.d/rsync_exclude.lst&quot;,</span><br><span class="line">    -- maxDelays = 5,</span><br><span class="line">    delay = 0,</span><br><span class="line">    -- init = false,</span><br><span class="line">    rsync    = &#123;</span><br><span class="line">        binary = &quot;/usr/bin/rsync&quot;,</span><br><span class="line">        archive = true,</span><br><span class="line">        compress = true,</span><br><span class="line">        verbose   = true,</span><br><span class="line">        _extra = &#123;&quot;--bwlimit=2000&quot;&#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    ssh      = &#123;</span><br><span class="line">        port  =  1234</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a href="https://axkibe.github.io/lsyncd/manual/config/layer4/" target="_blank" rel="noopener">Config Layer 4: Default Config</a></p>
<p><a href="http://clavinli.github.io/2013/11/12/linux-server-lsyncd/" target="_blank" rel="noopener">Lsyncd | 使用lsyncd同步文件目录</a>    </p>
<p><a href="http://seanlook.com/2015/05/06/lsyncd-synchronize-realtime/" target="_blank" rel="noopener">lsyncd实时同步搭建指南——取代rsync+inotify</a></p>
<hr>
<ul>
<li><p><a href="/more/donate/index.html"><strong><em><font color="red">我觉得帮助到我了, 支持你一下.</font></em></strong></a><br>   </p>
</li>
<li><p><a href="https://www.paypal.me/momodainfo" target="_blank" rel="noopener"><strong><em><font color="red">If you think the article is helpful to you, you can reward me through paypal.</font></em></strong></a></p>
</li>
</ul>
<h3 id="Ads"><a href="#Ads" class="headerlink" title="Ads"></a>Ads</h3><p><em>这是小广告! 如果有需要, 不妨支持一下吧~</em></p>
<blockquote>
<p> <a target="_blank" href="https://amazon.cn/gp/search?ie=UTF8&tag=momoda-23&linkCode=ur2&linkId=4a0e4fbec0cfa8dfe540ca999d0bf999&camp=536&creative=3200&index=books&keywords=编程">这些好书您看了吗?</a><img src="//ir-cn.amazon-adsystem.com/e/ir?t=momoda-23&l=ur2&o=28" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p>
</blockquote>
<blockquote>
<p>体育&amp;户外用品推荐</p>
</blockquote>
<div align="center"> <a href="https://www.amazon.cn/B07HWB88Z5/dp/B07HWB88Z5/ref=as_sl_pc_tf_til?tag=momoda-23&linkCode=w00&linkId=14df5124f2165d9eb3d65252e60ed2cf&creativeASIN=B07HWB88Z5" target="_blank" rel="noopener"><img src="/se-notes/Flask-Web工程手册/ch5-使用lsyncd进行文件实时备份/../../../more/ads/amazon.gif" width="100%"></a> </div>
      
    </div><!-- .entry-content -->

    <footer class="entry-meta">
    <a href="/se-notes/Flask-Web工程手册/ch5-使用lsyncd进行文件实时备份/">
    <time datetime="2019-01-03T13:49:30.000Z" class="entry-date">
        1月 3 2019
    </time>
</a>
    
  <span class="article-delim">&#8226;</span>
  <div class="article-category">
  <a class="article-category-link" href="/categories/框架/">框架</a>, <a class="article-category-link" href="/categories/框架/python-web应用框架/">python-web应用框架</a>, <a class="article-category-link" href="/categories/框架/python-web应用框架/flask/">flask</a>
  </div>

    
  <span class="article-delim">&#8226;</span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web开发/">web开发</a></li></ul>

    </footer>
</article>






  
    <article id="post-se-notes/Flask-Web工程手册/ch6-配置集群共享文件NFS服务器" class="post-se-notes/Flask-Web工程手册/ch6-配置集群共享文件NFS服务器 post type-post status-publish format-standard hentry">
    <!---->

      <header class="entry-header">
        
        
  
    <h1 class="entry-title">
      <a class="article-title" href="/se-notes/Flask-Web工程手册/ch6-配置集群共享文件NFS服务器/">ch6-配置集群共享文件NFS服务器</a>
    </h1>
  

        
        <div class="comments-link">
            
            <a href="javascript:void(0);" data-url="https://wnhby.github.io/se-notes/Flask-Web工程手册/ch6-配置集群共享文件NFS服务器/" data-id="cjsbez08z002kczs65y70x9wu" class="leave-reply bdsharebuttonbox" data-cmd="more">分享</a>
        </div><!-- .comments-link -->
      </header><!-- .entry-header -->

    <div class="entry-content">
      
        <!-- TOC -->
<ul>
<li><a href="#配置集群共享文件-nfs-服务器">配置集群共享文件 NFS 服务器</a><ul>
<li><a href="#简介">简介</a></li>
<li><a href="#安装与配置">安装与配置</a></li>
<li><a href="#启动与挂载">启动与挂载</a></li>
<li><a href="#nfs-的常用命令">NFS 的常用命令</a></li>
<li><a href="#参考文档">参考文档</a><ul>
<li><a href="#ads">Ads</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h1 id="配置集群共享文件-NFS-服务器"><a href="#配置集群共享文件-NFS-服务器" class="headerlink" title="配置集群共享文件 NFS 服务器"></a>配置集群共享文件 NFS 服务器</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>在 Web 服务中往往需要涉及到一些不储存在数据库中的文件资源（比如用户上传的图片、文件等），而在 Web 服务器集群中，若每个服务器节点都有独立的文件资源存储的话，会造成节点间存储不一致的后果。因此比较成熟的解决方案是构建一个 NFS（Network File System）服务器专门提供服务器节点间的共享文件存储。当其他所有 Web 服务器挂载共享目录后，每次读写共享文件资源时实际上读写的是 NFS 服务器上的共享文件系统，这样服务器节点间的存储就可以保持一致性。</p>
<h2 id="安装与配置"><a href="#安装与配置" class="headerlink" title="安装与配置"></a>安装与配置</h2><p>首先在服务器节点上安装 NFS 服务：<code>yum install nfs-utils rpcbind</code>，然后在客户端节点上安装 NFS 服务：<code>yum install nfs-utils</code>。</p>
<p>配置 NFS 服务器（配置文件路径<code>/etc/exports</code>），配置文件中的每一行表示设置一个共享目录以及其有访问权限的主机地址。以下是一个说明示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 共享目录路径为“/home/share”，对所有主机可读，对地址为192.168.1.19的主机可读可写</span><br><span class="line">/home/share *(sync,ro,no_root_squash) 192.168.1.19(sync,rw,no_root_squash)</span><br><span class="line"></span><br><span class="line"># 共享目录路径为“/home/pub”，对192.168.152.0子网内的所有主机可读</span><br><span class="line">/home/pub 192.168.152.0/24(sync,ro,no_root_squash)</span><br></pre></td></tr></table></figure></p>
<ul>
<li>sync：设置NFS服务器同步写磁盘，这样不会轻易丢失数据，建议所有的NFS共享目录都使用该选项</li>
<li>ro：设置输出的共享目录只读，与 rw 不能共同使用</li>
<li>rw：设置输出的共享目录可读写，与 ro 不能共同使用</li>
<li>root_squash：远程登录 NFS 主机后，使用该共享目录时相当于该目录的拥有者。但是如果是以 root 身份使用这个共享目录的时候，那么这个使用者（root）的权限将被压缩成为匿名使用者，即通常他的 UID 与 GID 都会变成nobody那个身份（较为安全）</li>
<li>no_root_squash：远程登录 NFS 主机后，使用该共享目录时相当于该目录的拥有者，如果是 root 的话，那么对于这个共享的目录来说，他就具有 root 的权限（不安全）</li>
<li>all_squash：不论登入 NFS 的使用者身份为何，他的身份都会被压缩成为匿名使用者，通常也就是 nobody</li>
</ul>
<h2 id="启动与挂载"><a href="#启动与挂载" class="headerlink" title="启动与挂载"></a>启动与挂载</h2><p>NFS 服务器启动 nfs 服务：<code>service nfs start</code>后， NFS 客户端即可进行挂载操作：<code>mount : </code>，如<code>mount 192.168.216.128:/home /mnt</code>。客户端卸载 NFS 共享时：<code>umount </code>。</p>
<p>挂载完成，但是这只是临时挂载，客户端重启后 NFS 挂载就失效了，要设置永久挂载可以编辑文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/fstab </span><br><span class="line">&#123;&#123;NFS服务器地址&#125;&#125;:&#123;&#123;远程共享目录&#125;&#125; &#123;&#123;本地挂载目录&#125;&#125; nfs defaults 0 0</span><br></pre></td></tr></table></figure></p>
<p>保存配置，执行mount -a 命令</p>
<blockquote>
<p>PS：客户端不需启动 nfs 服务，但需要安装 nfs 来支持挂载共享目录。客户端卸载共享目录时需保证当前工作目录不是所卸载的目录。</p>
</blockquote>
<h2 id="NFS-的常用命令"><a href="#NFS-的常用命令" class="headerlink" title="NFS 的常用命令"></a>NFS 的常用命令</h2><p>showmount 命令：</p>
<ul>
<li>showmount -e：显示 NFS 服务器的输出目录列表</li>
<li>showmount -d：显示当前主机 NFS 服务器中已经被 NFS 客户机挂载使用的共享目录</li>
<li>showmount -a：显示当前主机中 NFS 服务器的客户机信息</li>
<li>showmount -a [主机]：显示指定主机中 NFS 服务器的客户机信息</li>
</ul>
<p>exportfs 命令：</p>
<ul>
<li>exportfs -rv：使 NFS 服务器重新读取 exports 文件中的设置</li>
<li>exportfs -auv：停止当前主机中 NFS 服务器的所有目录输出</li>
</ul>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a href="http://www.swanlinux.net/2013/02/12/linux_nfs/" target="_blank" rel="noopener">Linux 系统中文件共享之 NFS</a></p>
<p><a href="https://www.cnyunwei.cc/archives/148" target="_blank" rel="noopener">NFS 文件共享配置参数</a></p>
<hr>
<ul>
<li><p><a href="/more/donate/index.html"><strong><em><font color="red">我觉得帮助到我了, 支持你一下.</font></em></strong></a><br>   </p>
</li>
<li><p><a href="https://www.paypal.me/momodainfo" target="_blank" rel="noopener"><strong><em><font color="red">If you think the article is helpful to you, you can reward me through paypal.</font></em></strong></a></p>
</li>
</ul>
<h3 id="Ads"><a href="#Ads" class="headerlink" title="Ads"></a>Ads</h3><p><em>这是小广告! 如果有需要, 不妨支持一下吧~</em></p>
<blockquote>
<p> <a target="_blank" href="https://amazon.cn/gp/search?ie=UTF8&tag=momoda-23&linkCode=ur2&linkId=4a0e4fbec0cfa8dfe540ca999d0bf999&camp=536&creative=3200&index=books&keywords=编程">这些好书您看了吗?</a><img src="//ir-cn.amazon-adsystem.com/e/ir?t=momoda-23&l=ur2&o=28" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p>
</blockquote>
<blockquote>
<p>体育&amp;户外用品推荐</p>
</blockquote>
<div align="center"> <a href="https://www.amazon.cn/B07HWB88Z5/dp/B07HWB88Z5/ref=as_sl_pc_tf_til?tag=momoda-23&linkCode=w00&linkId=14df5124f2165d9eb3d65252e60ed2cf&creativeASIN=B07HWB88Z5" target="_blank" rel="noopener"><img src="/se-notes/Flask-Web工程手册/ch6-配置集群共享文件NFS服务器/../../../more/ads/amazon.gif" width="100%"></a> </div>
      
    </div><!-- .entry-content -->

    <footer class="entry-meta">
    <a href="/se-notes/Flask-Web工程手册/ch6-配置集群共享文件NFS服务器/">
    <time datetime="2019-01-03T13:49:30.000Z" class="entry-date">
        1月 3 2019
    </time>
</a>
    
  <span class="article-delim">&#8226;</span>
  <div class="article-category">
  <a class="article-category-link" href="/categories/框架/">框架</a>, <a class="article-category-link" href="/categories/框架/python-web应用框架/">python-web应用框架</a>, <a class="article-category-link" href="/categories/框架/python-web应用框架/flask/">flask</a>
  </div>

    
  <span class="article-delim">&#8226;</span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web开发/">web开发</a></li></ul>

    </footer>
</article>






  
    <article id="post-se-notes/Flask-Web工程手册/ch7-Nginx安装与重写URL-CentOS7" class="post-se-notes/Flask-Web工程手册/ch7-Nginx安装与重写URL-CentOS7 post type-post status-publish format-standard hentry">
    <!---->

      <header class="entry-header">
        
        
  
    <h1 class="entry-title">
      <a class="article-title" href="/se-notes/Flask-Web工程手册/ch7-Nginx安装与重写URL-CentOS7/">ch7-Nginx安装与重写URL-CentOS7</a>
    </h1>
  

        
        <div class="comments-link">
            
            <a href="javascript:void(0);" data-url="https://wnhby.github.io/se-notes/Flask-Web工程手册/ch7-Nginx安装与重写URL-CentOS7/" data-id="cjsbez092002oczs6ync1pfx0" class="leave-reply bdsharebuttonbox" data-cmd="more">分享</a>
        </div><!-- .comments-link -->
      </header><!-- .entry-header -->

    <div class="entry-content">
      
        <!-- TOC -->
<ul>
<li><a href="#nginx%E5%AE%89%E8%A3%85%E4%B8%8E%E9%87%8D%E5%86%99urlcentos7">Nginx安装与重写URL（CentOS7）</a><ul>
<li><a href="#nginx%E5%AE%89%E8%A3%85">Nginx安装</a></li>
<li><a href="#%E9%87%8D%E5%86%99url">重写URL</a><ul>
<li><a href="#ads">Ads</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h1 id="Nginx安装与重写URL（CentOS7）"><a href="#Nginx安装与重写URL（CentOS7）" class="headerlink" title="Nginx安装与重写URL（CentOS7）"></a>Nginx安装与重写URL（CentOS7）</h1><h2 id="Nginx安装"><a href="#Nginx安装" class="headerlink" title="Nginx安装"></a>Nginx安装</h2><p>新建 /etc/yum.repos.d/nginx.repo：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[nginx]</span><br><span class="line">name=nginx repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/7/$basearch/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br></pre></td></tr></table></figure></p>
<p>使用命令<code># yum install nginx</code>安装nginx。安装完成后使用命令<code># nginx</code>启动 nginx 。使用<code># nginx -v</code>查看 nginx 版本。并可通过在浏览器里直接访问机器的IP地址可查看 nginx 是否启动成功（<strong>需确保关闭 CentOS 的 SELinux 和防火墙服务</strong>）。</p>
<h2 id="重写URL"><a href="#重写URL" class="headerlink" title="重写URL"></a>重写URL</h2><p>使用<code># nginx -t</code>命令查看当前 nginx 配置文件状态以及路径。在配置文件中的项 http{} 里可重写URL：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">        listen 80;                  #设置监听端口</span><br><span class="line">        server_name 172.18.216.123; #决定配置哪几台服务器，值可为域名也可为IP地址</span><br><span class="line">        location / &#123;                #对匹配目录&quot;/&quot;进行操作。也可设置为其它的目录</span><br><span class="line">            rewrite / http://www.baidu.com break; #执行URL重写，支持正则表达式</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>也可在配置文件的 server 块中写，此时是针对该服务器的全局配置。如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    rewrite 规则 定向路径 重写类型;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>规则：可以是字符串或者正则来表示想匹配的目标url</li>
<li>定向路径：表示匹配到规则后要定向的路径，如果规则里有正则，则可以使用 $index 来表示正则里的捕获分组</li>
<li>重写类型：<ul>
<li>last ：匹配重写后的URL，再一次对URL重写规则进行匹配。浏览器地址栏URL地址不变</li>
<li>break；匹配重写URL后终止匹配，直接使用。浏览器地址栏URL地址不变</li>
<li>redirect：返回302临时重定向，浏览器地址会显示跳转后的URL地址</li>
<li>permanent：返回301永久重定向，浏览器地址栏会显示跳转后的URL地址</li>
</ul>
</li>
</ul>
<p>更多具体语法可参见官方文档 <a href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html" target="_blank" rel="noopener">Rewrite模块</a> 或中文技术博客 <a href="http://www.tuicool.com/articles/qEzMNrI" target="_blank" rel="noopener">Nginx配置URL重写</a>。</p>
<hr>
<ul>
<li><p><a href="/more/donate/index.html"><strong><em><font color="red">我觉得帮助到我了, 支持你一下.</font></em></strong></a><br>   </p>
</li>
<li><p><a href="https://www.paypal.me/momodainfo" target="_blank" rel="noopener"><strong><em><font color="red">If you think the article is helpful to you, you can reward me through paypal.</font></em></strong></a></p>
</li>
</ul>
<h3 id="Ads"><a href="#Ads" class="headerlink" title="Ads"></a>Ads</h3><p><em>这是小广告! 如果有需要, 不妨支持一下吧~</em></p>
<blockquote>
<p> <a target="_blank" href="https://amazon.cn/gp/search?ie=UTF8&tag=momoda-23&linkCode=ur2&linkId=4a0e4fbec0cfa8dfe540ca999d0bf999&camp=536&creative=3200&index=books&keywords=编程">这些好书您看了吗?</a><img src="//ir-cn.amazon-adsystem.com/e/ir?t=momoda-23&l=ur2&o=28" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p>
</blockquote>
<blockquote>
<p>体育&amp;户外用品推荐</p>
</blockquote>
<div align="center"> <a href="https://www.amazon.cn/B07HWB88Z5/dp/B07HWB88Z5/ref=as_sl_pc_tf_til?tag=momoda-23&linkCode=w00&linkId=14df5124f2165d9eb3d65252e60ed2cf&creativeASIN=B07HWB88Z5" target="_blank" rel="noopener"><img src="/se-notes/Flask-Web工程手册/ch7-Nginx安装与重写URL-CentOS7/../../../more/ads/amazon.gif" width="100%"></a> </div>
      
    </div><!-- .entry-content -->

    <footer class="entry-meta">
    <a href="/se-notes/Flask-Web工程手册/ch7-Nginx安装与重写URL-CentOS7/">
    <time datetime="2019-01-03T13:49:30.000Z" class="entry-date">
        1月 3 2019
    </time>
</a>
    
  <span class="article-delim">&#8226;</span>
  <div class="article-category">
  <a class="article-category-link" href="/categories/框架/">框架</a>, <a class="article-category-link" href="/categories/框架/python-web应用框架/">python-web应用框架</a>, <a class="article-category-link" href="/categories/框架/python-web应用框架/flask/">flask</a>
  </div>

    
  <span class="article-delim">&#8226;</span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web开发/">web开发</a></li></ul>

    </footer>
</article>






  
    <article id="post-se-notes/Flask-Web工程手册/ch8-高可用与负载均衡集群部署-Ubuntu" class="post-se-notes/Flask-Web工程手册/ch8-高可用与负载均衡集群部署-Ubuntu post type-post status-publish format-standard hentry">
    <!---->

      <header class="entry-header">
        
        
  
    <h1 class="entry-title">
      <a class="article-title" href="/se-notes/Flask-Web工程手册/ch8-高可用与负载均衡集群部署-Ubuntu/">ch8-高可用与负载均衡集群部署-Ubuntu</a>
    </h1>
  

        
        <div class="comments-link">
            
            <a href="javascript:void(0);" data-url="https://wnhby.github.io/se-notes/Flask-Web工程手册/ch8-高可用与负载均衡集群部署-Ubuntu/" data-id="cjsbez095002qczs6678orlbo" class="leave-reply bdsharebuttonbox" data-cmd="more">分享</a>
        </div><!-- .comments-link -->
      </header><!-- .entry-header -->

    <div class="entry-content">
      
        <!-- TOC -->
<ul>
<li><a href="#ehpc负载均衡及高可用集群部署说明">EHPC负载均衡及高可用集群部署说明</a><ul>
<li><a href="#一物理架构及技术简介">一.物理架构及技术简介</a><ul>
<li><a href="#haproxy">HAProxy</a></li>
<li><a href="#keepalived">Keepalived</a></li>
<li><a href="#nfs">NFS</a></li>
</ul>
</li>
<li><a href="#二部署准备">二.部署准备</a></li>
<li><a href="#三数据库节点配置">三.数据库节点配置</a><ul>
<li><a href="#nfs-服务配置">NFS 服务配置</a></li>
<li><a href="#mysql-服务配置">MySQL 服务配置</a></li>
</ul>
</li>
<li><a href="#四web服务节点配置">四.Web服务节点配置</a></li>
<li><a href="#五haproxy代理节点配置">五.HAProxy代理节点配置</a></li>
<li><a href="#如何进行项目文件更新">如何进行项目文件更新</a></li>
<li><a href="#架构中将来可能遇到的问题">架构中将来可能遇到的问题</a></li>
<li><a href="#部署问题汇总">部署问题汇总</a><ul>
<li><a href="#ubuntu系统设置dns失败">ubuntu系统设置DNS失败</a></li>
<li><a href="#启动-80-端口的-web-节点的服务时提示端口被占用">启动 80 端口的 web 节点的服务时提示端口被占用</a></li>
<li><a href="#virtualenv-虚拟环境迁移后无法正常引用库">virtualenv 虚拟环境迁移后无法正常引用库</a></li>
<li><a href="#复制-bashrc-文件后虚拟环境导向出错">复制 .bashrc 文件后虚拟环境导向出错</a></li>
<li><a href="#设置语言的环境变量时警告-warning-setlocale-lc_all-cannot-change-locale-zh_cnutf-8">设置语言的环境变量时警告 warning: setlocale: LC_ALL： cannot change locale (zh_CN.UTF-8)</a></li>
<li><a href="#安装-gevent-失败">安装 gevent 失败</a></li>
<li><a href="#supervisor启动后-web-服务启动失败">supervisor启动后 web 服务启动失败</a></li>
<li><a href="#ads">Ads</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h1 id="EHPC负载均衡及高可用集群部署说明"><a href="#EHPC负载均衡及高可用集群部署说明" class="headerlink" title="EHPC负载均衡及高可用集群部署说明"></a>EHPC负载均衡及高可用集群部署说明</h1><h2 id="一-物理架构及技术简介"><a href="#一-物理架构及技术简介" class="headerlink" title="一.物理架构及技术简介"></a>一.物理架构及技术简介</h2><p>使用 Haproxy + Keepalived + nfs 作为集群部署方式。其中一台或多台 Hapoxy 代理服务器作为集群负载均衡的调度前端，多个 web 服务节点、单个数据库节点（同时提供 nfs 文件共享存储）作为对外隐藏的集群后端。</p>
<h3 id="HAProxy"><a href="#HAProxy" class="headerlink" title="HAProxy"></a>HAProxy</h3><p>HAProxy（High Available Proxy）是一款提供高可用性、负载均衡以及基于 TCP（第四层）和 HTTP（第七层）应用的代理软件。 HAProxy 配置简单、支持多达上万并发连接。其运行模型可使得它非常容易和无风险地集成到现有的架构中，并且同时可以保护 web 服务器不被暴露到网络上。</p>
<h3 id="Keepalived"><a href="#Keepalived" class="headerlink" title="Keepalived"></a>Keepalived</h3><p>Keepalived 是一款高可用软件，它的功能是基于 VRRP 协议、通过 IP 漂移实现服务的高可用：服务器集群共享一个虚拟 IP，同一时间只有一个服务器占有虚拟 IP 并对外提供服务。若该服务器不可用，则虚拟 IP 漂移至另一台服务器并对外提供服务。</p>
<h3 id="NFS"><a href="#NFS" class="headerlink" title="NFS"></a>NFS</h3><p>在 Web 服务中往往需要涉及到一些不储存在数据库中的文件资源（比如用户上传的图片、文件等），而在集群中，若每个节点都有独立的文件存储的话，会造成存储不一致的后果。因此解决方案是构建一个 NFS（Network File System）服务器专门提供服务器节点间的共享文件存储，这样服务器节点间的存储就可以保持一致性。</p>
<h2 id="二-部署准备"><a href="#二-部署准备" class="headerlink" title="二.部署准备"></a>二.部署准备</h2><p>准备四台虚机（Linux Ubuntu），分别作为前端代理（ ha1[10.182.15.46]）、服务节点（web1[10.182.15.51<br>]、web2[10.182.15.52]）、数据库节点（nfs1[10.182.15.50]）。所有节点均可访问外网，其中只有 ha1 拥有公网 IP。</p>
<blockquote>
<p>此外还拥有一台备份节点，用于对数据库节点 nfs1 的数据库以及文件目录进行实时主从备份。</p>
</blockquote>
<p>所有节点须设置好 hosts 互相解析：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#vi /etc/hosts</span><br><span class="line">10.182.15.46    ha1</span><br><span class="line">10.182.15.50    nfs1</span><br><span class="line">10.182.15.51    web1</span><br><span class="line">10.182.15.52    web2</span><br></pre></td></tr></table></figure></p>
<p>以及更新好 apt-get 库：<code>apt-get update</code></p>
<h2 id="三-数据库节点配置"><a href="#三-数据库节点配置" class="headerlink" title="三.数据库节点配置"></a>三.数据库节点配置</h2><p>数据库节点为 nfs1，主要提供 NFS 与 MySQL 服务。</p>
<h3 id="NFS-服务配置"><a href="#NFS-服务配置" class="headerlink" title="NFS 服务配置"></a>NFS 服务配置</h3><p>安装 NFS 服务<code>sudo apt-get install nfs-kernel-server</code>，并编辑配置文件（路径为<code>/etc/exports</code>），配置文件中的每一行表示设置一个共享目录以及有其访问权限的主机地址。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 共享目录路径为“/home/share”，对 web1 与 web2 两台主机开放读写权限</span><br><span class="line">/home/share   web1(rw,sync,no_root_squash) web2(rw,sync,no_root_squash)</span><br></pre></td></tr></table></figure>
<p>启动 NFS 服务：<code>service nfs-kernel-server start</code>后， NFS 客户端才可对共享目录进行挂载。</p>
<p>共享目录中放置 ehpc 的服务端项目文件，所有 web 服务节点将一起使用共享目录中的项目文件。</p>
<p>更多配置参数请参考 <a href="https://github.com/Zouzhp3/Learn/blob/master/Cloud/%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4%E5%85%B1%E4%BA%AB%E6%96%87%E4%BB%B6%20NFS%20%E6%9C%8D%E5%8A%A1%E5%99%A8.md" target="_blank" rel="noopener">NFS服务器配置文档</a>。</p>
<h3 id="MySQL-服务配置"><a href="#MySQL-服务配置" class="headerlink" title="MySQL 服务配置"></a>MySQL 服务配置</h3><p>ubuntu 系统一般会自带 MySQL 5.5，因此无需再安装一遍。首先使用默认的 mysql root 账户进入 mysql 命令行，修改 root 默认密码，并创建一个拥有访问权限的普通用户。</p>
<p>按照以下步骤设置开放 MySQL 的远程访问权限：</p>
<ul>
<li>保证远程访问的 mysql 用户的 host 为’%’而不是’localhost’</li>
<li><code>sudo vi /etc/mysql/my.cnf</code>，注释掉<code>bind-address = 127.0.0.1</code></li>
<li>重启 mysql 服务</li>
</ul>
<p>之后导入原数据库的 sql 脚本即可。</p>
<p>至此便完成了节点 nfs1 的配置。</p>
<h2 id="四-Web服务节点配置"><a href="#四-Web服务节点配置" class="headerlink" title="四.Web服务节点配置"></a>四.Web服务节点配置</h2><p>本集群拥有两个 web 服务节点 web1、web2，两个节点的部署操作完全一致。</p>
<p>先使用 pip 安装 virtualenv、gunicorn、gevent、supervisor 等软件并使用<code>apt-get install nfs-common​</code>安装 NFS 客户端。再把 nfs1 节点开放的共享目录<code>/home/share</code>挂载到本地目录<code>/home/haproxy/share</code>，并设置为永久挂载（挂载操作参考 <a href="https://github.com/Zouzhp3/Learn/blob/master/Cloud/%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4%E5%85%B1%E4%BA%AB%E6%96%87%E4%BB%B6%20NFS%20%E6%9C%8D%E5%8A%A1%E5%99%A8.md" target="_blank" rel="noopener">NFS服务器配置文档</a>）。</p>
<p>迁移原 python 虚拟环境（迁移方法参考本文文末）后，还需要配置环境变量：把原脚本<code>.bashrc</code> copy 到用户根目录中，并对其中数据库配置等环境参数进行修改以满足当前实际要求，之后<code>source ~/.bashrc</code>刷新环境变量即可。</p>
<p>之后配置 supervisor（路径<code>/etc/supervisor/conf.d/ehpc.conf</code>）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[program:ehpc]</span><br><span class="line">command=/home/haproxy/env/bin/gunicorn manage:app -b 0.0.0.0:80 -w 4 --worker-class gevent</span><br><span class="line">autostart = true</span><br><span class="line">autorestart = true</span><br><span class="line">user=root</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>注意 manage.py 路径，需当前工作目录为项目主目录才可启动成功。最好在启动 supervisor 前手工启动跑一下以便及早发现可能的问题。</p>
</blockquote>
<h2 id="五-HAProxy代理节点配置"><a href="#五-HAProxy代理节点配置" class="headerlink" title="五.HAProxy代理节点配置"></a>五.HAProxy代理节点配置</h2><p>前端节点为 ha1，作为集群中唯一直接对外通信的代理服务器。</p>
<p>安装 HAProxy：<code>yum install haproxy</code>，然后配置 HAProxy（路径<code>/etc/haproxy/haproxy.cfg</code>）。</p>
<p>HAProxy 的配置文件分为五个部分：</p>
<ul>
<li>global：全局配置的进程级参数，用来控制 Haproxy 启动前的一些进程及系统设置</li>
<li>defaults：配置默认参数，可以被 frontend，backend，listen 段继承使用</li>
<li>frontend：定义接收请求的前端虚拟节点，可根据用户所请求的不同域名、URL 等做不同的请求处理</li>
<li>backend：定义处理业务的后端服务器集群，以及设置后端的权重、队列、连接数等选项</li>
<li>listen：frontend 和 backend 的组合体</li>
</ul>
<blockquote>
<p>配置参数详细说明请查阅 <a href="http://www.ttlsa.com/linux/haproxy-study-tutorial/" target="_blank" rel="noopener">HAProxy用法详解</a>。</p>
</blockquote>
<p>以下是 ha1 的配置实例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">        log /dev/log    local0</span><br><span class="line">        log /dev/log    local1 notice</span><br><span class="line">        chroot /var/lib/haproxy</span><br><span class="line">        maxconn 20000</span><br><span class="line">        daemon</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">        log     global</span><br><span class="line">        mode    http</span><br><span class="line">        option  httplog</span><br><span class="line">        option  dontlognull</span><br><span class="line">        option http-server-close</span><br><span class="line">        option forwardfor except 127.0.0.0/8</span><br><span class="line">        option redispatch</span><br><span class="line">        retries 3             # 3次连接失败就认为服务器不可用</span><br><span class="line">        timeout http-keep-alive 10s           # 默认持久连接超时时间</span><br><span class="line">        timeout check           10s           # 心跳检查超时时间</span><br><span class="line">        contimeout 5000</span><br><span class="line">        clitimeout 50000</span><br><span class="line">        srvtimeout 50000</span><br><span class="line">        errorfile 400 /etc/haproxy/errors/400.http</span><br><span class="line">        errorfile 403 /etc/haproxy/errors/403.http</span><br><span class="line">        errorfile 408 /etc/haproxy/errors/408.http</span><br><span class="line">        errorfile 500 /etc/haproxy/errors/500.http</span><br><span class="line">        errorfile 502 /etc/haproxy/errors/502.http</span><br><span class="line">        errorfile 503 /etc/haproxy/errors/503.http</span><br><span class="line">        errorfile 504 /etc/haproxy/errors/504.http</span><br><span class="line"></span><br><span class="line">frontend  proxy *:80    #前端代理</span><br><span class="line">        default_backend  dynamic</span><br><span class="line"></span><br><span class="line">backend dynamic    #后端Web服务器</span><br><span class="line">        balance roundrobin</span><br><span class="line">        cookie  SESSION_ID insert indirect nocache    #设置cookie保持</span><br><span class="line">        server  web1  10.182.15.51:80 inter 3000 rise 2 fall 3 check maxconn 10000 cookie A</span><br><span class="line">        server  web2  10.182.15.52:80 inter 3000 rise 2 fall 3 check maxconn 10000 cookie B</span><br></pre></td></tr></table></figure></p>
<p>启动 HAProxy 服务：<code>service haproxy start</code>即可。</p>
<h2 id="如何进行项目文件更新"><a href="#如何进行项目文件更新" class="headerlink" title="如何进行项目文件更新"></a>如何进行项目文件更新</h2><p>更新之前先停掉 web1 与 web2 的服务：<code>supervisorctl stop ehpc</code></p>
<ul>
<li>更新数据库：登录 nfs1，进入 mysql 命令行进行新的数据库 sql 文件导入即可</li>
<li>更新项目文件：登录 nfs1，新的项目文件代替<code>/home/share</code>中对应的文件即可。</li>
</ul>
<blockquote>
<p>提示：由于通过跳板机登录 nfs1 不能使用 sftp 功能，因此目前也把跳板机下的目录挂载了 nfs1 上的共享目录，这样直接通过在跳板机上上传文件就可以修改项目文件了。</p>
</blockquote>
<p>最后记得要重启 web1 与 web2 的服务：<code>supervisorctl start ehpc</code></p>
<h2 id="架构中将来可能遇到的问题"><a href="#架构中将来可能遇到的问题" class="headerlink" title="架构中将来可能遇到的问题"></a>架构中将来可能遇到的问题</h2><p>由于 nfs1 既作为集群中唯一的数据库服务节点以及唯一的文件共享目录挂载节点，同时还负责对外实时备份，因此很有可能成为集群中效率的瓶颈。今后的架构重构中，应当考虑把数据库服务从文件共享目录挂载节点分离开，减小 nfs1 的压力。</p>
<h2 id="部署问题汇总"><a href="#部署问题汇总" class="headerlink" title="部署问题汇总"></a>部署问题汇总</h2><h3 id="ubuntu系统设置DNS失败"><a href="#ubuntu系统设置DNS失败" class="headerlink" title="ubuntu系统设置DNS失败"></a>ubuntu系统设置DNS失败</h3><p>在<code>/etc/resolvconf/resolv.conf.d/base</code>里添加 DNS 失败，则应当在<code>/etc/resolvconf/resolv.conf.d/head</code>中进行添加，之后使用<code>resolvconf -u</code>刷新即可。</p>
<h3 id="启动-80-端口的-web-节点的服务时提示端口被占用"><a href="#启动-80-端口的-web-节点的服务时提示端口被占用" class="headerlink" title="启动 80 端口的 web 节点的服务时提示端口被占用"></a>启动 80 端口的 web 节点的服务时提示端口被占用</h3><p>ubuntu 系统自带 Apache2 服务占用了 80 端口且开机自动启动，用<code>sudo lsof -i:80</code>命令找出 80 端口的占用程序 kill 掉即可，此外还可使用<code>sudo update-rc.d apache2 disable</code>命令关闭 apache2 的自启动。</p>
<h3 id="virtualenv-虚拟环境迁移后无法正常引用库"><a href="#virtualenv-虚拟环境迁移后无法正常引用库" class="headerlink" title="virtualenv 虚拟环境迁移后无法正常引用库"></a>virtualenv 虚拟环境迁移后无法正常引用库</h3><p>直接 copy 虚拟环境到另一台主机上就会出现新虚拟环境下的 python 无法引用库的问题。解决方法是在新主机上重新新建一个虚拟环境，然后把要原虚拟环境中的<code>lib/python2.7/site-packages/</code>目录下的库都 copy 到新虚拟环境中的该目录下即可。</p>
<h3 id="复制-bashrc-文件后虚拟环境导向出错"><a href="#复制-bashrc-文件后虚拟环境导向出错" class="headerlink" title="复制 .bashrc 文件后虚拟环境导向出错"></a>复制 .bashrc 文件后虚拟环境导向出错</h3><p>.bashrc 复制到新的主机的用户根目录下时出现，删除以下两行即可：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export WORKON_HOME=~/.Envs</span><br><span class="line">source /usr/local/bin/virtualenvwrapper.sh</span><br></pre></td></tr></table></figure></p>
<h3 id="设置语言的环境变量时警告-warning-setlocale-LC-ALL：-cannot-change-locale-zh-CN-UTF-8"><a href="#设置语言的环境变量时警告-warning-setlocale-LC-ALL：-cannot-change-locale-zh-CN-UTF-8" class="headerlink" title="设置语言的环境变量时警告 warning: setlocale: LC_ALL： cannot change locale (zh_CN.UTF-8)"></a>设置语言的环境变量时警告 warning: setlocale: LC_ALL： cannot change locale (zh_CN.UTF-8)</h3><p>如果不处理的话会导致程序中编码问题而报错。这是因为系统里没有安装对应的语言包，使用<code>sudo apt-get install language-pack-zh-hans</code>安装对应的语言包后重启并<code>source ~/.bashrc</code>即可。</p>
<h3 id="安装-gevent-失败"><a href="#安装-gevent-失败" class="headerlink" title="安装 gevent 失败"></a>安装 gevent 失败</h3><p>使用<code>pip install gevent</code>安装 gevent 时失败时，需要安装依赖包 python-dev ：<code>sudo apt-get install python-dev</code></p>
<h3 id="supervisor启动后-web-服务启动失败"><a href="#supervisor启动后-web-服务启动失败" class="headerlink" title="supervisor启动后 web 服务启动失败"></a>supervisor启动后 web 服务启动失败</h3><p>在使用 supervisor 启动服务前先使用<code>gunicorn manage:app -b 0.0.0.0:80 -w 4 --worker-class gevent</code>命令进行测试，观察服务能否正常启动。若测试成功，则还要保证以下三点：</p>
<ul>
<li>工作目录是 ehpc 项目的主目录</li>
<li>supervisor 服务处于开启状态：<code>sudo service supervisor status</code></li>
<li>使用<code>supervisord -c /etc/supervisor/supervisor.conf</code>启动 supervisor 进程</li>
</ul>
<hr>
<ul>
<li><p><a href="/more/donate/index.html"><strong><em><font color="red">我觉得帮助到我了, 支持你一下.</font></em></strong></a><br>   </p>
</li>
<li><p><a href="https://www.paypal.me/momodainfo" target="_blank" rel="noopener"><strong><em><font color="red">If you think the article is helpful to you, you can reward me through paypal.</font></em></strong></a></p>
</li>
</ul>
<h3 id="Ads"><a href="#Ads" class="headerlink" title="Ads"></a>Ads</h3><p><em>这是小广告! 如果有需要, 不妨支持一下吧~</em></p>
<blockquote>
<p> <a target="_blank" href="https://amazon.cn/gp/search?ie=UTF8&tag=momoda-23&linkCode=ur2&linkId=4a0e4fbec0cfa8dfe540ca999d0bf999&camp=536&creative=3200&index=books&keywords=编程">这些好书您看了吗?</a><img src="//ir-cn.amazon-adsystem.com/e/ir?t=momoda-23&l=ur2&o=28" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p>
</blockquote>
<blockquote>
<p>体育&amp;户外用品推荐</p>
</blockquote>
<div align="center"> <a href="https://www.amazon.cn/B07HWB88Z5/dp/B07HWB88Z5/ref=as_sl_pc_tf_til?tag=momoda-23&linkCode=w00&linkId=14df5124f2165d9eb3d65252e60ed2cf&creativeASIN=B07HWB88Z5" target="_blank" rel="noopener"><img src="/se-notes/Flask-Web工程手册/ch8-高可用与负载均衡集群部署-Ubuntu/../../../more/ads/amazon.gif" width="100%"></a> </div>
      
    </div><!-- .entry-content -->

    <footer class="entry-meta">
    <a href="/se-notes/Flask-Web工程手册/ch8-高可用与负载均衡集群部署-Ubuntu/">
    <time datetime="2019-01-03T13:49:30.000Z" class="entry-date">
        1月 3 2019
    </time>
</a>
    
  <span class="article-delim">&#8226;</span>
  <div class="article-category">
  <a class="article-category-link" href="/categories/框架/">框架</a>, <a class="article-category-link" href="/categories/框架/python-web应用框架/">python-web应用框架</a>, <a class="article-category-link" href="/categories/框架/python-web应用框架/flask/">flask</a>
  </div>

    
  <span class="article-delim">&#8226;</span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web开发/">web开发</a></li></ul>

    </footer>
</article>






  
    <article id="post-se-notes/Java基础/JVM基础" class="post-se-notes/Java基础/JVM基础 post type-post status-publish format-standard hentry">
    <!---->

      <header class="entry-header">
        
        
  
    <h1 class="entry-title">
      <a class="article-title" href="/se-notes/Java基础/JVM基础/">JVM基础</a>
    </h1>
  

        
        <div class="comments-link">
            
            <a href="javascript:void(0);" data-url="https://wnhby.github.io/se-notes/Java基础/JVM基础/" data-id="cjsbez09b002uczs6s7th9meh" class="leave-reply bdsharebuttonbox" data-cmd="more">分享</a>
        </div><!-- .comments-link -->
      </header><!-- .entry-header -->

    <div class="entry-content">
      
        <!-- TOC -->
<ul>
<li><a href="#jvm基础">JVM基础</a><ul>
<li><a href="#类加载器classloader">类加载器(classloader)</a><ul>
<li><a href="#双亲委托机制">双亲委托机制</a></li>
</ul>
</li>
<li><a href="#执行引擎execution-engine">执行引擎(execution engine)</a></li>
<li><a href="#运行时数据区域jvm-runtime-area">运行时数据区域(JVM Runtime Area)</a></li>
</ul>
</li>
<li><a href="#gc">GC</a><ul>
<li><a href="#找出需要回收的对象">找出需要回收的对象</a></li>
<li><a href="#垃圾回收算法">垃圾回收算法</a><ul>
<li><a href="#标记-清除算法">标记-清除算法</a></li>
<li><a href="#标记-整理算法">标记-整理算法</a></li>
<li><a href="#复制算法">复制算法</a></li>
<li><a href="#分代收集算法结合以上三种算法">分代收集算法（结合以上三种算法）</a></li>
</ul>
</li>
<li><a href="#heap-的组成">heap 的组成</a></li>
<li><a href="#\对象引用类型">*对象引用类型</a><ul>
<li><a href="#ads">Ads</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h1 id="JVM基础"><a href="#JVM基础" class="headerlink" title="JVM基础"></a>JVM基础</h1><p> Java 虚拟机（Java virtual machine，JVM）是运行 Java 程序必不可少的机制。JVM 实现了 Java 最重要的特征：平台无关性。</p>
<p>原理：编译后的 Java 程序指令并不直接在硬件系统的 CPU 上执行，而是由 JVM 执行。JVM 屏蔽了与具体平台相关的信息，使 Java 语言编译程序只需要生成在 JVM 上运行的目标字节码（.class），就可以在多种平台上不加修改地运行。Java 虚拟机在执行字节码时，把字节码解释成具体平台上的机器指令执行，由此实现平台无关性。</p>
<p><img src="https://segmentfault.com/img/bVkZat" alt="JVM模型"></p>
<p>JVM = 类加载器(classloader) + 执行引擎(execution engine) + 运行时数据区(runtime data area)</p>
<h2 id="类加载器-classloader"><a href="#类加载器-classloader" class="headerlink" title="类加载器(classloader)"></a>类加载器(classloader)</h2><p>类加载器用于装载 .class 文件到 JVM 中，有两种装载 class 的方式 ：</p>
<ul>
<li>隐式：运行过程中，碰到 new 方式生成对象时，隐式调用 classLoader 到 JVM</li>
<li>显式：通过 Class.forname() 动态加载</li>
</ul>
<h3 id="双亲委托机制"><a href="#双亲委托机制" class="headerlink" title="双亲委托机制"></a>双亲委托机制</h3><p>类的加载过程采用<strong>双亲委托机制</strong>，这种机制能更好的保证 Java 平台的安全。</p>
<p>该模型要求除了顶层的 Bootstrap class loader 启动类加载器外，其余的类加载器都应当有自己的父类加载器。子类加载器和父类加载器不是以继承（Inheritance）的关系来实现，而是通过组合（Composition）关系来复用父加载器的代码。每个类加载器都有自己的命名空间。</p>
<p>双亲委托机制的工作过程如下：</p>
<ol>
<li>当前 classLoader 首先从自己已经加载的类中查询是否此类已经加载，如果已经加载则直接返回原来已经加载的类。（每个类加载器都有自己的加载缓存，当一个类被加载了以后就会放入缓存，<br>等下次加载的时候就可以直接返回）</li>
<li>当前 classLoader 的缓存中没有找到被加载的类的时候，委托父类加载器去加载，父类加载器采用同样的策略，首先查看自己的缓存，然后委托父类的父类去加载，一直到 bootstrap ClassLoader 。（当所有的父类加载器都没有加载的时候，再由当前的类加载器加载，并将其放入它自己的缓存中，以便下次有加载请求的时候直接返回）</li>
</ol>
<p>类加载器 classloader 是具有层次结构的，也就是父子关系。其中 Bootstrap 是所有类加载器的父亲。</p>
<p><img src="https://segmentfault.com/img/bVk0W2" alt="类加载器层次结构"></p>
<p>使用双亲委托机制的目的在于：</p>
<ol>
<li>安全性考虑：为了安全性，避免用户自己编写的类动态替换 Java 的一些核心类，比如 String。</li>
<li>避免重复加载：JVM 中区分不同类，不仅仅是根据类名。相同的 class 文件被不同的 ClassLoader 加载就是不同的两个类，如果相互转型的话会抛 java.lang.ClassCaseException。</li>
</ol>
<h2 id="执行引擎-execution-engine"><a href="#执行引擎-execution-engine" class="headerlink" title="执行引擎(execution engine)"></a>执行引擎(execution engine)</h2><p>执行引擎用于执行字节码或者本地方法。</p>
<h2 id="运行时数据区域-JVM-Runtime-Area"><a href="#运行时数据区域-JVM-Runtime-Area" class="headerlink" title="运行时数据区域(JVM Runtime Area)"></a>运行时数据区域(JVM Runtime Area)</h2><p>JVM 运行时数据区 (JVM Runtime Area) 是 JVM 在运行期间，其对 JVM 内存空间的划分和分配。JVM 在运行时将数据划分为了多个区域来存储。</p>
<p>程序员写的 Java 程序都被加载到运行时数据区域中，按不同类别存放在堆（Heap）、方法区（Method Area）、虚拟机栈（VM Stack）、程序计数器（PC）中。</p>
<p><img src="http://img.blog.csdn.net/20140218172737265?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY2hhb2ZhbndlaQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="Java内存结构"></p>
<ul>
<li><p><strong>程序计数器</strong>：线程私有。当前线程所执行的字节码的指令计数器，存储每个线程下一步将执行的 JVM 指令。</p>
</li>
<li><p><strong>JVM栈</strong>：线程私有。与线程同时创建，生命周期与线程相同。每个方法被执行的时候都会同时创建一个<strong>栈帧</strong>（Stack Frame）用于存储局部变量、操作数栈等信息。每一个方法被调用直至执行完成的过程就对应着一个栈帧在虚拟机栈中从入栈到出栈的过程。</p>
</li>
</ul>
<p><img src="https://segmentfault.com/img/bVmxl8" alt="JVM栈"></p>
<ul>
<li><p><strong>Native 方法栈</strong>：线程私有。类似于 JVM 栈，但虚拟机栈用于为虚拟机执行 java 方法，而本地方法栈则用于为虚拟机执行 native 方法。（native 方法是原生函数，是用 C/C++ 语言实现的，并且被编译成了 DLL，由 java 去调用）</p>
</li>
<li><p><strong>Java 堆</strong>：被所有线程共享的存储区域，在虚拟机启动时创建。它是 JVM 用于存储对象实例和数组的区域，Java 中所有通过 new 创建的对象的内存都在此分配。（这些对象被 GC 自动管理，无需也无法显式被销毁）</p>
<ul>
<li>内存分配方式：<strong>指针碰撞</strong>（用一个指针指向内存已用区和空闲区的分界点）和<strong>空闲列表</strong>（用一个列表记录哪些内存块可用）。</li>
<li>指针碰撞的分配方式明显要优于空闲列表的方式，但是使用哪种方式取决于堆内存是否规整，而堆内存是否规整则由使用的垃圾收集算法决定。</li>
<li>堆在 JVM 是所有线程共享的，因此在其上进行对象内存的分配均需要进行加锁，这也是 new 开销比较大的原因。</li>
<li>鉴于上面的原因，Sun Hotspot JVM 为了提升对象内存分配的效率，对于所创建的线程都会分配一块独立的空间，这块空间又称为 TLAB。</li>
</ul>
</li>
<li><p><strong>方法区</strong>：被所有线程共享的内存区域，在虚拟机启动时创建，它用于存储已被虚拟机加载的类信息、常量、静态变量等数据。<strong>JVM 用持久代（Permanet Generation）来存放方法区</strong>。</p>
<ul>
<li>运行时常量池：方法区的一部分，存放的为类中固定的常量信息、方法和域的引用信息。</li>
</ul>
</li>
</ul>
<h1 id="GC"><a href="#GC" class="headerlink" title="GC"></a>GC</h1><p>垃圾回收机制是由垃圾收集器 Garbage Collection（GC）来实现的，GC 是后台的守护进程。它是一个低优先级进程，但是可以根据内存的使用情况动态的调整它的优先级。因此，它在内存可用量低到一定限度时才会自动运行，从而实现对内存的回收。这就是垃圾回收的时间不确定的原因。</p>
<p>程序运行期间，所有对象实例存储在运行时数据区域的 heap 中，当一个对象不再被引用（使用），它就需要被收回。在 GC 过程中，这些不再被使用的对象从 heap 中收回，这样就会有内存空间被循环利用。</p>
<p>由于 GC 要消耗一些资源和时间，Java 在对对象的生命周期特征（eden or survivor）进行分析之后，采用了分代的方式进行对象的收集，以缩短 GC 对应用造成的暂停。</p>
<p>在垃圾回收器回收内存之前，还需要一些清理工作。<br>因为 GC 只能回收通过 new 申请的内存（在堆上），但是堆上的内存并不完全是通过 new 申请分配的。还有一些本地方法（一般是调用的 C 方法）。这部分特殊内存如果不手动释放，就会导致内存泄露，而 GC 是无法回收这部分内存的。<br>所以需要在 finalize 中用本地方法(native method)如 free 操作等，再使用 gc 方法。显式的 GC 方法是 system.gc() 。</p>
<h2 id="找出需要回收的对象"><a href="#找出需要回收的对象" class="headerlink" title="找出需要回收的对象"></a>找出需要回收的对象</h2><ul>
<li>引用计数法：给对象添加一个引用计数器，计数器的值代表着这个对象被引用的次数，当计数器的值为0的时候，就代表没有引用指向这个对象，所以就可以对它进行回收。但无法解决对象循环引用的问题。（即多个对象互相循环引用，但没有其他对象持有这些对象的引用，从而是一个孤立的系统）</li>
<li>可达性分析：从一些顶点开始，对有向图中的每个顶点进行可达性分析，就可以把不可达的对象找出来。这些起始对象被称为 GC Roots。可以作为 GC Roots 的对象有：栈区中引用的对象、 方法区中静态属性或常量引用的对象。</li>
</ul>
<h2 id="垃圾回收算法"><a href="#垃圾回收算法" class="headerlink" title="垃圾回收算法"></a>垃圾回收算法</h2><p>找到需要回收的对象后，即可进行回收。JVM 中的 GC 是”自适应”的垃圾回收器，它会根据不同的环境和需要选择不同的处理方式。</p>
<h3 id="标记-清除算法"><a href="#标记-清除算法" class="headerlink" title="标记-清除算法"></a>标记-清除算法</h3><p>通过可达性分析算法找到可以回收的对象后，对这些对象进行标记，代表它可以被回收。标记完成之后就统一回收所有被标记的对象。但是这种方式会产生大量的内存碎片，导致可用内存不规整，于是分配新的内存时就需要采用空闲列表的方法。如果没有找到足够大的空间，那么就要提前触发下一次垃圾收集。</p>
<h3 id="标记-整理算法"><a href="#标记-整理算法" class="headerlink" title="标记-整理算法"></a>标记-整理算法</h3><p>标记的过程和标记-清除算法一样，但是标记完成之后，让所有存活的对象都向堆内存的一端移动，最后直接清除掉边界以外的内存。这样对内存进行回收之后，内存是规整的，于是可以使用指针碰撞的方式分配新的内存。</p>
<h3 id="复制算法"><a href="#复制算法" class="headerlink" title="复制算法"></a>复制算法</h3><p>标记-清除算法和标记-整理算法都使用先标记的方式，但当对象数量很多时，这种算法的效率并不高。</p>
<p>复制算法将可用内存分成两个部分，每次只使用其中的一部分，当其中一块用完时，就将仍然存活的对象复制到另外一块上，再把原来的那一块内存清理掉。这样回收的结果同样能得到规整的剩余空间，但是会浪费一部分内存。</p>
<p>可将新生代划分为三个部分，分别为Eden、Survivor from、Survivor to，大小比例为8：1：1。每次只使用 Eden 和其中的一块 Survivor，回收时将存活的对象复制到另一块 Survivor 中，这样就只有10%的内存被浪费，但是如果存活的对象总大小超过了 Survivor 的大小，那么就把多出的对象放入老年代中。</p>
<h3 id="分代收集算法（结合以上三种算法）"><a href="#分代收集算法（结合以上三种算法）" class="headerlink" title="分代收集算法（结合以上三种算法）"></a>分代收集算法（结合以上三种算法）</h3><p>把 Java堆分成新生代和老年代，新生代使用复制算法，老年代使用标记-清理或标记-整理算法。这样可以根据各个代自己的特点，选用合适的收集算法，提高内存收集的效率。在新生代中长期存活的对象会逐渐向老年代过渡，新生代中的对象每经历一次 GC，年龄就增加一岁，当年龄超过一定值时，就会被移动到旧生代。</p>
<h2 id="heap-的组成"><a href="#heap-的组成" class="headerlink" title="heap 的组成"></a>heap 的组成</h2><p>由于 GC 需要消耗一些资源和时间的，Java 在对对象的生命周期特征进行分析后，采用了分代的方式来进行对象的收集，即按照新生代、旧生代的方式来对对象进行收集，以尽可能的缩短 GC 对应用造成的暂停。</p>
<p>heap 的组成有三区域/世代：(可以理解随着时间，对象实例不断变换 heap 中的等级)</p>
<ul>
<li>新生代（Young Generation）<ul>
<li>Eden Space：任何新进入运行时数据区域的实例都会存放在此</li>
<li>S0 Suvivor Space：存在时间较长，经过垃圾回收没有被清除的实例，就从Eden 搬到了S0</li>
<li>S1 Survivor Space：存在时间更长的实例，就从S0 搬到了S1</li>
</ul>
</li>
<li>旧生代（Old Generation/tenured）：存在时间更长的对象，多次 GC 没被清除，就从 S1 搬到了 tenured</li>
<li>持久代：存放运行时数据区的方法区</li>
</ul>
<p><img src="https://segmentfault.com/img/bVkZav" alt="分区"></p>
<p>Java 对新生代和旧生代使用不同的 GC 算法。新生代做“复制收集”，旧生代做“标记压缩收集”。</p>
<blockquote>
<p>PS：搬运工作都由 GC 完成。GC 负责在 heap 中搬运实例，以及收回存储空间。</p>
</blockquote>
<h2 id="对象引用类型"><a href="#对象引用类型" class="headerlink" title="*对象引用类型"></a>*对象引用类型</h2><p>JVM 中将对象的引用分为了四种类型，不同的对象引用类型会造成 GC 采用不同的方法进行回收： </p>
<ol>
<li>强引用：默认情况下，对象采用的均为强引用。（GC 不会回收）</li>
<li>软引用：软引用是 Java 中提供的一种比较适合于缓存场景的应用。（只有在内存不够用的情况下才会被GC）</li>
<li>弱引用：在GC时一定会被GC回收 </li>
<li>虚引用：在GC时一定会被GC回</li>
</ol>
<hr>
<ul>
<li><p><a href="/more/donate/index.html"><strong><em><font color="red">我觉得帮助到我了, 支持你一下.</font></em></strong></a><br>   </p>
</li>
<li><p><a href="https://www.paypal.me/momodainfo" target="_blank" rel="noopener"><strong><em><font color="red">If you think the article is helpful to you, you can reward me through paypal.</font></em></strong></a></p>
</li>
</ul>
<h3 id="Ads"><a href="#Ads" class="headerlink" title="Ads"></a>Ads</h3><p><em>这是小广告! 如果有需要, 不妨支持一下吧~</em></p>
<blockquote>
<p> <a target="_blank" href="https://amazon.cn/gp/search?ie=UTF8&tag=momoda-23&linkCode=ur2&linkId=4a0e4fbec0cfa8dfe540ca999d0bf999&camp=536&creative=3200&index=books&keywords=编程">这些好书您看了吗?</a><img src="//ir-cn.amazon-adsystem.com/e/ir?t=momoda-23&l=ur2&o=28" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p>
</blockquote>
<blockquote>
<p>体育&amp;户外用品推荐</p>
</blockquote>
<p><div align="center"> <a href="https://www.amazon.cn/B07HWB88Z5/dp/B07HWB88Z5/ref=as_sl_pc_tf_til?tag=momoda-23&linkCode=w00&linkId=14df5124f2165d9eb3d65252e60ed2cf&creativeASIN=B07HWB88Z5" target="_blank" rel="noopener"><img src="/se-notes/Java基础/JVM基础/../../../more/ads/amazon.gif" width="100%"></a> </div>收</p>

      
    </div><!-- .entry-content -->

    <footer class="entry-meta">
    <a href="/se-notes/Java基础/JVM基础/">
    <time datetime="2019-01-03T13:49:30.000Z" class="entry-date">
        1月 3 2019
    </time>
</a>
    
  <span class="article-delim">&#8226;</span>
  <div class="article-category">
  <a class="article-category-link" href="/categories/编程语言/">编程语言</a>, <a class="article-category-link" href="/categories/编程语言/java/">java</a>
  </div>

    
  <span class="article-delim">&#8226;</span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java基础/">java基础</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java语法/">java语法</a></li></ul>

    </footer>
</article>






  
  
    <nav id="pagination">
      <nav id="page-nav">
        <a class="extend prev" rel="prev" href="/archives/2019/01/">&laquo; 上一页</a><a class="page-number" href="/archives/2019/01/">1</a><span class="page-number current">2</span><a class="page-number" href="/archives/2019/01/page/3/">3</a><a class="page-number" href="/archives/2019/01/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/archives/2019/01/page/6/">6</a><a class="extend next" rel="next" href="/archives/2019/01/page/3/">下一页 &raquo;</a>
      </nav>
    </nav>
  

</div></div>
        <div id="secondary" class="widget-area" role="complementary">
  
    <aside id="search" class="widget widget_search"><form role="search" method="get" accept-charset="utf-8" id="searchform" class="searchform" action="//google.com/search">
    <div>
        <input type="text" value="" name="q">
        <input type="submit" id="searchsubmit" value="google搜索">
    </div>
</form></aside>

  
    
  <aside class="widget">
    <h3 class="widget-title">Recents</h3>
    <div class="widget-content">
      <ul>
        
          <li>
            <a href="/系统剩余空间查看/">系统剩余空间查看</a>
          </li>
        
          <li>
            <a href="/数据库分类/">数据库分类</a>
          </li>
        
          <li>
            <a href="/se-notes/Java基础/集合框架/">集合框架</a>
          </li>
        
          <li>
            <a href="/se-notes/云计算实践/集群高可用方案/Heartbeat双机热备方案/">Heartbeat双机热备方案</a>
          </li>
        
          <li>
            <a href="/se-notes/云计算实践/集群高可用方案/HAProxy+Keepalived高可用方案/">HAProxy+Keepalived高可用方案</a>
          </li>
        
      </ul>
    </div>
  </aside>

  
    
  <aside class="widget">
    <h3 class="widget-title">Archives</h3>
    <div class="widget-content">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">56</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">一月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/01/">一月 2014</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </aside>

  
    
  <aside class="widget">
    <h3 class="widget-title">Categories</h3>
    <div class="widget-content">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Graphics/">Graphics</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">7</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/Shell/">Shell</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/linux基础/">linux基础</a><span class="category-list-count">6</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/协议证书/">协议证书</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/协议证书/openssl/">openssl</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/数据库基础/">数据库基础</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/框架/">框架</a><span class="category-list-count">9</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/框架/python-web应用框架/">python-web应用框架</a><span class="category-list-count">9</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/框架/python-web应用框架/flask/">flask</a><span class="category-list-count">9</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/版本控制/">版本控制</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/版本控制/Git/">Git</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程语言/">编程语言</a><span class="category-list-count">13</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/编程语言/java/">java</a><span class="category-list-count">13</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络通讯/">网络通讯</a><span class="category-list-count">11</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/网络通讯/大小端/">大小端</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络通讯/计算机网络基础/">计算机网络基础</a><span class="category-list-count">10</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/路由器/">路由器</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/路由器/openwrt/">openwrt</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/通用技术/">通用技术</a><span class="category-list-count">13</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/通用技术/Docker/">Docker</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/通用技术/云计算实践/">云计算实践</a><span class="category-list-count">11</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/通用技术/云计算实践/kubernetes部署/">kubernetes部署</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/通用技术/云计算实践/区块链/">区块链</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/通用技术/云计算实践/集群高可用方案/">集群高可用方案</a><span class="category-list-count">4</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/默认/">默认</a><span class="category-list-count">1</span></li></ul>
    </div>
  </aside>

  
    
  <aside class="widget">
    <h3 class="widget-title">Tags</h3>
    <div class="widget-content">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CS-Notes/">CS-Notes</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PEM证书/">PEM证书</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/">Shell</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cron/">cron</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/database/">database</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/diagrams/">diagrams</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker-qq/">docker-qq</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flask/">flask</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/graphics/">graphics</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/http/">http</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/informationisbeautiful/">informationisbeautiful</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java基础/">java基础</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java语法/">java语法</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernetes/">kubernetes</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network/">network</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openssl/">openssl</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openwrt/">openwrt</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/p12/">p12</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pfx/">pfx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tcp-ip/">tcp/ip</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web开发/">web开发</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/云计算/">云计算</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/区块链/">区块链</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/大小端/">大小端</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库/">数据库</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/系统管理/">系统管理</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/计算机网络/">计算机网络</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/集群/">集群</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/默认/">默认</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </aside>

  
    
  <aside class="widget">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget-content tagcloud">
      <a href="/tags/CS-Notes/" style="font-size: 10px;">CS-Notes</a> <a href="/tags/PEM证书/" style="font-size: 10px;">PEM证书</a> <a href="/tags/Shell/" style="font-size: 10px;">Shell</a> <a href="/tags/cron/" style="font-size: 10px;">cron</a> <a href="/tags/database/" style="font-size: 10px;">database</a> <a href="/tags/diagrams/" style="font-size: 10px;">diagrams</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-qq/" style="font-size: 10px;">docker-qq</a> <a href="/tags/flask/" style="font-size: 16.25px;">flask</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/graphics/" style="font-size: 10px;">graphics</a> <a href="/tags/http/" style="font-size: 17.5px;">http</a> <a href="/tags/informationisbeautiful/" style="font-size: 10px;">informationisbeautiful</a> <a href="/tags/java基础/" style="font-size: 20px;">java基础</a> <a href="/tags/java语法/" style="font-size: 20px;">java语法</a> <a href="/tags/kubernetes/" style="font-size: 13.75px;">kubernetes</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/mysql/" style="font-size: 11.25px;">mysql</a> <a href="/tags/network/" style="font-size: 17.5px;">network</a> <a href="/tags/openssl/" style="font-size: 10px;">openssl</a> <a href="/tags/openwrt/" style="font-size: 10px;">openwrt</a> <a href="/tags/p12/" style="font-size: 10px;">p12</a> <a href="/tags/pfx/" style="font-size: 10px;">pfx</a> <a href="/tags/tcp-ip/" style="font-size: 17.5px;">tcp/ip</a> <a href="/tags/web开发/" style="font-size: 16.25px;">web开发</a> <a href="/tags/云计算/" style="font-size: 18.75px;">云计算</a> <a href="/tags/区块链/" style="font-size: 10px;">区块链</a> <a href="/tags/大小端/" style="font-size: 10px;">大小端</a> <a href="/tags/数据库/" style="font-size: 12.5px;">数据库</a> <a href="/tags/系统管理/" style="font-size: 15px;">系统管理</a> <a href="/tags/计算机网络/" style="font-size: 17.5px;">计算机网络</a> <a href="/tags/集群/" style="font-size: 13.75px;">集群</a> <a href="/tags/默认/" style="font-size: 10px;">默认</a>
    </div>
  </aside>

  
    <aside class="widget">
    <h3 class="widget-title">Links</h3>
    <div class="widget-content">
		<ul id="link-list">
		<!-- link begin -->

		<li><a href="https://www.google.com/">google</a></li>
		<li><a href="https://www.baidu.com/">baidu</a></li>
		
		<!-- link end -->
		</ul>
    </div>
</aside>

  
    <aside class="widget">
    <h3 class="widget-title">Ads</h3>
    <div class="widget-content">
	 
			* <a target="_blank" href="https://amazon.cn/gp/search?ie=UTF8&tag=momoda-23&linkCode=ur2&linkId=4a0e4fbec0cfa8dfe540ca999d0bf999&camp=536&creative=3200&index=books&keywords=编程">这些好书您看了吗?</a><img src="//ir-cn.amazon-adsystem.com/e/ir?t=momoda-23&l=ur2&o=28" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;">
			<br><br>
			* 体育&户外用品推荐>
			<div align="center"> <a href="https://www.amazon.cn/B07HWB88Z5/dp/B07HWB88Z5/ref=as_sl_pc_tf_til?tag=momoda-23&linkCode=w00&linkId=14df5124f2165d9eb3d65252e60ed2cf&creativeASIN=B07HWB88Z5"><img src="/more/ads/amazon.gif" width="100%"></a> </div>

    </div>
</aside>

  
</div>
      </div>
      <footer id="colophon" role="contentinfo">
    <p>&copy; 2019 momoda
    All rights reserved.</p>
    <p>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></p>
    <a href="javascript:scrollTo(0,0);">返回顶部</a>
</footer>

    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"1","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"16"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>

<script src="/js/jquery-2.0.3.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

<script src="/js/navigation.js"></script>


<script type="text/javascript" src="https://js.users.51.la/19862371.js"></script>
<div id="bg"></div>

  </div>
</body>
</html>